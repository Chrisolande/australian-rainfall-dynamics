<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A comprehensive statistical analysis of rainfall patterns across 49 Australian cities using Zero-Inflated Gamma GLMMs.">

<title>2&nbsp; Data Preparation â€“ Australian Rainfall Dynamics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-eda.html" rel="next">
<link href="./01-intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-9eae319670a971b7aedd265dafd44b4f.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-e66b50aa4120364bfa72329fe8653b98.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-9eae319670a971b7aedd265dafd44b4f.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-1f8a39822a5a1e3eccd3264549681dcc.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-463e05341c278a50bd9d8b9e5c352418.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-1f8a39822a5a1e3eccd3264549681dcc.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-data-prep.html">Data</a></li><li class="breadcrumb-item"><a href="./02-data-prep.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Preparation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Australian Rainfall Dynamics</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chrisolande/Statistical-Inference-Zero-Inflated-Models" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predicting Australian Rainfall</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data-prep.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Preparation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Feature Engineering</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-features.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Feature Engineering</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Modelling</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Modelling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Model Evaluation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-model-selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Model Selection</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#computational-environment" id="toc-computational-environment" class="nav-link active" data-scroll-target="#computational-environment"><span class="header-section-number">2.1</span> Computational Environment</a></li>
  <li><a href="#initial-cleaning-and-standardisation" id="toc-initial-cleaning-and-standardisation" class="nav-link" data-scroll-target="#initial-cleaning-and-standardisation"><span class="header-section-number">2.2</span> Initial Cleaning and Standardisation</a></li>
  <li><a href="#sec-missingness-diagnostics" id="toc-sec-missingness-diagnostics" class="nav-link" data-scroll-target="#sec-missingness-diagnostics"><span class="header-section-number">2.3</span> Missingness Diagnostics</a>
  <ul class="collapse">
  <li><a href="#sec-co-missingness" id="toc-sec-co-missingness" class="nav-link" data-scroll-target="#sec-co-missingness"><span class="header-section-number">2.3.1</span> Co-missingness Structure</a></li>
  <li><a href="#sec-temporal-structure" id="toc-sec-temporal-structure" class="nav-link" data-scroll-target="#sec-temporal-structure"><span class="header-section-number">2.3.2</span> Temporal Structure and Structural Breaks</a></li>
  <li><a href="#sec-ghost-sensor" id="toc-sec-ghost-sensor" class="nav-link" data-scroll-target="#sec-ghost-sensor"><span class="header-section-number">2.3.3</span> Geographic Concentration: Ghost Sensor Identification</a></li>
  <li><a href="#sec-weather-conditionality" id="toc-sec-weather-conditionality" class="nav-link" data-scroll-target="#sec-weather-conditionality"><span class="header-section-number">2.3.4</span> Weather-Conditionality of Sunshine Missingness</a></li>
  <li><a href="#missing-pattern-structure" id="toc-missing-pattern-structure" class="nav-link" data-scroll-target="#missing-pattern-structure"><span class="header-section-number">2.3.5</span> Missing Pattern Structure</a></li>
  </ul></li>
  <li><a href="#imputation-pipeline" id="toc-imputation-pipeline" class="nav-link" data-scroll-target="#imputation-pipeline"><span class="header-section-number">2.4</span> Imputation Pipeline</a>
  <ul class="collapse">
  <li><a href="#stage-1-temporal-interpolation" id="toc-stage-1-temporal-interpolation" class="nav-link" data-scroll-target="#stage-1-temporal-interpolation"><span class="header-section-number">2.4.1</span> Stage 1: Temporal Interpolation</a></li>
  <li><a href="#stage-2-multivariate-random-forest-imputation" id="toc-stage-2-multivariate-random-forest-imputation" class="nav-link" data-scroll-target="#stage-2-multivariate-random-forest-imputation"><span class="header-section-number">2.4.2</span> Stage 2: Multivariate Random Forest Imputation</a></li>
  <li><a href="#ghost-sensor-flagging" id="toc-ghost-sensor-flagging" class="nav-link" data-scroll-target="#ghost-sensor-flagging"><span class="header-section-number">2.4.3</span> Ghost Sensor Flagging</a></li>
  </ul></li>
  <li><a href="#post-imputation-dataset-properties" id="toc-post-imputation-dataset-properties" class="nav-link" data-scroll-target="#post-imputation-dataset-properties"><span class="header-section-number">2.5</span> Post-Imputation Dataset Properties</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/chrisolande/Statistical-Inference-Zero-Inflated-Models/blob/main/02-data-prep.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/chrisolande/Statistical-Inference-Zero-Inflated-Models/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-data-prep.html">Data</a></li><li class="breadcrumb-item"><a href="./02-data-prep.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Preparation</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-data" class="quarto-section-identifier"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Preparation</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<hr>
<blockquote class="blockquote">
<p><strong>Chapter Context.</strong> Before any statistical analysis can proceed, the raw dataset must be transformed into a form that is both analytically tractable and physically credible. This chapter documents three decisions that have downstream consequences throughout the report: the syntactic and temporal standardisation of the raw data, a diagnostic investigation of the structure and mechanism of the missingness, and the design of a two-stage imputation pipeline informed by that investigation. Each decision is motivated by the properties of the data-generating process rather than by computational convenience.</p>
</blockquote>
<hr>
<section id="computational-environment" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="computational-environment"><span class="header-section-number">2.1</span> Computational Environment</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb1-2"><a href="#cb1-2"></a>  tidyverse,</span>
<span id="cb1-3"><a href="#cb1-3"></a>  tidymodels,</span>
<span id="cb1-4"><a href="#cb1-4"></a>  kableExtra,</span>
<span id="cb1-5"><a href="#cb1-5"></a>  patchwork,</span>
<span id="cb1-6"><a href="#cb1-6"></a>  skimr,</span>
<span id="cb1-7"><a href="#cb1-7"></a>  gridExtra,</span>
<span id="cb1-8"><a href="#cb1-8"></a>  gtsummary,</span>
<span id="cb1-9"><a href="#cb1-9"></a>  janitor,</span>
<span id="cb1-10"><a href="#cb1-10"></a>  corrplot,</span>
<span id="cb1-11"><a href="#cb1-11"></a>  sjPlot,</span>
<span id="cb1-12"><a href="#cb1-12"></a>  scales,</span>
<span id="cb1-13"><a href="#cb1-13"></a>  GGally,</span>
<span id="cb1-14"><a href="#cb1-14"></a>  car,</span>
<span id="cb1-15"><a href="#cb1-15"></a>  forcats,</span>
<span id="cb1-16"><a href="#cb1-16"></a>  performance,</span>
<span id="cb1-17"><a href="#cb1-17"></a>  glmmTMB,</span>
<span id="cb1-18"><a href="#cb1-18"></a>  splines,</span>
<span id="cb1-19"><a href="#cb1-19"></a>  mgcv,</span>
<span id="cb1-20"><a href="#cb1-20"></a>  DHARMa,</span>
<span id="cb1-21"><a href="#cb1-21"></a>  zoo,</span>
<span id="cb1-22"><a href="#cb1-22"></a>  ggpubr,</span>
<span id="cb1-23"><a href="#cb1-23"></a>  ggridges,</span>
<span id="cb1-24"><a href="#cb1-24"></a>  caret,</span>
<span id="cb1-25"><a href="#cb1-25"></a>  rstatix,</span>
<span id="cb1-26"><a href="#cb1-26"></a>  Metrics,</span>
<span id="cb1-27"><a href="#cb1-27"></a>  mice,</span>
<span id="cb1-28"><a href="#cb1-28"></a>  missRanger,</span>
<span id="cb1-29"><a href="#cb1-29"></a>  ranger,</span>
<span id="cb1-30"><a href="#cb1-30"></a>  cocor,</span>
<span id="cb1-31"><a href="#cb1-31"></a>  multcompView,</span>
<span id="cb1-32"><a href="#cb1-32"></a>  lmtest,</span>
<span id="cb1-33"><a href="#cb1-33"></a>  aod,</span>
<span id="cb1-34"><a href="#cb1-34"></a>  pROC,</span>
<span id="cb1-35"><a href="#cb1-35"></a>  naniar,</span>
<span id="cb1-36"><a href="#cb1-36"></a>  glue,</span>
<span id="cb1-37"><a href="#cb1-37"></a>  viridis</span>
<span id="cb1-38"><a href="#cb1-38"></a>)</span>
<span id="cb1-39"><a href="#cb1-39"></a></span>
<span id="cb1-40"><a href="#cb1-40"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/weatherAUS.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-41"><a href="#cb1-41"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb1-42"><a href="#cb1-42"></a></span>
<span id="cb1-43"><a href="#cb1-43"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"utils.R"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The package selection reflects the specific demands of meteorological data analysis. The core wrangling and visualisation toolkit (<code>tidyverse</code>, <code>janitor</code>, <code>kableExtra</code>) handles routine data manipulation. The modelling stack (<code>glmmTMB</code>, <code>DHARMa</code>, <code>splines</code>, <code>mgcv</code>) is assembled for the zero-inflated mixed-effects framework documented in later chapters. The imputation stack (<code>missRanger</code>, <code>mice</code>, <code>ranger</code>) supports the Random Forest and chained imputation procedures described below. The missingness diagnostic stack (<code>naniar</code>, <code>glue</code>) supports the structural analysis in Section 2.3 (<a href="#sec-missingness-diagnostics" class="quarto-xref"><span>Section 2.3</span></a>). Libraries are loaded via <code>librarian</code>, which installs missing packages automatically and ensures reproducibility across environments.</p>
<hr>
</section>
<section id="initial-cleaning-and-standardisation" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="initial-cleaning-and-standardisation"><span class="header-section-number">2.2</span> Initial Cleaning and Standardisation</h2>
<p>The raw dataset undergoes three transformations before any missingness analysis or imputation.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>df_clean <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date),</span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="at">month =</span> <span class="fu">as.factor</span>(<span class="fu">month</span>(date)),</span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="at">day =</span> <span class="fu">as.factor</span>(<span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-6"><a href="#cb2-6"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rainfall))</span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a>df_clean <span class="sc">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Head of Cleaned Dataset"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Head of Cleaned Dataset</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">location</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">min_temp</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">max_temp</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rainfall</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">evaporation</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sunshine</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wind_gust_dir</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">wind_gust_speed</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wind_dir9am</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wind_dir3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">wind_speed9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">wind_speed3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">humidity9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">humidity3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pressure9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pressure3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cloud9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cloud3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">temp9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">temp3pm</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">rain_today</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">rain_tomorrow</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">month</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">day</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2008-12-01</td>
<td style="text-align: left;">Albury</td>
<td style="text-align: right;">13.4</td>
<td style="text-align: right;">22.9</td>
<td style="text-align: right;">0.6</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">W</td>
<td style="text-align: right;">44</td>
<td style="text-align: left;">W</td>
<td style="text-align: left;">WNW</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">1007.7</td>
<td style="text-align: right;">1007.1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">16.9</td>
<td style="text-align: right;">21.8</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">Mon</td>
</tr>
<tr class="even">
<td style="text-align: left;">2008-12-02</td>
<td style="text-align: left;">Albury</td>
<td style="text-align: right;">7.4</td>
<td style="text-align: right;">25.1</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">WNW</td>
<td style="text-align: right;">44</td>
<td style="text-align: left;">NNW</td>
<td style="text-align: left;">WSW</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">1010.6</td>
<td style="text-align: right;">1007.8</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">17.2</td>
<td style="text-align: right;">24.3</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">Tue</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2008-12-03</td>
<td style="text-align: left;">Albury</td>
<td style="text-align: right;">12.9</td>
<td style="text-align: right;">25.7</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">WSW</td>
<td style="text-align: right;">46</td>
<td style="text-align: left;">W</td>
<td style="text-align: left;">WSW</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">1007.6</td>
<td style="text-align: right;">1008.7</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">21.0</td>
<td style="text-align: right;">23.2</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">Wed</td>
</tr>
<tr class="even">
<td style="text-align: left;">2008-12-04</td>
<td style="text-align: left;">Albury</td>
<td style="text-align: right;">9.2</td>
<td style="text-align: right;">28.0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NE</td>
<td style="text-align: right;">24</td>
<td style="text-align: left;">SE</td>
<td style="text-align: left;">E</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">1017.6</td>
<td style="text-align: right;">1012.8</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">18.1</td>
<td style="text-align: right;">26.5</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">Thu</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2008-12-05</td>
<td style="text-align: left;">Albury</td>
<td style="text-align: right;">17.5</td>
<td style="text-align: right;">32.3</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">W</td>
<td style="text-align: right;">41</td>
<td style="text-align: left;">ENE</td>
<td style="text-align: left;">NW</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">1010.8</td>
<td style="text-align: right;">1006.0</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">17.8</td>
<td style="text-align: right;">29.7</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">Fri</td>
</tr>
<tr class="even">
<td style="text-align: left;">2008-12-06</td>
<td style="text-align: left;">Albury</td>
<td style="text-align: right;">14.6</td>
<td style="text-align: right;">29.7</td>
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">WNW</td>
<td style="text-align: right;">56</td>
<td style="text-align: left;">W</td>
<td style="text-align: left;">W</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1009.2</td>
<td style="text-align: right;">1005.4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">20.6</td>
<td style="text-align: right;">28.9</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">Sat</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>df_clean <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">tail</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Tail of Cleaned Dataset"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Tail of Cleaned Dataset</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">location</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">min_temp</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">max_temp</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rainfall</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">evaporation</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sunshine</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wind_gust_dir</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">wind_gust_speed</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wind_dir9am</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wind_dir3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">wind_speed9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">wind_speed3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">humidity9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">humidity3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pressure9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pressure3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cloud9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cloud3pm</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">temp9am</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">temp3pm</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">rain_today</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">rain_tomorrow</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">month</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">day</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-06-20</td>
<td style="text-align: left;">Uluru</td>
<td style="text-align: right;">3.5</td>
<td style="text-align: right;">21.8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">E</td>
<td style="text-align: right;">31</td>
<td style="text-align: left;">ESE</td>
<td style="text-align: left;">E</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">59</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">1024.7</td>
<td style="text-align: right;">1021.2</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">9.4</td>
<td style="text-align: right;">20.9</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">Tue</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-06-21</td>
<td style="text-align: left;">Uluru</td>
<td style="text-align: right;">2.8</td>
<td style="text-align: right;">23.4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">E</td>
<td style="text-align: right;">31</td>
<td style="text-align: left;">SE</td>
<td style="text-align: left;">ENE</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">1024.6</td>
<td style="text-align: right;">1020.3</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">10.1</td>
<td style="text-align: right;">22.4</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">Wed</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-06-22</td>
<td style="text-align: left;">Uluru</td>
<td style="text-align: right;">3.6</td>
<td style="text-align: right;">25.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NNW</td>
<td style="text-align: right;">22</td>
<td style="text-align: left;">SE</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">56</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">1023.5</td>
<td style="text-align: right;">1019.1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">10.9</td>
<td style="text-align: right;">24.5</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">Thu</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-06-23</td>
<td style="text-align: left;">Uluru</td>
<td style="text-align: right;">5.4</td>
<td style="text-align: right;">26.9</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">37</td>
<td style="text-align: left;">SE</td>
<td style="text-align: left;">WNW</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">1021.0</td>
<td style="text-align: right;">1016.8</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">12.5</td>
<td style="text-align: right;">26.1</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">Fri</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-06-24</td>
<td style="text-align: left;">Uluru</td>
<td style="text-align: right;">7.8</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">SE</td>
<td style="text-align: right;">28</td>
<td style="text-align: left;">SSE</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">1019.4</td>
<td style="text-align: right;">1016.5</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">15.1</td>
<td style="text-align: right;">26.0</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">Sat</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-06-25</td>
<td style="text-align: left;">Uluru</td>
<td style="text-align: right;">14.9</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">ESE</td>
<td style="text-align: left;">ESE</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">1020.2</td>
<td style="text-align: right;">1017.9</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">15.0</td>
<td style="text-align: right;">20.9</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">Sun</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong>Column standardisation.</strong> All variable names are converted to <code>snake_case</code> via <code>janitor::clean_names()</code>, called at ingestion. This eliminates downstream ambiguity in variable references and ensures internal consistency across all chapters.</p>
<p><strong>Temporal feature extraction.</strong> The <code>date</code> column is typed as a <code>Date</code> object and two derived features are extracted: <code>month</code> (as a factor) and <code>day</code> (day of week, labelled). Month captures the seasonal structure of Australian precipitation; day of week is retained as a potential control variable for reporting artefacts in the raw data.</p>
<p><strong>Target filtering.</strong> Observations where <code>rainfall</code> is missing are removed. Records without a ground-truth rainfall measurement have no supervised learning value and cannot contribute to either the hurdle or the intensity component of the ZIG model.</p>
<hr>
</section>
<section id="sec-missingness-diagnostics" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="sec-missingness-diagnostics"><span class="header-section-number">2.3</span> Missingness Diagnostics</h2>
<p>Before designing an imputation strategy, it is necessary to understand the mechanism and structure of the missing data. The choice between imputation methods depends critically on three questions: whether missingness is random with respect to other variables in the dataset, whether missing values cluster at specific locations or time periods, and whether the four most-affected variables fail independently or as a coordinated group. A strategy designed without answering these questions risks either under-imputing (discarding recoverable signal) or over-imputing (fabricating data in regions where recovery is not possible). The five analyses below provide the empirical basis for each design decision in the pipeline that follows.</p>
<section id="sec-co-missingness" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="sec-co-missingness"><span class="header-section-number">2.3.1</span> Co-missingness Structure</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>high_miss_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sunshine"</span>, <span class="st">"evaporation"</span>, <span class="st">"cloud3pm"</span>, <span class="st">"cloud9am"</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a>high_miss <span class="ot">&lt;-</span> high_miss_cols[high_miss_cols <span class="sc">%in%</span> <span class="fu">names</span>(df)]</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">cat</span>(<span class="st">"High missingness variables:"</span>, <span class="fu">paste</span>(high_miss, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; High missingness variables: sunshine, evaporation, cloud3pm, cloud9am</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>miss_mat <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), is.na)) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="fu">apply</span>(<span class="dv">2</span>, as.integer)</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>intersection_matrix <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(miss_mat)</span>
<span id="cb6-8"><a href="#cb6-8"></a>total_miss_counts <span class="ot">&lt;-</span> <span class="fu">diag</span>(intersection_matrix)</span>
<span id="cb6-9"><a href="#cb6-9"></a></span>
<span id="cb6-10"><a href="#cb6-10"></a>pct_matrix <span class="ot">&lt;-</span> intersection_matrix <span class="sc">/</span> total_miss_counts <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>co_missing_stats <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">as.table</span>(pct_matrix)) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>  <span class="fu">rename</span>(<span class="at">var1 =</span> Var1, <span class="at">var2 =</span> Var2, <span class="at">pct_co_miss =</span> Freq) <span class="sc">%&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="fu">filter</span>(var1 <span class="sc">!=</span> var2) <span class="sc">%&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(pct_co_miss))</span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a>co_missing_stats <span class="sc">%&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="at">msg =</span> <span class="fu">glue</span>(</span>
<span id="cb6-20"><a href="#cb6-20"></a>      <span class="st">"  {var1} -&gt; {var2}: {round(pct_co_miss, 1)}%  (when {var1} is missing, {var2} is missing)"</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>    )</span>
<span id="cb6-22"><a href="#cb6-22"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="fu">pull</span>(msg) <span class="sc">%&gt;%</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="fu">walk</span>(cat, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   evaporation -&gt; sunshine: 93.2%  (when evaporation is missing, sunshine is missing) 
#&gt;   cloud9am -&gt; cloud3pm: 92.6%  (when cloud9am is missing, cloud3pm is missing) 
#&gt;   cloud3pm -&gt; cloud9am: 87.2%  (when cloud3pm is missing, cloud9am is missing) 
#&gt;   cloud9am -&gt; sunshine: 84.3%  (when cloud9am is missing, sunshine is missing) 
#&gt;   sunshine -&gt; evaporation: 83.8%  (when sunshine is missing, evaporation is missing) 
#&gt;   cloud3pm -&gt; sunshine: 82.5%  (when cloud3pm is missing, sunshine is missing) 
#&gt;   cloud9am -&gt; evaporation: 81.4%  (when cloud9am is missing, evaporation is missing) 
#&gt;   cloud3pm -&gt; evaporation: 78%  (when cloud3pm is missing, evaporation is missing) 
#&gt;   evaporation -&gt; cloud3pm: 73.7%  (when evaporation is missing, cloud3pm is missing) 
#&gt;   evaporation -&gt; cloud9am: 72.5%  (when evaporation is missing, cloud9am is missing) 
#&gt;   sunshine -&gt; cloud3pm: 70.1%  (when sunshine is missing, cloud3pm is missing) 
#&gt;   sunshine -&gt; cloud9am: 67.5%  (when sunshine is missing, cloud9am is missing)</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>co_missing_stats <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">kable</span>(</span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="at">caption =</span> <span class="st">"Conditional Co-missingness: when var1 is missing, what percentage of the time is var2 also missing?"</span>,</span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb8-5"><a href="#cb8-5"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Variable 1 (Missing)"</span>, <span class="st">"Variable 2"</span>, <span class="st">"Co-missing (%)"</span>)</span>
<span id="cb8-6"><a href="#cb8-6"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="tbl-co-missingness" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-co-missingness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.1: Conditional Co-missingness Matrix
</figcaption>
<div aria-describedby="tbl-co-missingness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="table table-striped table-hover do-not-create-environment cell caption-top table-sm small">
<caption>Conditional Co-missingness: when var1 is missing, what percentage of the time is var2 also missing?</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable 1 (Missing)</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable 2</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Co-missing (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">evaporation</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">93.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">cloud9am</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">92.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">87.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">cloud9am</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">84.3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sunshine</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">83.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">82.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cloud9am</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">81.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">78.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">evaporation</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">73.7</td>
</tr>
<tr class="even">
<td style="text-align: left;">evaporation</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">72.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sunshine</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">70.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">sunshine</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">67.5</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The co-missingness matrix (<a href="#tbl-co-missingness" class="quarto-xref">Table&nbsp;<span>2.1</span></a>) confirms that these four variables fail as a systematic cluster rather than independently. The dependencies are strongest between instrumental pairs: if evaporation is missing, there is a 93.2% probability that sunshine is also missing. Even the weakest relationship in the matrix (sunshine to cloud9am) retains a rate of 67.5%, which is nearly double what would be expected under random failure.</p>
<p>Under MCAR, the co-missing rates would be close to the marginal missingness rates of each variable, roughly 40 to 48%. Rates uniformly between 67% and 93% instead indicate a shared upstream cause: the instrumentation profile of each station. Sunshine recorders, evaporation pans, and cloud coverage sensors are deployed as a package, not individually. A station without one is very likely to lack the others. This is MNAR at the station level. The practical consequence for imputation is that treating the four variables as independently missing would be incorrect: their correlations when observed are available precisely because they fail together, and a multivariate imputation method that exploits those cross-variable relationships will outperform four separate univariate models.</p>
</section>
<section id="sec-temporal-structure" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="sec-temporal-structure"><span class="header-section-number">2.3.2</span> Temporal Structure and Structural Breaks</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>temporal_trend <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">mutate</span>(<span class="at">month_floor =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">select</span>(month_floor, <span class="fu">any_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="at">cols =</span> <span class="sc">-</span>month_floor,</span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="at">names_to =</span> <span class="st">"variable"</span>,</span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="fu">group_by</span>(month_floor, variable) <span class="sc">%&gt;%</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="fu">summarise</span>(<span class="at">pct_missing =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(value)) <span class="sc">*</span> <span class="dv">100</span>, <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb9-11"><a href="#cb9-11"></a></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="fu">ggplot</span>(</span>
<span id="cb9-13"><a href="#cb9-13"></a>  temporal_trend,</span>
<span id="cb9-14"><a href="#cb9-14"></a>  <span class="fu">aes</span>(<span class="at">x =</span> month_floor, <span class="at">y =</span> pct_missing, <span class="at">color =</span> variable)</span>
<span id="cb9-15"><a href="#cb9-15"></a>) <span class="sc">+</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-19"><a href="#cb9-19"></a>    <span class="at">title =</span> <span class="st">"Timeline of Systematic Missingness"</span>,</span>
<span id="cb9-20"><a href="#cb9-20"></a>    <span class="at">subtitle =</span> <span class="st">"Structural breaks appear as step changes rather than random fluctuations"</span>,</span>
<span id="cb9-21"><a href="#cb9-21"></a>    <span class="at">y =</span> <span class="st">"Missingness (%)"</span>,</span>
<span id="cb9-22"><a href="#cb9-22"></a>    <span class="at">x =</span> <span class="st">"Year"</span></span>
<span id="cb9-23"><a href="#cb9-23"></a>  ) <span class="sc">+</span></span>
<span id="cb9-24"><a href="#cb9-24"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb9-25"><a href="#cb9-25"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div id="fig-temporal-missingness" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-temporal-missingness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="02-data-prep_files/figure-html/fig-temporal-missingness-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-temporal-missingness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.1: Timeline of systematic missingness across the four high-missingness variables. The stepped increases visible particularly in sunshine and evaporation indicate structural breaks in data collection rather than random sensor failures.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The temporal analysis (<a href="#fig-temporal-missingness" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>) confirms that missingness is not randomly distributed over time. The cloud cover variables maintain a roughly stable and high missingness rate across the observation window, consistent with a fixed set of stations never having recorded these measurements. The <code>sunshine</code> and <code>evaporation</code> variables show a distinct stepped pattern: missingness rises at specific breakpoints rather than fluctuating randomly, indicating that certain stations were decommissioned or that recording protocols changed at identifiable calendar dates.</p>
<p>This temporal structure has a direct implication for the interpolation stage of the pipeline. Linear interpolation is appropriate when a smooth trajectory can be inferred from values on either side of a gap. Extended contiguous gaps produced by a structural break have no valid upper boundary from which to interpolate, and filling them with temporal interpolation would create long synthetic sequences with no empirical anchor. The five-day interpolation cap set in Stage 1 of the pipeline is a direct response to this finding.</p>
</section>
<section id="sec-ghost-sensor" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="sec-ghost-sensor"><span class="header-section-number">2.3.3</span> Geographic Concentration: Ghost Sensor Identification</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>GHOST_THRESHOLD <span class="ot">&lt;-</span> <span class="fl">0.90</span></span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>location_summary <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  naniar<span class="sc">::</span><span class="fu">miss_var_summary</span>()</span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7"><a href="#cb10-7"></a>ghost_sensors <span class="ot">&lt;-</span> location_summary <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> high_miss, pct_miss <span class="sc">&gt;</span> GHOST_THRESHOLD <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(pct_miss))</span>
<span id="cb10-10"><a href="#cb10-10"></a></span>
<span id="cb10-11"><a href="#cb10-11"></a>ghost_sensors <span class="sc">%&gt;%</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>  <span class="fu">kable</span>(</span>
<span id="cb10-13"><a href="#cb10-13"></a>    <span class="at">caption =</span> <span class="st">"Ghost Sensor Instances: Location-Variable Pairs with &gt;90% Missingness"</span>,</span>
<span id="cb10-14"><a href="#cb10-14"></a>    <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb10-15"><a href="#cb10-15"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Location"</span>, <span class="st">"Variable"</span>, <span class="st">"Missing (n)"</span>, <span class="st">"Missing (%)"</span>)</span>
<span id="cb10-16"><a href="#cb10-16"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Ghost Sensor Instances: Location-Variable Pairs with &gt;90% Missingness</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Location</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Missing (n)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Missing (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Albury</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Albury</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BadgerysCreek</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">BadgerysCreek</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BadgerysCreek</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">BadgerysCreek</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Newcastle</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Newcastle</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NorahHead</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3004</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">NorahHead</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3004</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NorahHead</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3004</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">NorahHead</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3004</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Penrith</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Penrith</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Penrith</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Penrith</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Richmond</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Wollongong</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wollongong</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tuggeranong</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tuggeranong</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tuggeranong</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tuggeranong</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3039</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">MountGinini</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MountGinini</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">MountGinini</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MountGinini</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ballarat</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ballarat</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bendigo</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Nhil</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">1578</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nhil</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">1578</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Nhil</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">1578</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nhil</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">1578</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dartmoor</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dartmoor</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GoldCoast</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">GoldCoast</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GoldCoast</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">GoldCoast</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Adelaide</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3193</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Adelaide</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3193</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Witchcliffe</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Witchcliffe</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Witchcliffe</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Witchcliffe</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PearceRAAF</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3009</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">SalmonGums</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3001</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SalmonGums</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3001</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">SalmonGums</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3001</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SalmonGums</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3001</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Walpole</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">3006</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Walpole</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3006</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Walpole</td>
<td style="text-align: left;">cloud9am</td>
<td style="text-align: right;">3006</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Walpole</td>
<td style="text-align: left;">cloud3pm</td>
<td style="text-align: right;">3006</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Launceston</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">3040</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Katherine</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">1578</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Uluru</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">1578</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Uluru</td>
<td style="text-align: left;">sunshine</td>
<td style="text-align: right;">1578</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Launceston</td>
<td style="text-align: left;">evaporation</td>
<td style="text-align: right;">2899</td>
<td style="text-align: right;">95.4</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(</span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="st">"</span><span class="sc">\n</span><span class="st">Total ghost sensor instances identified: %d across %d locations</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="fu">nrow</span>(ghost_sensors),</span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="fu">n_distinct</span>(ghost_sensors<span class="sc">$</span>location)</span>
<span id="cb11-5"><a href="#cb11-5"></a>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Total ghost sensor instances identified: 60 across 22 locations</code></pre>
</div>
</div>
<p>The location-level analysis identifies the specific station-variable pairs responsible for the bulk of the aggregate missingness. The top ten instances from the script output, all at exactly 100% missing, are as follows: Albury (<code>evaporation</code>, 3,040 observations; <code>sunshine</code>, 3,040), BadgerysCreek (<code>evaporation</code>, 3,009; <code>sunshine</code>, 3,009; <code>cloud9am</code>, 3,009; <code>cloud3pm</code>, 3,009), Newcastle (<code>evaporation</code>, 3,039; <code>sunshine</code>, 3,039), and NorahHead (<code>evaporation</code>, 3,004; <code>sunshine</code>, 3,004). At these stations, the instrument in question recorded a value on zero days across the entire observation window. These are not sensors experiencing intermittent failure; they are sensors that were never present or that were removed before the data collection period began.</p>
<p>The distinction between ghost sensors and ordinary missingness is consequential for imputation. For a gap of five to fifteen consecutive missing days, a Random Forest model can generate reasonable predictions by drawing on correlated variables at the same station and the same variable at nearby stations. For a gap spanning 3,000 or more consecutive observations, this extrapolation has no empirical support whatsoever: there is no observed value at that station and variable combination to anchor or validate the prediction. Values produced for these pairs would be statistically plausible by construction but would carry no physical information about what the instrument would have actually recorded. Ghost sensor pairs are identified before Stage 2 runs and flagged so that their imputed values can be treated with appropriate scepticism in downstream analysis.</p>
</section>
<section id="sec-weather-conditionality" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="sec-weather-conditionality"><span class="header-section-number">2.3.4</span> Weather-Conditionality of Sunshine Missingness</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"rainfall"</span>, <span class="st">"sunshine"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb13-2"><a href="#cb13-2"></a>  weather_missing_stats <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rainfall)) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>    <span class="fu">mutate</span>(<span class="at">is_rainy =</span> <span class="fu">if_else</span>(rainfall <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="st">"Rainy (&gt;1mm)"</span>, <span class="st">"Dry (&lt;=1mm)"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="fu">group_by</span>(is_rainy) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="fu">summarise</span>(</span>
<span id="cb13-7"><a href="#cb13-7"></a>      <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb13-8"><a href="#cb13-8"></a>      <span class="at">pct_sunshine_missing =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(sunshine)) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb13-9"><a href="#cb13-9"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    )</span>
<span id="cb13-11"><a href="#cb13-11"></a></span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="fu">print</span>(weather_missing_stats)</span>
<span id="cb13-13"><a href="#cb13-13"></a></span>
<span id="cb13-14"><a href="#cb13-14"></a>  weather_missing_stats <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>    <span class="fu">kable</span>(</span>
<span id="cb13-16"><a href="#cb13-16"></a>      <span class="at">caption =</span> <span class="st">"Sunshine Missingness Rate by Daily Rainfall Status"</span>,</span>
<span id="cb13-17"><a href="#cb13-17"></a>      <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb13-18"><a href="#cb13-18"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Day Type"</span>, <span class="st">"Observations (n)"</span>, <span class="st">"Sunshine Missing (%)"</span>)</span>
<span id="cb13-19"><a href="#cb13-19"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>    <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-21"><a href="#cb13-21"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 2 Ã— 3
#&gt;   is_rainy      n_obs pct_sunshine_missing
#&gt;   &lt;chr&gt;         &lt;int&gt;                &lt;dbl&gt;
#&gt; 1 Dry (&lt;=1mm)  110319                 47.8
#&gt; 2 Rainy (&gt;1mm)  31880                 47.2</code></pre>
</div>
<div id="tbl-sunshine-mcar-test" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sunshine-mcar-test-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2.2: Sunshine Missingness Rate by Daily Rainfall Status
</figcaption>
<div aria-describedby="tbl-sunshine-mcar-test-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="table table-striped table-hover do-not-create-environment cell caption-top table-sm small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Day Type</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Observations (n)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Sunshine Missing (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Dry (&lt;=1mm)</td>
<td style="text-align: right;">110319</td>
<td style="text-align: right;">47.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rainy (&gt;1mm)</td>
<td style="text-align: right;">31880</td>
<td style="text-align: right;">47.2</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  naniar<span class="sc">::</span><span class="fu">bind_shadow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">filter</span>(rainfall <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> rainfall <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rainfall, <span class="at">fill =</span> sunshine_NA)) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"!NA"</span> <span class="ot">=</span> <span class="st">"Present"</span>, <span class="st">"NA"</span> <span class="ot">=</span> <span class="st">"Missing"</span>)) <span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="fu">labs</span>(</span>
<span id="cb15-8"><a href="#cb15-8"></a>    <span class="at">title =</span> <span class="st">"Does Sunshine go Missing on Rainy Days?"</span>,</span>
<span id="cb15-9"><a href="#cb15-9"></a>    <span class="at">subtitle =</span> <span class="st">"Density of rainfall amounts for days with Missing vs. Present sunshine data"</span>,</span>
<span id="cb15-10"><a href="#cb15-10"></a>    <span class="at">x =</span> <span class="st">"Rainfall (mm)"</span>,</span>
<span id="cb15-11"><a href="#cb15-11"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb15-12"><a href="#cb15-12"></a>    <span class="at">fill =</span> <span class="st">"Sunshine Status"</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>  ) <span class="sc">+</span></span>
<span id="cb15-14"><a href="#cb15-14"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div id="fig-sunshine-rainfall-density" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sunshine-rainfall-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="02-data-prep_files/figure-html/fig-sunshine-rainfall-density-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sunshine-rainfall-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.2: Density of rainfall amounts on days where sunshine data is present versus missing. The near-identical distributions confirm that sunshine missingness is not weather-conditional: the same stations are missing sunshine on both dry and rainy days because the instrument was simply not installed, not because it failed during precipitation events.
</figcaption>
</figure>
</div>
</div>
</div>
<p>A specific concern when imputing a predictor variable is outcome-related missingness: if sunshine sensors failed more often on rainy days, then the imputed values would carry a directional signal about the target variable and could introduce bias into the training data.</p>
<p>The empirical test refutes this concern. The table output (<a href="#tbl-sunshine-mcar-test" class="quarto-xref">Table&nbsp;<span>2.2</span></a>) reports a sunshine missing rate of 47.8% on 110,319 dry days (rainfall at most 1 mm) and 47.2% on 31,880 rainy days (rainfall above 1 mm), a difference of 0.6 percentage points. The density plot (<a href="#fig-sunshine-rainfall-density" class="quarto-xref">Figure&nbsp;<span>2.2</span></a>) makes the same point visually: the distribution of rainfall amounts on days with missing sunshine and on days with present sunshine are indistinguishable across the full range from 0 to 50 mm. The slight visual offset in the figure reflects not a systematic pattern but the difference in the sizes of the two groups.</p>
<p>Sunshine missingness is station-conditional rather than weather-conditional. The same stations record missing sunshine on both dry and rainy days at nearly identical rates, because the instrument is absent from those stations entirely. This finding clears the imputation path: there is no outcome-related confound to correct for.</p>
</section>
<section id="missing-pattern-structure" class="level3" data-number="2.3.5">
<h3 data-number="2.3.5" class="anchored" data-anchor-id="missing-pattern-structure"><span class="header-section-number">2.3.5</span> Missing Pattern Structure</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">cat</span>(<span class="st">"Missing pattern combinations:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Missing pattern combinations:</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  naniar<span class="sc">::</span><span class="fu">miss_case_table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="fu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 5 Ã— 3
#&gt;   n_miss_in_case n_cases pct_cases
#&gt;            &lt;int&gt;   &lt;int&gt;     &lt;dbl&gt;
#&gt; 1              0   62566     43.0 
#&gt; 2              1   10525      7.24
#&gt; 3              2   20376     14.0 
#&gt; 4              3   11378      7.82
#&gt; 5              4   40615     27.9</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  naniar<span class="sc">::</span><span class="fu">miss_case_table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="fu">kable</span>(</span>
<span id="cb20-5"><a href="#cb20-5"></a>    <span class="at">caption =</span> <span class="st">"Distribution of Missing Variable Count per Observation"</span>,</span>
<span id="cb20-6"><a href="#cb20-6"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb20-7"><a href="#cb20-7"></a>      <span class="st">"Variables Missing (of 4)"</span>,</span>
<span id="cb20-8"><a href="#cb20-8"></a>      <span class="st">"Observations (n)"</span>,</span>
<span id="cb20-9"><a href="#cb20-9"></a>      <span class="st">"Percentage (%)"</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>    )</span>
<span id="cb20-11"><a href="#cb20-11"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-12"><a href="#cb20-12"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Distribution of Missing Variable Count per Observation</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">Variables Missing (of 4)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Observations (n)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Percentage (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">62566</td>
<td style="text-align: right;">43.012512</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">10525</td>
<td style="text-align: right;">7.235666</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">20376</td>
<td style="text-align: right;">14.007975</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">11378</td>
<td style="text-align: right;">7.822082</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">40615</td>
<td style="text-align: right;">27.921765</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The case-level output from the script reveals a strongly bimodal structure across five distinct patterns. Of all observations: 62,566 (43.0%) have none of the four variables missing; 10,525 (7.2%) have exactly one missing; 20,376 (14.0%) have exactly two missing; 11,378 (7.8%) have exactly three missing; and 40,615 (27.9%) have all four missing simultaneously. The two endpoint categories, zero missing and all four missing, together account for 70.9% of all observations.</p>
<p>The 27.9% with complete simultaneous missingness corresponds directly to the ghost sensor stations identified in <a href="#sec-ghost-sensor" class="quarto-xref"><span>Section 2.3.3</span></a>. For these observations, no imputation is supportable and the values remain missing after the pipeline. The 43.0% with no missingness require no intervention. The substantive imputation work is concentrated in the remaining 29.1% across the three intermediate patterns, where partial instrumentation means that correlated predictors are available to inform the Random Forest estimates. The bimodal structure also confirms that the co-missingness finding is not a statistical artifact: observations genuinely tend to be fully instrumented or minimally instrumented, not randomly partially instrumented.</p>
<hr>
</section>
</section>
<section id="imputation-pipeline" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="imputation-pipeline"><span class="header-section-number">2.4</span> Imputation Pipeline</h2>
<p>The diagnostic evidence from <a href="#sec-missingness-diagnostics" class="quarto-xref"><span>Section 2.3</span></a> motivates each design decision in the imputation pipeline. Missingness is station-level rather than weather-conditional (<a href="#sec-weather-conditionality" class="quarto-xref"><span>Section 2.3.4</span></a>), temporally structured with extended contiguous gaps rather than random scatter (<a href="#sec-temporal-structure" class="quarto-xref"><span>Section 2.3.2</span></a>), and co-located across variables at the station level (<a href="#sec-co-missingness" class="quarto-xref"><span>Section 2.3.1</span></a>). These properties rule out simple listwise deletion and mean imputation. They call for a pipeline that respects temporal continuity for smoothly-evolving variables, exploits cross-variable correlations for the structured variables, and declines to impute where the data is genuinely unrecoverable.</p>
<section id="stage-1-temporal-interpolation" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="stage-1-temporal-interpolation"><span class="header-section-number">2.4.1</span> Stage 1: Temporal Interpolation</h3>
<p>The eight variables with smooth day-to-day trajectories minimum and maximum temperature, morning and afternoon temperature, morning and afternoon pressure, and morning and afternoon humidity are imputed via linear interpolation grouped by location, bounded by a five-day maximum gap. The five-day cap is set directly in response to the temporal structural break finding: gaps of up to five days lie within a regime where the values at both boundaries sufficiently constrain the trajectory, while longer gaps are associated with structural collection failures that interpolation cannot safely bridge.</p>
</section>
<section id="stage-2-multivariate-random-forest-imputation" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="stage-2-multivariate-random-forest-imputation"><span class="header-section-number">2.4.2</span> Stage 2: Multivariate Random Forest Imputation</h3>
<p>Remaining gaps in <code>sunshine</code>, <code>evaporation</code>, cloud cover, and wind direction are addressed using <code>mice</code> with a Random Forest method. Each variable is imputed from a scientifically motivated predictor set:</p>
<ul>
<li><strong>Cloud cover</strong> (<code>cloud9am</code>, <code>cloud3pm</code>) from humidity and pressure.</li>
<li><strong>Sunshine</strong> from cloud cover, temperature, humidity, location, and month.</li>
<li><strong>Evaporation</strong> from wind gust speed, temperature, humidity, sunshine, location, and month.</li>
<li><strong>Wind direction</strong> (<code>wind_gust_dir</code>, <code>wind_dir9am</code>, <code>wind_dir3pm</code>) from the corresponding wind speed, pressure, location, and month.</li>
</ul>
<p>Wind direction is treated as a categorical variable imputed with Random Forest, which handles the multi-class, non-ordinal nature of compass-point directions without imposing a false numeric ordering. Each wind direction variable uses its temporally matched pressure and speed readings as predictors gust direction from gust speed and 3pm pressure, 9am direction from 9am speed and pressure, and 3pm direction from 3pm speed and pressure preserving the physical coupling between concurrent measurements.</p>
<p>The use of targeted predictor sets is directly motivated by the co-missingness finding. Because the four atmosphere variables tend to be absent together at the station level, their cross-variable correlations when observed are strong and reliable signals for imputation. Restricting each variableâ€™s predictor set to physically motivated covariates exploits this structure while reducing the risk of imputing on spurious correlations.</p>
</section>
<section id="ghost-sensor-flagging" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="ghost-sensor-flagging"><span class="header-section-number">2.4.3</span> Ghost Sensor Flagging</h3>
<p>Before Stage 2 runs, all station-variable pairs identified in <a href="#sec-ghost-sensor" class="quarto-xref"><span>Section 2.3.3</span></a> as ghost sensors (more than 90% missing across the full observation window) are catalogued and binary missingness flags are attached to the data (<code>sunshine_imp_flagged</code>, <code>evap_imp_flagged</code>, <code>cloud3pm_imp_flagged</code>, <code>cloud9am_imp_flagged</code>). These flags serve two purposes: they are excluded from the MICE predictor matrix so they cannot contaminate the imputation model, and they remain in the final dataset as explicit markers of which values are extrapolated with no empirical anchor. Flag columns are also excluded from the predictor matrix alongside the raw date column to prevent data leakage. A Random Forest model has no empirical support for predicting values at a station where an instrument was never present; the flags make this provenance transparent for any downstream analysis that needs to account for it.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>clean_and_impute_weather <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb21-2"><a href="#cb21-2"></a>  MAXGAP <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  GHOST_THRESHOLD <span class="ot">&lt;-</span> <span class="fl">0.90</span></span>
<span id="cb21-4"><a href="#cb21-4"></a></span>
<span id="cb21-5"><a href="#cb21-5"></a>  df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>    <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>    <span class="fu">mutate</span>(</span>
<span id="cb21-8"><a href="#cb21-8"></a>      <span class="at">date =</span> <span class="fu">as.Date</span>(date),</span>
<span id="cb21-9"><a href="#cb21-9"></a>      <span class="at">month =</span> <span class="fu">as.factor</span>(<span class="fu">month</span>(date)),</span>
<span id="cb21-10"><a href="#cb21-10"></a>      <span class="at">day =</span> <span class="fu">as.factor</span>(<span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb21-11"><a href="#cb21-11"></a>      <span class="at">day_of_year =</span> <span class="fu">yday</span>(date),</span>
<span id="cb21-12"><a href="#cb21-12"></a>      <span class="co"># Create factors for mice classification</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>      <span class="at">wind_gust_dir =</span> <span class="fu">as.factor</span>(wind_gust_dir),</span>
<span id="cb21-14"><a href="#cb21-14"></a>      <span class="at">wind_dir9am =</span> <span class="fu">as.factor</span>(wind_dir9am),</span>
<span id="cb21-15"><a href="#cb21-15"></a>      <span class="at">wind_dir3pm =</span> <span class="fu">as.factor</span>(wind_dir3pm),</span>
<span id="cb21-16"><a href="#cb21-16"></a>      <span class="at">rain_today =</span> <span class="fu">as.factor</span>(rain_today),</span>
<span id="cb21-17"><a href="#cb21-17"></a>      <span class="at">location =</span> <span class="fu">as.factor</span>(location)</span>
<span id="cb21-18"><a href="#cb21-18"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rainfall)) <span class="sc">%&gt;%</span></span>
<span id="cb21-20"><a href="#cb21-20"></a>    <span class="fu">select</span>(<span class="sc">-</span>rain_tomorrow)</span>
<span id="cb21-21"><a href="#cb21-21"></a></span>
<span id="cb21-22"><a href="#cb21-22"></a>  <span class="co"># 2. Interpolation</span></span>
<span id="cb21-23"><a href="#cb21-23"></a>  interp_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb21-24"><a href="#cb21-24"></a>    <span class="st">"min_temp"</span>,</span>
<span id="cb21-25"><a href="#cb21-25"></a>    <span class="st">"max_temp"</span>,</span>
<span id="cb21-26"><a href="#cb21-26"></a>    <span class="st">"temp9am"</span>,</span>
<span id="cb21-27"><a href="#cb21-27"></a>    <span class="st">"temp3pm"</span>,</span>
<span id="cb21-28"><a href="#cb21-28"></a>    <span class="st">"pressure9am"</span>,</span>
<span id="cb21-29"><a href="#cb21-29"></a>    <span class="st">"pressure3pm"</span>,</span>
<span id="cb21-30"><a href="#cb21-30"></a>    <span class="st">"humidity9am"</span>,</span>
<span id="cb21-31"><a href="#cb21-31"></a>    <span class="st">"humidity3pm"</span></span>
<span id="cb21-32"><a href="#cb21-32"></a>  )</span>
<span id="cb21-33"><a href="#cb21-33"></a></span>
<span id="cb21-34"><a href="#cb21-34"></a>  df_interp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb21-35"><a href="#cb21-35"></a>    <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span></span>
<span id="cb21-36"><a href="#cb21-36"></a>    <span class="fu">arrange</span>(date, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-37"><a href="#cb21-37"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb21-38"><a href="#cb21-38"></a>      <span class="fu">all_of</span>(interp_vars),</span>
<span id="cb21-39"><a href="#cb21-39"></a>      <span class="sc">~</span> <span class="fu">na.approx</span>(., <span class="at">maxgap =</span> MAXGAP, <span class="at">na.rm =</span> <span class="cn">FALSE</span>, <span class="at">rule =</span> <span class="dv">2</span>)</span>
<span id="cb21-40"><a href="#cb21-40"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb21-41"><a href="#cb21-41"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb21-42"><a href="#cb21-42"></a></span>
<span id="cb21-43"><a href="#cb21-43"></a>  <span class="co"># 3. Flag ghost vars</span></span>
<span id="cb21-44"><a href="#cb21-44"></a>  ghost_prone_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sunshine"</span>, <span class="st">"evaporation"</span>, <span class="st">"cloud3pm"</span>, <span class="st">"cloud9am"</span>)</span>
<span id="cb21-45"><a href="#cb21-45"></a></span>
<span id="cb21-46"><a href="#cb21-46"></a>  ghost_pairs <span class="ot">&lt;-</span> df_interp <span class="sc">%&gt;%</span></span>
<span id="cb21-47"><a href="#cb21-47"></a>    <span class="fu">select</span>(location, <span class="fu">all_of</span>(ghost_prone_vars)) <span class="sc">%&gt;%</span></span>
<span id="cb21-48"><a href="#cb21-48"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb21-49"><a href="#cb21-49"></a>      <span class="at">cols =</span> <span class="fu">all_of</span>(ghost_prone_vars),</span>
<span id="cb21-50"><a href="#cb21-50"></a>      <span class="at">names_to =</span> <span class="st">"variable"</span>,</span>
<span id="cb21-51"><a href="#cb21-51"></a>      <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb21-52"><a href="#cb21-52"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb21-53"><a href="#cb21-53"></a>    <span class="fu">group_by</span>(location, variable) <span class="sc">%&gt;%</span></span>
<span id="cb21-54"><a href="#cb21-54"></a>    <span class="fu">summarise</span>(<span class="at">miss_rate =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(value)) <span class="sc">*</span> <span class="dv">100</span>, <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-55"><a href="#cb21-55"></a>    <span class="fu">filter</span>(miss_rate <span class="sc">&gt;</span> (GHOST_THRESHOLD <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb21-56"><a href="#cb21-56"></a></span>
<span id="cb21-57"><a href="#cb21-57"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Found %d ghost sensor instances</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(ghost_pairs)))</span>
<span id="cb21-58"><a href="#cb21-58"></a></span>
<span id="cb21-59"><a href="#cb21-59"></a>  <span class="co"># Create flags for ghost vars only</span></span>
<span id="cb21-60"><a href="#cb21-60"></a>  df_flagged <span class="ot">&lt;-</span> df_interp <span class="sc">%&gt;%</span></span>
<span id="cb21-61"><a href="#cb21-61"></a>    <span class="fu">mutate</span>(</span>
<span id="cb21-62"><a href="#cb21-62"></a>      <span class="at">sunshine_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(sunshine)),</span>
<span id="cb21-63"><a href="#cb21-63"></a>      <span class="at">evap_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(evaporation)),</span>
<span id="cb21-64"><a href="#cb21-64"></a>      <span class="at">cloud3pm_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(cloud3pm)),</span>
<span id="cb21-65"><a href="#cb21-65"></a>      <span class="at">cloud9am_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(cloud9am))</span>
<span id="cb21-66"><a href="#cb21-66"></a>    )</span>
<span id="cb21-67"><a href="#cb21-67"></a></span>
<span id="cb21-68"><a href="#cb21-68"></a>  <span class="co"># MICE Setup</span></span>
<span id="cb21-69"><a href="#cb21-69"></a>  <span class="co"># Handle BOTH ghost variables AND wind variables</span></span>
<span id="cb21-70"><a href="#cb21-70"></a>  wind_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"wind_gust_dir"</span>, <span class="st">"wind_dir9am"</span>, <span class="st">"wind_dir3pm"</span>)</span>
<span id="cb21-71"><a href="#cb21-71"></a></span>
<span id="cb21-72"><a href="#cb21-72"></a>  init <span class="ot">&lt;-</span> <span class="fu">mice</span>(df_flagged, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb21-73"><a href="#cb21-73"></a>  pred <span class="ot">&lt;-</span> init<span class="sc">$</span>predictorMatrix</span>
<span id="cb21-74"><a href="#cb21-74"></a>  meth <span class="ot">&lt;-</span> init<span class="sc">$</span>method</span>
<span id="cb21-75"><a href="#cb21-75"></a></span>
<span id="cb21-76"><a href="#cb21-76"></a>  <span class="co"># Reset everything to zero</span></span>
<span id="cb21-77"><a href="#cb21-77"></a>  pred[,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-78"><a href="#cb21-78"></a></span>
<span id="cb21-79"><a href="#cb21-79"></a>  <span class="co"># Assign methods (Random Forest for all categorical/complex vars)</span></span>
<span id="cb21-80"><a href="#cb21-80"></a>  meth[ghost_prone_vars] <span class="ot">&lt;-</span> <span class="st">"rf"</span></span>
<span id="cb21-81"><a href="#cb21-81"></a>  meth[wind_vars] <span class="ot">&lt;-</span> <span class="st">"rf"</span></span>
<span id="cb21-82"><a href="#cb21-82"></a></span>
<span id="cb21-83"><a href="#cb21-83"></a>  <span class="co"># Ghost vars predictors</span></span>
<span id="cb21-84"><a href="#cb21-84"></a>  sun_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb21-85"><a href="#cb21-85"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb21-86"><a href="#cb21-86"></a>    <span class="fu">c</span>(<span class="st">"cloud9am"</span>, <span class="st">"cloud3pm"</span>, <span class="st">"max_temp"</span>, <span class="st">"humidity3pm"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb21-87"><a href="#cb21-87"></a>  )</span>
<span id="cb21-88"><a href="#cb21-88"></a>  evap_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb21-89"><a href="#cb21-89"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb21-90"><a href="#cb21-90"></a>    <span class="fu">c</span>(</span>
<span id="cb21-91"><a href="#cb21-91"></a>      <span class="st">"wind_gust_speed"</span>,</span>
<span id="cb21-92"><a href="#cb21-92"></a>      <span class="st">"max_temp"</span>,</span>
<span id="cb21-93"><a href="#cb21-93"></a>      <span class="st">"humidity3pm"</span>,</span>
<span id="cb21-94"><a href="#cb21-94"></a>      <span class="st">"sunshine"</span>,</span>
<span id="cb21-95"><a href="#cb21-95"></a>      <span class="st">"location"</span>,</span>
<span id="cb21-96"><a href="#cb21-96"></a>      <span class="st">"month"</span></span>
<span id="cb21-97"><a href="#cb21-97"></a>    )</span>
<span id="cb21-98"><a href="#cb21-98"></a>  )</span>
<span id="cb21-99"><a href="#cb21-99"></a>  cloud_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb21-100"><a href="#cb21-100"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb21-101"><a href="#cb21-101"></a>    <span class="fu">c</span>(<span class="st">"humidity9am"</span>, <span class="st">"humidity3pm"</span>, <span class="st">"pressure9am"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb21-102"><a href="#cb21-102"></a>  )</span>
<span id="cb21-103"><a href="#cb21-103"></a></span>
<span id="cb21-104"><a href="#cb21-104"></a>  <span class="cf">if</span> (<span class="st">"sunshine"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb21-105"><a href="#cb21-105"></a>    pred[<span class="st">"sunshine"</span>, sun_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-106"><a href="#cb21-106"></a>  }</span>
<span id="cb21-107"><a href="#cb21-107"></a>  <span class="cf">if</span> (<span class="st">"evaporation"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb21-108"><a href="#cb21-108"></a>    pred[<span class="st">"evaporation"</span>, evap_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-109"><a href="#cb21-109"></a>  }</span>
<span id="cb21-110"><a href="#cb21-110"></a>  <span class="cf">if</span> (<span class="st">"cloud9am"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb21-111"><a href="#cb21-111"></a>    pred[<span class="st">"cloud9am"</span>, cloud_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-112"><a href="#cb21-112"></a>  }</span>
<span id="cb21-113"><a href="#cb21-113"></a>  <span class="cf">if</span> (<span class="st">"cloud3pm"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb21-114"><a href="#cb21-114"></a>    pred[<span class="st">"cloud3pm"</span>, cloud_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-115"><a href="#cb21-115"></a>  }</span>
<span id="cb21-116"><a href="#cb21-116"></a></span>
<span id="cb21-117"><a href="#cb21-117"></a>  <span class="co"># Wind direction predictors</span></span>
<span id="cb21-118"><a href="#cb21-118"></a>  <span class="co"># Wind direction depends on location, month, pressure, and wind speed</span></span>
<span id="cb21-119"><a href="#cb21-119"></a>  wind_gust_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb21-120"><a href="#cb21-120"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb21-121"><a href="#cb21-121"></a>    <span class="fu">c</span>(<span class="st">"wind_gust_speed"</span>, <span class="st">"pressure3pm"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb21-122"><a href="#cb21-122"></a>  )</span>
<span id="cb21-123"><a href="#cb21-123"></a>  wind_9am_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb21-124"><a href="#cb21-124"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb21-125"><a href="#cb21-125"></a>    <span class="fu">c</span>(<span class="st">"wind_speed9am"</span>, <span class="st">"pressure9am"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb21-126"><a href="#cb21-126"></a>  )</span>
<span id="cb21-127"><a href="#cb21-127"></a>  wind_3pm_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb21-128"><a href="#cb21-128"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb21-129"><a href="#cb21-129"></a>    <span class="fu">c</span>(<span class="st">"wind_speed3pm"</span>, <span class="st">"pressure3pm"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb21-130"><a href="#cb21-130"></a>  )</span>
<span id="cb21-131"><a href="#cb21-131"></a></span>
<span id="cb21-132"><a href="#cb21-132"></a>  <span class="cf">if</span> (<span class="st">"wind_gust_dir"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb21-133"><a href="#cb21-133"></a>    pred[<span class="st">"wind_gust_dir"</span>, wind_gust_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-134"><a href="#cb21-134"></a>  }</span>
<span id="cb21-135"><a href="#cb21-135"></a>  <span class="cf">if</span> (<span class="st">"wind_dir9am"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb21-136"><a href="#cb21-136"></a>    pred[<span class="st">"wind_dir9am"</span>, wind_9am_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-137"><a href="#cb21-137"></a>  }</span>
<span id="cb21-138"><a href="#cb21-138"></a>  <span class="cf">if</span> (<span class="st">"wind_dir3pm"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb21-139"><a href="#cb21-139"></a>    pred[<span class="st">"wind_dir3pm"</span>, wind_3pm_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-140"><a href="#cb21-140"></a>  }</span>
<span id="cb21-141"><a href="#cb21-141"></a></span>
<span id="cb21-142"><a href="#cb21-142"></a>  <span class="co"># Ensure flags and date are never used as predictors</span></span>
<span id="cb21-143"><a href="#cb21-143"></a>  ignore_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"_imp_flagged$|^date$"</span>, <span class="fu">colnames</span>(pred), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-144"><a href="#cb21-144"></a>  pred[, ignore_cols] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-145"><a href="#cb21-145"></a></span>
<span id="cb21-146"><a href="#cb21-146"></a>  imp <span class="ot">&lt;-</span> <span class="fu">mice</span>(</span>
<span id="cb21-147"><a href="#cb21-147"></a>    df_flagged,</span>
<span id="cb21-148"><a href="#cb21-148"></a>    <span class="at">method =</span> meth,</span>
<span id="cb21-149"><a href="#cb21-149"></a>    <span class="at">predictorMatrix =</span> pred,</span>
<span id="cb21-150"><a href="#cb21-150"></a>    <span class="at">m =</span> <span class="dv">1</span>,</span>
<span id="cb21-151"><a href="#cb21-151"></a>    <span class="at">maxit =</span> <span class="dv">5</span>,</span>
<span id="cb21-152"><a href="#cb21-152"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb21-153"><a href="#cb21-153"></a>    <span class="at">printFlag =</span> <span class="cn">FALSE</span></span>
<span id="cb21-154"><a href="#cb21-154"></a>  )</span>
<span id="cb21-155"><a href="#cb21-155"></a></span>
<span id="cb21-156"><a href="#cb21-156"></a>  df_final <span class="ot">&lt;-</span> <span class="fu">complete</span>(imp)</span>
<span id="cb21-157"><a href="#cb21-157"></a>  <span class="fu">return</span>(df_final)</span>
<span id="cb21-158"><a href="#cb21-158"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>df_final <span class="ot">&lt;-</span> <span class="fu">clean_and_impute_weather</span>(df)</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">write_csv</span>(df_final, <span class="st">"data/df_final.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
<section id="post-imputation-dataset-properties" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="post-imputation-dataset-properties"><span class="header-section-number">2.5</span> Post-Imputation Dataset Properties</h2>
<p>The two-stage pipeline produces a dataset whose properties are each traceable to a specific finding from the diagnostic analysis.</p>
<p><strong>Retention without fabrication.</strong> No observations are discarded on the basis of partial missingness. The 27.9% of observations with all four target variables simultaneously absent are retained with those variables still missing, consistent with the ghost sensor finding that no empirically supportable imputation is possible for them.</p>
<p><strong>Temporal coherence.</strong> The interpolated variables maintain their within-location autocorrelation structure. The five-day cap, set in response to the temporal structural break analysis, prevents the interpolation from extending across genuine data voids.</p>
<p><strong>Distributional fidelity.</strong> The Random Forest method within MICE draws imputed values from the observed empirical distribution of each variable, preserving marginal distributions and preventing variance shrinkage.</p>
<p><strong>Outcome independence.</strong> The weather-conditionality test confirmed that sunshine missingness does not covary with rainfall amounts. Imputed sunshine values therefore do not introduce a directional bias into the training labels.</p>
<p><strong>Wind direction coherence.</strong> Wind direction variables are imputed as categorical factors using Random Forest, with each direction variable conditioned on its temporally matched speed and pressure readings. This preserves the physical coupling between concurrent wind speed and direction measurements while respecting the non-ordinal structure of compass-point categories.</p>
<p><strong>Provenance transparency.</strong> Binary imputation flags for the four ghost-prone variables are retained in the final dataset. These flags enable downstream models or diagnostics to condition on or exclude observations where imputed values carry no empirical anchor at the station level.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./01-intro.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-eda.html" class="pagination-link" aria-label="Exploratory Data Analysis">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Exploratory Data Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu"># Data Preparation {#sec-data}</span></span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a>---</span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="at">&gt; **Chapter Context.** Before any statistical analysis can proceed, the raw dataset must be transformed into a form that is both analytically tractable and physically credible. This chapter documents three decisions that have downstream consequences throughout the report: the syntactic and temporal standardisation of the raw data, a diagnostic investigation of the structure and mechanism of the missingness, and the design of a two-stage imputation pipeline informed by that investigation. Each decision is motivated by the properties of the data-generating process rather than by computational convenience.</span></span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a>---</span>
<span id="cb23-8"><a href="#cb23-8"></a></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="fu">## Computational Environment</span></span>
<span id="cb23-10"><a href="#cb23-10"></a></span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="in">```{r}</span></span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="co">#| label: setup-libraries-data</span></span>
<span id="cb23-15"><a href="#cb23-15"></a><span class="co">#| echo: true</span></span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="co">#| message: false</span></span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="co">#| warning: false</span></span>
<span id="cb23-18"><a href="#cb23-18"></a><span class="co">#| results: 'hide'</span></span>
<span id="cb23-19"><a href="#cb23-19"></a></span>
<span id="cb23-20"><a href="#cb23-20"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb23-21"><a href="#cb23-21"></a>  tidyverse,</span>
<span id="cb23-22"><a href="#cb23-22"></a>  tidymodels,</span>
<span id="cb23-23"><a href="#cb23-23"></a>  kableExtra,</span>
<span id="cb23-24"><a href="#cb23-24"></a>  patchwork,</span>
<span id="cb23-25"><a href="#cb23-25"></a>  skimr,</span>
<span id="cb23-26"><a href="#cb23-26"></a>  gridExtra,</span>
<span id="cb23-27"><a href="#cb23-27"></a>  gtsummary,</span>
<span id="cb23-28"><a href="#cb23-28"></a>  janitor,</span>
<span id="cb23-29"><a href="#cb23-29"></a>  corrplot,</span>
<span id="cb23-30"><a href="#cb23-30"></a>  sjPlot,</span>
<span id="cb23-31"><a href="#cb23-31"></a>  scales,</span>
<span id="cb23-32"><a href="#cb23-32"></a>  GGally,</span>
<span id="cb23-33"><a href="#cb23-33"></a>  car,</span>
<span id="cb23-34"><a href="#cb23-34"></a>  forcats,</span>
<span id="cb23-35"><a href="#cb23-35"></a>  performance,</span>
<span id="cb23-36"><a href="#cb23-36"></a>  glmmTMB,</span>
<span id="cb23-37"><a href="#cb23-37"></a>  splines,</span>
<span id="cb23-38"><a href="#cb23-38"></a>  mgcv,</span>
<span id="cb23-39"><a href="#cb23-39"></a>  DHARMa,</span>
<span id="cb23-40"><a href="#cb23-40"></a>  zoo,</span>
<span id="cb23-41"><a href="#cb23-41"></a>  ggpubr,</span>
<span id="cb23-42"><a href="#cb23-42"></a>  ggridges,</span>
<span id="cb23-43"><a href="#cb23-43"></a>  caret,</span>
<span id="cb23-44"><a href="#cb23-44"></a>  rstatix,</span>
<span id="cb23-45"><a href="#cb23-45"></a>  Metrics,</span>
<span id="cb23-46"><a href="#cb23-46"></a>  mice,</span>
<span id="cb23-47"><a href="#cb23-47"></a>  missRanger,</span>
<span id="cb23-48"><a href="#cb23-48"></a>  ranger,</span>
<span id="cb23-49"><a href="#cb23-49"></a>  cocor,</span>
<span id="cb23-50"><a href="#cb23-50"></a>  multcompView,</span>
<span id="cb23-51"><a href="#cb23-51"></a>  lmtest,</span>
<span id="cb23-52"><a href="#cb23-52"></a>  aod,</span>
<span id="cb23-53"><a href="#cb23-53"></a>  pROC,</span>
<span id="cb23-54"><a href="#cb23-54"></a>  naniar,</span>
<span id="cb23-55"><a href="#cb23-55"></a>  glue,</span>
<span id="cb23-56"><a href="#cb23-56"></a>  viridis</span>
<span id="cb23-57"><a href="#cb23-57"></a>)</span>
<span id="cb23-58"><a href="#cb23-58"></a></span>
<span id="cb23-59"><a href="#cb23-59"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/weatherAUS.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-60"><a href="#cb23-60"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb23-61"><a href="#cb23-61"></a></span>
<span id="cb23-62"><a href="#cb23-62"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"utils.R"</span>))</span>
<span id="cb23-63"><a href="#cb23-63"></a><span class="in">```</span></span>
<span id="cb23-64"><a href="#cb23-64"></a></span>
<span id="cb23-65"><a href="#cb23-65"></a>The package selection reflects the specific demands of meteorological data analysis. The core wrangling and visualisation toolkit (<span class="in">`tidyverse`</span>, <span class="in">`janitor`</span>, <span class="in">`kableExtra`</span>) handles routine data manipulation. The modelling stack (<span class="in">`glmmTMB`</span>, <span class="in">`DHARMa`</span>, <span class="in">`splines`</span>, <span class="in">`mgcv`</span>) is assembled for the zero-inflated mixed-effects framework documented in later chapters. The imputation stack (<span class="in">`missRanger`</span>, <span class="in">`mice`</span>, <span class="in">`ranger`</span>) supports the Random Forest and chained imputation procedures described below. The missingness diagnostic stack (<span class="in">`naniar`</span>, <span class="in">`glue`</span>) supports the structural analysis in Section 2.3 (@sec-missingness-diagnostics). Libraries are loaded via <span class="in">`librarian`</span>, which installs missing packages automatically and ensures reproducibility across environments.</span>
<span id="cb23-66"><a href="#cb23-66"></a></span>
<span id="cb23-67"><a href="#cb23-67"></a>---</span>
<span id="cb23-68"><a href="#cb23-68"></a></span>
<span id="cb23-69"><a href="#cb23-69"></a><span class="fu">## Initial Cleaning and Standardisation</span></span>
<span id="cb23-70"><a href="#cb23-70"></a></span>
<span id="cb23-71"><a href="#cb23-71"></a>The raw dataset undergoes three transformations before any missingness analysis or imputation.</span>
<span id="cb23-72"><a href="#cb23-72"></a></span>
<span id="cb23-75"><a href="#cb23-75"></a><span class="in">```{r}</span></span>
<span id="cb23-76"><a href="#cb23-76"></a><span class="co">#| label: data-cleaning</span></span>
<span id="cb23-77"><a href="#cb23-77"></a><span class="co">#| echo: true</span></span>
<span id="cb23-78"><a href="#cb23-78"></a><span class="co">#| message: false</span></span>
<span id="cb23-79"><a href="#cb23-79"></a><span class="co">#| warning: false</span></span>
<span id="cb23-80"><a href="#cb23-80"></a></span>
<span id="cb23-81"><a href="#cb23-81"></a>df_clean <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-82"><a href="#cb23-82"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-83"><a href="#cb23-83"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(date),</span>
<span id="cb23-84"><a href="#cb23-84"></a>    <span class="at">month =</span> <span class="fu">as.factor</span>(<span class="fu">month</span>(date)),</span>
<span id="cb23-85"><a href="#cb23-85"></a>    <span class="at">day =</span> <span class="fu">as.factor</span>(<span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>))</span>
<span id="cb23-86"><a href="#cb23-86"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-87"><a href="#cb23-87"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rainfall))</span>
<span id="cb23-88"><a href="#cb23-88"></a></span>
<span id="cb23-89"><a href="#cb23-89"></a>df_clean <span class="sc">%&gt;%</span></span>
<span id="cb23-90"><a href="#cb23-90"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-91"><a href="#cb23-91"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Head of Cleaned Dataset"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-92"><a href="#cb23-92"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>))</span>
<span id="cb23-93"><a href="#cb23-93"></a></span>
<span id="cb23-94"><a href="#cb23-94"></a>df_clean <span class="sc">%&gt;%</span></span>
<span id="cb23-95"><a href="#cb23-95"></a>  <span class="fu">tail</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-96"><a href="#cb23-96"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Tail of Cleaned Dataset"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-97"><a href="#cb23-97"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>))</span>
<span id="cb23-98"><a href="#cb23-98"></a><span class="in">```</span></span>
<span id="cb23-99"><a href="#cb23-99"></a></span>
<span id="cb23-100"><a href="#cb23-100"></a>**Column standardisation.** All variable names are converted to <span class="in">`snake_case`</span> via <span class="in">`janitor::clean_names()`</span>, called at ingestion. This eliminates downstream ambiguity in variable references and ensures internal consistency across all chapters.</span>
<span id="cb23-101"><a href="#cb23-101"></a></span>
<span id="cb23-102"><a href="#cb23-102"></a>**Temporal feature extraction.** The <span class="in">`date`</span> column is typed as a <span class="in">`Date`</span> object and two derived features are extracted: <span class="in">`month`</span> (as a factor) and <span class="in">`day`</span> (day of week, labelled). Month captures the seasonal structure of Australian precipitation; day of week is retained as a potential control variable for reporting artefacts in the raw data.</span>
<span id="cb23-103"><a href="#cb23-103"></a></span>
<span id="cb23-104"><a href="#cb23-104"></a>**Target filtering.** Observations where <span class="in">`rainfall`</span> is missing are removed. Records without a ground-truth rainfall measurement have no supervised learning value and cannot contribute to either the hurdle or the intensity component of the ZIG model.</span>
<span id="cb23-105"><a href="#cb23-105"></a></span>
<span id="cb23-106"><a href="#cb23-106"></a>---</span>
<span id="cb23-107"><a href="#cb23-107"></a></span>
<span id="cb23-108"><a href="#cb23-108"></a><span class="fu">## Missingness Diagnostics {#sec-missingness-diagnostics}</span></span>
<span id="cb23-109"><a href="#cb23-109"></a></span>
<span id="cb23-110"><a href="#cb23-110"></a>Before designing an imputation strategy, it is necessary to understand the mechanism and structure of the missing data. The choice between imputation methods depends critically on three questions: whether missingness is random with respect to other variables in the dataset, whether missing values cluster at specific locations or time periods, and whether the four most-affected variables fail independently or as a coordinated group. A strategy designed without answering these questions risks either under-imputing (discarding recoverable signal) or over-imputing (fabricating data in regions where recovery is not possible). The five analyses below provide the empirical basis for each design decision in the pipeline that follows.</span>
<span id="cb23-111"><a href="#cb23-111"></a></span>
<span id="cb23-112"><a href="#cb23-112"></a><span class="fu">### Co-missingness Structure {#sec-co-missingness}</span></span>
<span id="cb23-113"><a href="#cb23-113"></a></span>
<span id="cb23-116"><a href="#cb23-116"></a><span class="in">```{r}</span></span>
<span id="cb23-117"><a href="#cb23-117"></a><span class="co">#| label: tbl-co-missingness</span></span>
<span id="cb23-118"><a href="#cb23-118"></a><span class="co">#| tbl-cap: "Conditional Co-missingness Matrix"</span></span>
<span id="cb23-119"><a href="#cb23-119"></a><span class="co">#| echo: true</span></span>
<span id="cb23-120"><a href="#cb23-120"></a><span class="co">#| message: false</span></span>
<span id="cb23-121"><a href="#cb23-121"></a><span class="co">#| warning: false</span></span>
<span id="cb23-122"><a href="#cb23-122"></a></span>
<span id="cb23-123"><a href="#cb23-123"></a>high_miss_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sunshine"</span>, <span class="st">"evaporation"</span>, <span class="st">"cloud3pm"</span>, <span class="st">"cloud9am"</span>)</span>
<span id="cb23-124"><a href="#cb23-124"></a>high_miss <span class="ot">&lt;-</span> high_miss_cols[high_miss_cols <span class="sc">%in%</span> <span class="fu">names</span>(df)]</span>
<span id="cb23-125"><a href="#cb23-125"></a></span>
<span id="cb23-126"><a href="#cb23-126"></a><span class="fu">cat</span>(<span class="st">"High missingness variables:"</span>, <span class="fu">paste</span>(high_miss, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb23-127"><a href="#cb23-127"></a></span>
<span id="cb23-128"><a href="#cb23-128"></a>miss_mat <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-129"><a href="#cb23-129"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb23-130"><a href="#cb23-130"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), is.na)) <span class="sc">%&gt;%</span></span>
<span id="cb23-131"><a href="#cb23-131"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-132"><a href="#cb23-132"></a>  <span class="fu">apply</span>(<span class="dv">2</span>, as.integer)</span>
<span id="cb23-133"><a href="#cb23-133"></a></span>
<span id="cb23-134"><a href="#cb23-134"></a>intersection_matrix <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(miss_mat)</span>
<span id="cb23-135"><a href="#cb23-135"></a>total_miss_counts <span class="ot">&lt;-</span> <span class="fu">diag</span>(intersection_matrix)</span>
<span id="cb23-136"><a href="#cb23-136"></a></span>
<span id="cb23-137"><a href="#cb23-137"></a>pct_matrix <span class="ot">&lt;-</span> intersection_matrix <span class="sc">/</span> total_miss_counts <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-138"><a href="#cb23-138"></a></span>
<span id="cb23-139"><a href="#cb23-139"></a>co_missing_stats <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">as.table</span>(pct_matrix)) <span class="sc">%&gt;%</span></span>
<span id="cb23-140"><a href="#cb23-140"></a>  <span class="fu">rename</span>(<span class="at">var1 =</span> Var1, <span class="at">var2 =</span> Var2, <span class="at">pct_co_miss =</span> Freq) <span class="sc">%&gt;%</span></span>
<span id="cb23-141"><a href="#cb23-141"></a>  <span class="fu">filter</span>(var1 <span class="sc">!=</span> var2) <span class="sc">%&gt;%</span></span>
<span id="cb23-142"><a href="#cb23-142"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(pct_co_miss))</span>
<span id="cb23-143"><a href="#cb23-143"></a></span>
<span id="cb23-144"><a href="#cb23-144"></a>co_missing_stats <span class="sc">%&gt;%</span></span>
<span id="cb23-145"><a href="#cb23-145"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-146"><a href="#cb23-146"></a>    <span class="at">msg =</span> <span class="fu">glue</span>(</span>
<span id="cb23-147"><a href="#cb23-147"></a>      <span class="st">"  {var1} -&gt; {var2}: {round(pct_co_miss, 1)}%  (when {var1} is missing, {var2} is missing)"</span></span>
<span id="cb23-148"><a href="#cb23-148"></a>    )</span>
<span id="cb23-149"><a href="#cb23-149"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-150"><a href="#cb23-150"></a>  <span class="fu">pull</span>(msg) <span class="sc">%&gt;%</span></span>
<span id="cb23-151"><a href="#cb23-151"></a>  <span class="fu">walk</span>(cat, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb23-152"><a href="#cb23-152"></a></span>
<span id="cb23-153"><a href="#cb23-153"></a>co_missing_stats <span class="sc">%&gt;%</span></span>
<span id="cb23-154"><a href="#cb23-154"></a>  <span class="fu">kable</span>(</span>
<span id="cb23-155"><a href="#cb23-155"></a>    <span class="at">caption =</span> <span class="st">"Conditional Co-missingness: when var1 is missing, what percentage of the time is var2 also missing?"</span>,</span>
<span id="cb23-156"><a href="#cb23-156"></a>    <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb23-157"><a href="#cb23-157"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Variable 1 (Missing)"</span>, <span class="st">"Variable 2"</span>, <span class="st">"Co-missing (%)"</span>)</span>
<span id="cb23-158"><a href="#cb23-158"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-159"><a href="#cb23-159"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-160"><a href="#cb23-160"></a><span class="in">```</span></span>
<span id="cb23-161"><a href="#cb23-161"></a></span>
<span id="cb23-162"><a href="#cb23-162"></a>The co-missingness matrix (@tbl-co-missingness) confirms that these four variables fail as a systematic cluster rather than independently. The dependencies are strongest between instrumental pairs: if evaporation is missing, there is a 93.2% probability that sunshine is also missing. Even the weakest relationship in the matrix (sunshine to cloud9am) retains a rate of 67.5%, which is nearly double what would be expected under random failure.</span>
<span id="cb23-163"><a href="#cb23-163"></a></span>
<span id="cb23-164"><a href="#cb23-164"></a>Under MCAR, the co-missing rates would be close to the marginal missingness rates of each variable, roughly 40 to 48%. Rates uniformly between 67% and 93% instead indicate a shared upstream cause: the instrumentation profile of each station. Sunshine recorders, evaporation pans, and cloud coverage sensors are deployed as a package, not individually. A station without one is very likely to lack the others. This is MNAR at the station level. The practical consequence for imputation is that treating the four variables as independently missing would be incorrect: their correlations when observed are available precisely because they fail together, and a multivariate imputation method that exploits those cross-variable relationships will outperform four separate univariate models.</span>
<span id="cb23-165"><a href="#cb23-165"></a></span>
<span id="cb23-166"><a href="#cb23-166"></a><span class="fu">### Temporal Structure and Structural Breaks {#sec-temporal-structure}</span></span>
<span id="cb23-167"><a href="#cb23-167"></a></span>
<span id="cb23-170"><a href="#cb23-170"></a><span class="in">```{r}</span></span>
<span id="cb23-171"><a href="#cb23-171"></a><span class="co">#| label: fig-temporal-missingness</span></span>
<span id="cb23-172"><a href="#cb23-172"></a><span class="co">#| fig-cap: "Timeline of systematic missingness across the four high-missingness variables. The stepped increases visible particularly in sunshine and evaporation indicate structural breaks in data collection rather than random sensor failures."</span></span>
<span id="cb23-173"><a href="#cb23-173"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb23-174"><a href="#cb23-174"></a><span class="co">#| fig-height: 7</span></span>
<span id="cb23-175"><a href="#cb23-175"></a><span class="co">#| echo: true</span></span>
<span id="cb23-176"><a href="#cb23-176"></a><span class="co">#| warning: false</span></span>
<span id="cb23-177"><a href="#cb23-177"></a></span>
<span id="cb23-178"><a href="#cb23-178"></a>temporal_trend <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-179"><a href="#cb23-179"></a>  <span class="fu">mutate</span>(<span class="at">month_floor =</span> <span class="fu">floor_date</span>(date, <span class="st">"month"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-180"><a href="#cb23-180"></a>  <span class="fu">select</span>(month_floor, <span class="fu">any_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb23-181"><a href="#cb23-181"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb23-182"><a href="#cb23-182"></a>    <span class="at">cols =</span> <span class="sc">-</span>month_floor,</span>
<span id="cb23-183"><a href="#cb23-183"></a>    <span class="at">names_to =</span> <span class="st">"variable"</span>,</span>
<span id="cb23-184"><a href="#cb23-184"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb23-185"><a href="#cb23-185"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-186"><a href="#cb23-186"></a>  <span class="fu">group_by</span>(month_floor, variable) <span class="sc">%&gt;%</span></span>
<span id="cb23-187"><a href="#cb23-187"></a>  <span class="fu">summarise</span>(<span class="at">pct_missing =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(value)) <span class="sc">*</span> <span class="dv">100</span>, <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb23-188"><a href="#cb23-188"></a></span>
<span id="cb23-189"><a href="#cb23-189"></a><span class="fu">ggplot</span>(</span>
<span id="cb23-190"><a href="#cb23-190"></a>  temporal_trend,</span>
<span id="cb23-191"><a href="#cb23-191"></a>  <span class="fu">aes</span>(<span class="at">x =</span> month_floor, <span class="at">y =</span> pct_missing, <span class="at">color =</span> variable)</span>
<span id="cb23-192"><a href="#cb23-192"></a>) <span class="sc">+</span></span>
<span id="cb23-193"><a href="#cb23-193"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-194"><a href="#cb23-194"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-195"><a href="#cb23-195"></a>  <span class="fu">labs</span>(</span>
<span id="cb23-196"><a href="#cb23-196"></a>    <span class="at">title =</span> <span class="st">"Timeline of Systematic Missingness"</span>,</span>
<span id="cb23-197"><a href="#cb23-197"></a>    <span class="at">subtitle =</span> <span class="st">"Structural breaks appear as step changes rather than random fluctuations"</span>,</span>
<span id="cb23-198"><a href="#cb23-198"></a>    <span class="at">y =</span> <span class="st">"Missingness (%)"</span>,</span>
<span id="cb23-199"><a href="#cb23-199"></a>    <span class="at">x =</span> <span class="st">"Year"</span></span>
<span id="cb23-200"><a href="#cb23-200"></a>  ) <span class="sc">+</span></span>
<span id="cb23-201"><a href="#cb23-201"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb23-202"><a href="#cb23-202"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>))</span>
<span id="cb23-203"><a href="#cb23-203"></a><span class="in">```</span></span>
<span id="cb23-204"><a href="#cb23-204"></a></span>
<span id="cb23-205"><a href="#cb23-205"></a>The temporal analysis (@fig-temporal-missingness) confirms that missingness is not randomly distributed over time. The cloud cover variables maintain a roughly stable and high missingness rate across the observation window, consistent with a fixed set of stations never having recorded these measurements. The <span class="in">`sunshine`</span> and <span class="in">`evaporation`</span> variables show a distinct stepped pattern: missingness rises at specific breakpoints rather than fluctuating randomly, indicating that certain stations were decommissioned or that recording protocols changed at identifiable calendar dates.</span>
<span id="cb23-206"><a href="#cb23-206"></a></span>
<span id="cb23-207"><a href="#cb23-207"></a>This temporal structure has a direct implication for the interpolation stage of the pipeline. Linear interpolation is appropriate when a smooth trajectory can be inferred from values on either side of a gap. Extended contiguous gaps produced by a structural break have no valid upper boundary from which to interpolate, and filling them with temporal interpolation would create long synthetic sequences with no empirical anchor. The five-day interpolation cap set in Stage 1 of the pipeline is a direct response to this finding.</span>
<span id="cb23-208"><a href="#cb23-208"></a></span>
<span id="cb23-209"><a href="#cb23-209"></a><span class="fu">### Geographic Concentration: Ghost Sensor Identification {#sec-ghost-sensor}</span></span>
<span id="cb23-210"><a href="#cb23-210"></a></span>
<span id="cb23-213"><a href="#cb23-213"></a><span class="in">```{r}</span></span>
<span id="cb23-214"><a href="#cb23-214"></a><span class="co">#| label: ghost-sensors</span></span>
<span id="cb23-215"><a href="#cb23-215"></a><span class="co">#| echo: true</span></span>
<span id="cb23-216"><a href="#cb23-216"></a><span class="co">#| message: false</span></span>
<span id="cb23-217"><a href="#cb23-217"></a><span class="co">#| warning: false</span></span>
<span id="cb23-218"><a href="#cb23-218"></a></span>
<span id="cb23-219"><a href="#cb23-219"></a>GHOST_THRESHOLD <span class="ot">&lt;-</span> <span class="fl">0.90</span></span>
<span id="cb23-220"><a href="#cb23-220"></a></span>
<span id="cb23-221"><a href="#cb23-221"></a>location_summary <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-222"><a href="#cb23-222"></a>  <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span></span>
<span id="cb23-223"><a href="#cb23-223"></a>  naniar<span class="sc">::</span><span class="fu">miss_var_summary</span>()</span>
<span id="cb23-224"><a href="#cb23-224"></a></span>
<span id="cb23-225"><a href="#cb23-225"></a>ghost_sensors <span class="ot">&lt;-</span> location_summary <span class="sc">%&gt;%</span></span>
<span id="cb23-226"><a href="#cb23-226"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> high_miss, pct_miss <span class="sc">&gt;</span> GHOST_THRESHOLD <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-227"><a href="#cb23-227"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(pct_miss))</span>
<span id="cb23-228"><a href="#cb23-228"></a></span>
<span id="cb23-229"><a href="#cb23-229"></a>ghost_sensors <span class="sc">%&gt;%</span></span>
<span id="cb23-230"><a href="#cb23-230"></a>  <span class="fu">kable</span>(</span>
<span id="cb23-231"><a href="#cb23-231"></a>    <span class="at">caption =</span> <span class="st">"Ghost Sensor Instances: Location-Variable Pairs with &gt;90% Missingness"</span>,</span>
<span id="cb23-232"><a href="#cb23-232"></a>    <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb23-233"><a href="#cb23-233"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Location"</span>, <span class="st">"Variable"</span>, <span class="st">"Missing (n)"</span>, <span class="st">"Missing (%)"</span>)</span>
<span id="cb23-234"><a href="#cb23-234"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-235"><a href="#cb23-235"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-236"><a href="#cb23-236"></a></span>
<span id="cb23-237"><a href="#cb23-237"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(</span>
<span id="cb23-238"><a href="#cb23-238"></a>  <span class="st">"</span><span class="sc">\n</span><span class="st">Total ghost sensor instances identified: %d across %d locations</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb23-239"><a href="#cb23-239"></a>  <span class="fu">nrow</span>(ghost_sensors),</span>
<span id="cb23-240"><a href="#cb23-240"></a>  <span class="fu">n_distinct</span>(ghost_sensors<span class="sc">$</span>location)</span>
<span id="cb23-241"><a href="#cb23-241"></a>))</span>
<span id="cb23-242"><a href="#cb23-242"></a><span class="in">```</span></span>
<span id="cb23-243"><a href="#cb23-243"></a></span>
<span id="cb23-244"><a href="#cb23-244"></a>The location-level analysis identifies the specific station-variable pairs responsible for the bulk of the aggregate missingness. The top ten instances from the script output, all at exactly 100% missing, are as follows: Albury (<span class="in">`evaporation`</span>, 3,040 observations; <span class="in">`sunshine`</span>, 3,040), BadgerysCreek (<span class="in">`evaporation`</span>, 3,009; <span class="in">`sunshine`</span>, 3,009; <span class="in">`cloud9am`</span>, 3,009; <span class="in">`cloud3pm`</span>, 3,009), Newcastle (<span class="in">`evaporation`</span>, 3,039; <span class="in">`sunshine`</span>, 3,039), and NorahHead (<span class="in">`evaporation`</span>, 3,004; <span class="in">`sunshine`</span>, 3,004). At these stations, the instrument in question recorded a value on zero days across the entire observation window. These are not sensors experiencing intermittent failure; they are sensors that were never present or that were removed before the data collection period began.</span>
<span id="cb23-245"><a href="#cb23-245"></a></span>
<span id="cb23-246"><a href="#cb23-246"></a>The distinction between ghost sensors and ordinary missingness is consequential for imputation. For a gap of five to fifteen consecutive missing days, a Random Forest model can generate reasonable predictions by drawing on correlated variables at the same station and the same variable at nearby stations. For a gap spanning 3,000 or more consecutive observations, this extrapolation has no empirical support whatsoever: there is no observed value at that station and variable combination to anchor or validate the prediction. Values produced for these pairs would be statistically plausible by construction but would carry no physical information about what the instrument would have actually recorded. Ghost sensor pairs are identified before Stage 2 runs and flagged so that their imputed values can be treated with appropriate scepticism in downstream analysis.</span>
<span id="cb23-247"><a href="#cb23-247"></a></span>
<span id="cb23-248"><a href="#cb23-248"></a><span class="fu">### Weather-Conditionality of Sunshine Missingness {#sec-weather-conditionality}</span></span>
<span id="cb23-249"><a href="#cb23-249"></a></span>
<span id="cb23-252"><a href="#cb23-252"></a><span class="in">```{r}</span></span>
<span id="cb23-253"><a href="#cb23-253"></a><span class="co">#| label: tbl-sunshine-mcar-test</span></span>
<span id="cb23-254"><a href="#cb23-254"></a><span class="co">#| echo: true</span></span>
<span id="cb23-255"><a href="#cb23-255"></a><span class="co">#| message: false</span></span>
<span id="cb23-256"><a href="#cb23-256"></a><span class="co">#| warning: false</span></span>
<span id="cb23-257"><a href="#cb23-257"></a></span>
<span id="cb23-258"><a href="#cb23-258"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"rainfall"</span>, <span class="st">"sunshine"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb23-259"><a href="#cb23-259"></a>  weather_missing_stats <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-260"><a href="#cb23-260"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rainfall)) <span class="sc">%&gt;%</span></span>
<span id="cb23-261"><a href="#cb23-261"></a>    <span class="fu">mutate</span>(<span class="at">is_rainy =</span> <span class="fu">if_else</span>(rainfall <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="st">"Rainy (&gt;1mm)"</span>, <span class="st">"Dry (&lt;=1mm)"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-262"><a href="#cb23-262"></a>    <span class="fu">group_by</span>(is_rainy) <span class="sc">%&gt;%</span></span>
<span id="cb23-263"><a href="#cb23-263"></a>    <span class="fu">summarise</span>(</span>
<span id="cb23-264"><a href="#cb23-264"></a>      <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb23-265"><a href="#cb23-265"></a>      <span class="at">pct_sunshine_missing =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(sunshine)) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb23-266"><a href="#cb23-266"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb23-267"><a href="#cb23-267"></a>    )</span>
<span id="cb23-268"><a href="#cb23-268"></a></span>
<span id="cb23-269"><a href="#cb23-269"></a>  <span class="fu">print</span>(weather_missing_stats)</span>
<span id="cb23-270"><a href="#cb23-270"></a></span>
<span id="cb23-271"><a href="#cb23-271"></a>  weather_missing_stats <span class="sc">%&gt;%</span></span>
<span id="cb23-272"><a href="#cb23-272"></a>    <span class="fu">kable</span>(</span>
<span id="cb23-273"><a href="#cb23-273"></a>      <span class="at">caption =</span> <span class="st">"Sunshine Missingness Rate by Daily Rainfall Status"</span>,</span>
<span id="cb23-274"><a href="#cb23-274"></a>      <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb23-275"><a href="#cb23-275"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Day Type"</span>, <span class="st">"Observations (n)"</span>, <span class="st">"Sunshine Missing (%)"</span>)</span>
<span id="cb23-276"><a href="#cb23-276"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb23-277"><a href="#cb23-277"></a>    <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-278"><a href="#cb23-278"></a>}</span>
<span id="cb23-279"><a href="#cb23-279"></a><span class="in">```</span></span>
<span id="cb23-280"><a href="#cb23-280"></a></span>
<span id="cb23-283"><a href="#cb23-283"></a><span class="in">```{r}</span></span>
<span id="cb23-284"><a href="#cb23-284"></a><span class="co">#| label: fig-sunshine-rainfall-density</span></span>
<span id="cb23-285"><a href="#cb23-285"></a><span class="co">#| fig-cap: "Density of rainfall amounts on days where sunshine data is present versus missing. The near-identical distributions confirm that sunshine missingness is not weather-conditional: the same stations are missing sunshine on both dry and rainy days because the instrument was simply not installed, not because it failed during precipitation events."</span></span>
<span id="cb23-286"><a href="#cb23-286"></a><span class="co">#| fig-width: 9</span></span>
<span id="cb23-287"><a href="#cb23-287"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb23-288"><a href="#cb23-288"></a><span class="co">#| echo: true</span></span>
<span id="cb23-289"><a href="#cb23-289"></a><span class="co">#| warning: false</span></span>
<span id="cb23-290"><a href="#cb23-290"></a></span>
<span id="cb23-291"><a href="#cb23-291"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb23-292"><a href="#cb23-292"></a>  naniar<span class="sc">::</span><span class="fu">bind_shadow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-293"><a href="#cb23-293"></a>  <span class="fu">filter</span>(rainfall <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> rainfall <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-294"><a href="#cb23-294"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rainfall, <span class="at">fill =</span> sunshine_NA)) <span class="sc">+</span></span>
<span id="cb23-295"><a href="#cb23-295"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb23-296"><a href="#cb23-296"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"!NA"</span> <span class="ot">=</span> <span class="st">"Present"</span>, <span class="st">"NA"</span> <span class="ot">=</span> <span class="st">"Missing"</span>)) <span class="sc">+</span></span>
<span id="cb23-297"><a href="#cb23-297"></a>  <span class="fu">labs</span>(</span>
<span id="cb23-298"><a href="#cb23-298"></a>    <span class="at">title =</span> <span class="st">"Does Sunshine go Missing on Rainy Days?"</span>,</span>
<span id="cb23-299"><a href="#cb23-299"></a>    <span class="at">subtitle =</span> <span class="st">"Density of rainfall amounts for days with Missing vs. Present sunshine data"</span>,</span>
<span id="cb23-300"><a href="#cb23-300"></a>    <span class="at">x =</span> <span class="st">"Rainfall (mm)"</span>,</span>
<span id="cb23-301"><a href="#cb23-301"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb23-302"><a href="#cb23-302"></a>    <span class="at">fill =</span> <span class="st">"Sunshine Status"</span></span>
<span id="cb23-303"><a href="#cb23-303"></a>  ) <span class="sc">+</span></span>
<span id="cb23-304"><a href="#cb23-304"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb23-305"><a href="#cb23-305"></a><span class="in">```</span></span>
<span id="cb23-306"><a href="#cb23-306"></a></span>
<span id="cb23-307"><a href="#cb23-307"></a>A specific concern when imputing a predictor variable is outcome-related missingness: if sunshine sensors failed more often on rainy days, then the imputed values would carry a directional signal about the target variable and could introduce bias into the training data.</span>
<span id="cb23-308"><a href="#cb23-308"></a></span>
<span id="cb23-309"><a href="#cb23-309"></a>The empirical test refutes this concern. The table output (@tbl-sunshine-mcar-test) reports a sunshine missing rate of 47.8% on 110,319 dry days (rainfall at most 1 mm) and 47.2% on 31,880 rainy days (rainfall above 1 mm), a difference of 0.6 percentage points. The density plot (@fig-sunshine-rainfall-density) makes the same point visually: the distribution of rainfall amounts on days with missing sunshine and on days with present sunshine are indistinguishable across the full range from 0 to 50 mm. The slight visual offset in the figure reflects not a systematic pattern but the difference in the sizes of the two groups.</span>
<span id="cb23-310"><a href="#cb23-310"></a></span>
<span id="cb23-311"><a href="#cb23-311"></a>Sunshine missingness is station-conditional rather than weather-conditional. The same stations record missing sunshine on both dry and rainy days at nearly identical rates, because the instrument is absent from those stations entirely. This finding clears the imputation path: there is no outcome-related confound to correct for.</span>
<span id="cb23-312"><a href="#cb23-312"></a></span>
<span id="cb23-313"><a href="#cb23-313"></a><span class="fu">### Missing Pattern Structure</span></span>
<span id="cb23-314"><a href="#cb23-314"></a></span>
<span id="cb23-317"><a href="#cb23-317"></a><span class="in">```{r}</span></span>
<span id="cb23-318"><a href="#cb23-318"></a><span class="co">#| label: miss-pattern-table</span></span>
<span id="cb23-319"><a href="#cb23-319"></a><span class="co">#| echo: true</span></span>
<span id="cb23-320"><a href="#cb23-320"></a><span class="co">#| message: false</span></span>
<span id="cb23-321"><a href="#cb23-321"></a><span class="co">#| warning: false</span></span>
<span id="cb23-322"><a href="#cb23-322"></a></span>
<span id="cb23-323"><a href="#cb23-323"></a><span class="fu">cat</span>(<span class="st">"Missing pattern combinations:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb23-324"><a href="#cb23-324"></a></span>
<span id="cb23-325"><a href="#cb23-325"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb23-326"><a href="#cb23-326"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb23-327"><a href="#cb23-327"></a>  naniar<span class="sc">::</span><span class="fu">miss_case_table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-328"><a href="#cb23-328"></a>  <span class="fu">print</span>()</span>
<span id="cb23-329"><a href="#cb23-329"></a></span>
<span id="cb23-330"><a href="#cb23-330"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb23-331"><a href="#cb23-331"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(high_miss)) <span class="sc">%&gt;%</span></span>
<span id="cb23-332"><a href="#cb23-332"></a>  naniar<span class="sc">::</span><span class="fu">miss_case_table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-333"><a href="#cb23-333"></a>  <span class="fu">kable</span>(</span>
<span id="cb23-334"><a href="#cb23-334"></a>    <span class="at">caption =</span> <span class="st">"Distribution of Missing Variable Count per Observation"</span>,</span>
<span id="cb23-335"><a href="#cb23-335"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb23-336"><a href="#cb23-336"></a>      <span class="st">"Variables Missing (of 4)"</span>,</span>
<span id="cb23-337"><a href="#cb23-337"></a>      <span class="st">"Observations (n)"</span>,</span>
<span id="cb23-338"><a href="#cb23-338"></a>      <span class="st">"Percentage (%)"</span></span>
<span id="cb23-339"><a href="#cb23-339"></a>    )</span>
<span id="cb23-340"><a href="#cb23-340"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-341"><a href="#cb23-341"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-342"><a href="#cb23-342"></a><span class="in">```</span></span>
<span id="cb23-343"><a href="#cb23-343"></a></span>
<span id="cb23-344"><a href="#cb23-344"></a>The case-level output from the script reveals a strongly bimodal structure across five distinct patterns. Of all observations: 62,566 (43.0%) have none of the four variables missing; 10,525 (7.2%) have exactly one missing; 20,376 (14.0%) have exactly two missing; 11,378 (7.8%) have exactly three missing; and 40,615 (27.9%) have all four missing simultaneously. The two endpoint categories, zero missing and all four missing, together account for 70.9% of all observations.</span>
<span id="cb23-345"><a href="#cb23-345"></a></span>
<span id="cb23-346"><a href="#cb23-346"></a>The 27.9% with complete simultaneous missingness corresponds directly to the ghost sensor stations identified in @sec-ghost-sensor. For these observations, no imputation is supportable and the values remain missing after the pipeline. The 43.0% with no missingness require no intervention. The substantive imputation work is concentrated in the remaining 29.1% across the three intermediate patterns, where partial instrumentation means that correlated predictors are available to inform the Random Forest estimates. The bimodal structure also confirms that the co-missingness finding is not a statistical artifact: observations genuinely tend to be fully instrumented or minimally instrumented, not randomly partially instrumented.</span>
<span id="cb23-347"><a href="#cb23-347"></a></span>
<span id="cb23-348"><a href="#cb23-348"></a>---</span>
<span id="cb23-349"><a href="#cb23-349"></a></span>
<span id="cb23-350"><a href="#cb23-350"></a><span class="fu">## Imputation Pipeline</span></span>
<span id="cb23-351"><a href="#cb23-351"></a></span>
<span id="cb23-352"><a href="#cb23-352"></a>The diagnostic evidence from @sec-missingness-diagnostics motivates each design decision in the imputation pipeline. Missingness is station-level rather than weather-conditional (@sec-weather-conditionality), temporally structured with extended contiguous gaps rather than random scatter (@sec-temporal-structure), and co-located across variables at the station level (@sec-co-missingness). These properties rule out simple listwise deletion and mean imputation. They call for a pipeline that respects temporal continuity for smoothly-evolving variables, exploits cross-variable correlations for the structured variables, and declines to impute where the data is genuinely unrecoverable.</span>
<span id="cb23-353"><a href="#cb23-353"></a></span>
<span id="cb23-354"><a href="#cb23-354"></a><span class="fu">### Stage 1: Temporal Interpolation</span></span>
<span id="cb23-355"><a href="#cb23-355"></a></span>
<span id="cb23-356"><a href="#cb23-356"></a>The eight variables with smooth day-to-day trajectories minimum and maximum temperature, morning and afternoon temperature, morning and afternoon pressure, and morning and afternoon humidity are imputed via linear interpolation grouped by location, bounded by a five-day maximum gap. The five-day cap is set directly in response to the temporal structural break finding: gaps of up to five days lie within a regime where the values at both boundaries sufficiently constrain the trajectory, while longer gaps are associated with structural collection failures that interpolation cannot safely bridge.</span>
<span id="cb23-357"><a href="#cb23-357"></a></span>
<span id="cb23-358"><a href="#cb23-358"></a><span class="fu">### Stage 2: Multivariate Random Forest Imputation</span></span>
<span id="cb23-359"><a href="#cb23-359"></a></span>
<span id="cb23-360"><a href="#cb23-360"></a>Remaining gaps in <span class="in">`sunshine`</span>, <span class="in">`evaporation`</span>, cloud cover, and wind direction are addressed using <span class="in">`mice`</span> with a Random Forest method. Each variable is imputed from a scientifically motivated predictor set:</span>
<span id="cb23-361"><a href="#cb23-361"></a></span>
<span id="cb23-362"><a href="#cb23-362"></a><span class="ss">- </span>**Cloud cover** (<span class="in">`cloud9am`</span>, <span class="in">`cloud3pm`</span>) from humidity and pressure.</span>
<span id="cb23-363"><a href="#cb23-363"></a><span class="ss">- </span>**Sunshine** from cloud cover, temperature, humidity, location, and month.</span>
<span id="cb23-364"><a href="#cb23-364"></a><span class="ss">- </span>**Evaporation** from wind gust speed, temperature, humidity, sunshine, location, and month.</span>
<span id="cb23-365"><a href="#cb23-365"></a><span class="ss">- </span>**Wind direction** (<span class="in">`wind_gust_dir`</span>, <span class="in">`wind_dir9am`</span>, <span class="in">`wind_dir3pm`</span>) from the corresponding wind speed, pressure, location, and month.</span>
<span id="cb23-366"><a href="#cb23-366"></a></span>
<span id="cb23-367"><a href="#cb23-367"></a>Wind direction is treated as a categorical variable imputed with Random Forest, which handles the multi-class, non-ordinal nature of compass-point directions without imposing a false numeric ordering. Each wind direction variable uses its temporally matched pressure and speed readings as predictors gust direction from gust speed and 3pm pressure, 9am direction from 9am speed and pressure, and 3pm direction from 3pm speed and pressure  preserving the physical coupling between concurrent measurements.</span>
<span id="cb23-368"><a href="#cb23-368"></a></span>
<span id="cb23-369"><a href="#cb23-369"></a>The use of targeted predictor sets is directly motivated by the co-missingness finding. Because the four atmosphere variables tend to be absent together at the station level, their cross-variable correlations when observed are strong and reliable signals for imputation. Restricting each variable's predictor set to physically motivated covariates exploits this structure while reducing the risk of imputing on spurious correlations.</span>
<span id="cb23-370"><a href="#cb23-370"></a></span>
<span id="cb23-371"><a href="#cb23-371"></a><span class="fu">### Ghost Sensor Flagging</span></span>
<span id="cb23-372"><a href="#cb23-372"></a></span>
<span id="cb23-373"><a href="#cb23-373"></a>Before Stage 2 runs, all station-variable pairs identified in @sec-ghost-sensor as ghost sensors (more than 90% missing across the full observation window) are catalogued and binary missingness flags are attached to the data (<span class="in">`sunshine_imp_flagged`</span>, <span class="in">`evap_imp_flagged`</span>, <span class="in">`cloud3pm_imp_flagged`</span>, <span class="in">`cloud9am_imp_flagged`</span>). These flags serve two purposes: they are excluded from the MICE predictor matrix so they cannot contaminate the imputation model, and they remain in the final dataset as explicit markers of which values are extrapolated with no empirical anchor. Flag columns are also excluded from the predictor matrix alongside the raw date column to prevent data leakage. A Random Forest model has no empirical support for predicting values at a station where an instrument was never present; the flags make this provenance transparent for any downstream analysis that needs to account for it.</span>
<span id="cb23-374"><a href="#cb23-374"></a></span>
<span id="cb23-377"><a href="#cb23-377"></a><span class="in">```{r}</span></span>
<span id="cb23-378"><a href="#cb23-378"></a><span class="co">#| label: imputation-strategy</span></span>
<span id="cb23-379"><a href="#cb23-379"></a><span class="co">#| echo: true</span></span>
<span id="cb23-380"><a href="#cb23-380"></a><span class="co">#| eval: false</span></span>
<span id="cb23-381"><a href="#cb23-381"></a></span>
<span id="cb23-382"><a href="#cb23-382"></a>clean_and_impute_weather <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb23-383"><a href="#cb23-383"></a>  MAXGAP <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb23-384"><a href="#cb23-384"></a>  GHOST_THRESHOLD <span class="ot">&lt;-</span> <span class="fl">0.90</span></span>
<span id="cb23-385"><a href="#cb23-385"></a></span>
<span id="cb23-386"><a href="#cb23-386"></a>  df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-387"><a href="#cb23-387"></a>    <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-388"><a href="#cb23-388"></a>    <span class="fu">mutate</span>(</span>
<span id="cb23-389"><a href="#cb23-389"></a>      <span class="at">date =</span> <span class="fu">as.Date</span>(date),</span>
<span id="cb23-390"><a href="#cb23-390"></a>      <span class="at">month =</span> <span class="fu">as.factor</span>(<span class="fu">month</span>(date)),</span>
<span id="cb23-391"><a href="#cb23-391"></a>      <span class="at">day =</span> <span class="fu">as.factor</span>(<span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb23-392"><a href="#cb23-392"></a>      <span class="at">day_of_year =</span> <span class="fu">yday</span>(date),</span>
<span id="cb23-393"><a href="#cb23-393"></a>      <span class="co"># Create factors for mice classification</span></span>
<span id="cb23-394"><a href="#cb23-394"></a>      <span class="at">wind_gust_dir =</span> <span class="fu">as.factor</span>(wind_gust_dir),</span>
<span id="cb23-395"><a href="#cb23-395"></a>      <span class="at">wind_dir9am =</span> <span class="fu">as.factor</span>(wind_dir9am),</span>
<span id="cb23-396"><a href="#cb23-396"></a>      <span class="at">wind_dir3pm =</span> <span class="fu">as.factor</span>(wind_dir3pm),</span>
<span id="cb23-397"><a href="#cb23-397"></a>      <span class="at">rain_today =</span> <span class="fu">as.factor</span>(rain_today),</span>
<span id="cb23-398"><a href="#cb23-398"></a>      <span class="at">location =</span> <span class="fu">as.factor</span>(location)</span>
<span id="cb23-399"><a href="#cb23-399"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb23-400"><a href="#cb23-400"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rainfall)) <span class="sc">%&gt;%</span></span>
<span id="cb23-401"><a href="#cb23-401"></a>    <span class="fu">select</span>(<span class="sc">-</span>rain_tomorrow)</span>
<span id="cb23-402"><a href="#cb23-402"></a></span>
<span id="cb23-403"><a href="#cb23-403"></a>  <span class="co"># 2. Interpolation</span></span>
<span id="cb23-404"><a href="#cb23-404"></a>  interp_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb23-405"><a href="#cb23-405"></a>    <span class="st">"min_temp"</span>,</span>
<span id="cb23-406"><a href="#cb23-406"></a>    <span class="st">"max_temp"</span>,</span>
<span id="cb23-407"><a href="#cb23-407"></a>    <span class="st">"temp9am"</span>,</span>
<span id="cb23-408"><a href="#cb23-408"></a>    <span class="st">"temp3pm"</span>,</span>
<span id="cb23-409"><a href="#cb23-409"></a>    <span class="st">"pressure9am"</span>,</span>
<span id="cb23-410"><a href="#cb23-410"></a>    <span class="st">"pressure3pm"</span>,</span>
<span id="cb23-411"><a href="#cb23-411"></a>    <span class="st">"humidity9am"</span>,</span>
<span id="cb23-412"><a href="#cb23-412"></a>    <span class="st">"humidity3pm"</span></span>
<span id="cb23-413"><a href="#cb23-413"></a>  )</span>
<span id="cb23-414"><a href="#cb23-414"></a></span>
<span id="cb23-415"><a href="#cb23-415"></a>  df_interp <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-416"><a href="#cb23-416"></a>    <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span></span>
<span id="cb23-417"><a href="#cb23-417"></a>    <span class="fu">arrange</span>(date, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-418"><a href="#cb23-418"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb23-419"><a href="#cb23-419"></a>      <span class="fu">all_of</span>(interp_vars),</span>
<span id="cb23-420"><a href="#cb23-420"></a>      <span class="sc">~</span> <span class="fu">na.approx</span>(., <span class="at">maxgap =</span> MAXGAP, <span class="at">na.rm =</span> <span class="cn">FALSE</span>, <span class="at">rule =</span> <span class="dv">2</span>)</span>
<span id="cb23-421"><a href="#cb23-421"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb23-422"><a href="#cb23-422"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb23-423"><a href="#cb23-423"></a></span>
<span id="cb23-424"><a href="#cb23-424"></a>  <span class="co"># 3. Flag ghost vars</span></span>
<span id="cb23-425"><a href="#cb23-425"></a>  ghost_prone_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sunshine"</span>, <span class="st">"evaporation"</span>, <span class="st">"cloud3pm"</span>, <span class="st">"cloud9am"</span>)</span>
<span id="cb23-426"><a href="#cb23-426"></a></span>
<span id="cb23-427"><a href="#cb23-427"></a>  ghost_pairs <span class="ot">&lt;-</span> df_interp <span class="sc">%&gt;%</span></span>
<span id="cb23-428"><a href="#cb23-428"></a>    <span class="fu">select</span>(location, <span class="fu">all_of</span>(ghost_prone_vars)) <span class="sc">%&gt;%</span></span>
<span id="cb23-429"><a href="#cb23-429"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb23-430"><a href="#cb23-430"></a>      <span class="at">cols =</span> <span class="fu">all_of</span>(ghost_prone_vars),</span>
<span id="cb23-431"><a href="#cb23-431"></a>      <span class="at">names_to =</span> <span class="st">"variable"</span>,</span>
<span id="cb23-432"><a href="#cb23-432"></a>      <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb23-433"><a href="#cb23-433"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb23-434"><a href="#cb23-434"></a>    <span class="fu">group_by</span>(location, variable) <span class="sc">%&gt;%</span></span>
<span id="cb23-435"><a href="#cb23-435"></a>    <span class="fu">summarise</span>(<span class="at">miss_rate =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(value)) <span class="sc">*</span> <span class="dv">100</span>, <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-436"><a href="#cb23-436"></a>    <span class="fu">filter</span>(miss_rate <span class="sc">&gt;</span> (GHOST_THRESHOLD <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb23-437"><a href="#cb23-437"></a></span>
<span id="cb23-438"><a href="#cb23-438"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Found %d ghost sensor instances</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(ghost_pairs)))</span>
<span id="cb23-439"><a href="#cb23-439"></a></span>
<span id="cb23-440"><a href="#cb23-440"></a>  <span class="co"># Create flags for ghost vars only</span></span>
<span id="cb23-441"><a href="#cb23-441"></a>  df_flagged <span class="ot">&lt;-</span> df_interp <span class="sc">%&gt;%</span></span>
<span id="cb23-442"><a href="#cb23-442"></a>    <span class="fu">mutate</span>(</span>
<span id="cb23-443"><a href="#cb23-443"></a>      <span class="at">sunshine_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(sunshine)),</span>
<span id="cb23-444"><a href="#cb23-444"></a>      <span class="at">evap_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(evaporation)),</span>
<span id="cb23-445"><a href="#cb23-445"></a>      <span class="at">cloud3pm_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(cloud3pm)),</span>
<span id="cb23-446"><a href="#cb23-446"></a>      <span class="at">cloud9am_imp_flagged =</span> <span class="fu">as.integer</span>(<span class="fu">is.na</span>(cloud9am))</span>
<span id="cb23-447"><a href="#cb23-447"></a>    )</span>
<span id="cb23-448"><a href="#cb23-448"></a></span>
<span id="cb23-449"><a href="#cb23-449"></a>  <span class="co"># MICE Setup</span></span>
<span id="cb23-450"><a href="#cb23-450"></a>  <span class="co"># Handle BOTH ghost variables AND wind variables</span></span>
<span id="cb23-451"><a href="#cb23-451"></a>  wind_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"wind_gust_dir"</span>, <span class="st">"wind_dir9am"</span>, <span class="st">"wind_dir3pm"</span>)</span>
<span id="cb23-452"><a href="#cb23-452"></a></span>
<span id="cb23-453"><a href="#cb23-453"></a>  init <span class="ot">&lt;-</span> <span class="fu">mice</span>(df_flagged, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb23-454"><a href="#cb23-454"></a>  pred <span class="ot">&lt;-</span> init<span class="sc">$</span>predictorMatrix</span>
<span id="cb23-455"><a href="#cb23-455"></a>  meth <span class="ot">&lt;-</span> init<span class="sc">$</span>method</span>
<span id="cb23-456"><a href="#cb23-456"></a></span>
<span id="cb23-457"><a href="#cb23-457"></a>  <span class="co"># Reset everything to zero</span></span>
<span id="cb23-458"><a href="#cb23-458"></a>  pred[,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-459"><a href="#cb23-459"></a></span>
<span id="cb23-460"><a href="#cb23-460"></a>  <span class="co"># Assign methods (Random Forest for all categorical/complex vars)</span></span>
<span id="cb23-461"><a href="#cb23-461"></a>  meth[ghost_prone_vars] <span class="ot">&lt;-</span> <span class="st">"rf"</span></span>
<span id="cb23-462"><a href="#cb23-462"></a>  meth[wind_vars] <span class="ot">&lt;-</span> <span class="st">"rf"</span></span>
<span id="cb23-463"><a href="#cb23-463"></a></span>
<span id="cb23-464"><a href="#cb23-464"></a>  <span class="co"># Ghost vars predictors</span></span>
<span id="cb23-465"><a href="#cb23-465"></a>  sun_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb23-466"><a href="#cb23-466"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb23-467"><a href="#cb23-467"></a>    <span class="fu">c</span>(<span class="st">"cloud9am"</span>, <span class="st">"cloud3pm"</span>, <span class="st">"max_temp"</span>, <span class="st">"humidity3pm"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb23-468"><a href="#cb23-468"></a>  )</span>
<span id="cb23-469"><a href="#cb23-469"></a>  evap_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb23-470"><a href="#cb23-470"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb23-471"><a href="#cb23-471"></a>    <span class="fu">c</span>(</span>
<span id="cb23-472"><a href="#cb23-472"></a>      <span class="st">"wind_gust_speed"</span>,</span>
<span id="cb23-473"><a href="#cb23-473"></a>      <span class="st">"max_temp"</span>,</span>
<span id="cb23-474"><a href="#cb23-474"></a>      <span class="st">"humidity3pm"</span>,</span>
<span id="cb23-475"><a href="#cb23-475"></a>      <span class="st">"sunshine"</span>,</span>
<span id="cb23-476"><a href="#cb23-476"></a>      <span class="st">"location"</span>,</span>
<span id="cb23-477"><a href="#cb23-477"></a>      <span class="st">"month"</span></span>
<span id="cb23-478"><a href="#cb23-478"></a>    )</span>
<span id="cb23-479"><a href="#cb23-479"></a>  )</span>
<span id="cb23-480"><a href="#cb23-480"></a>  cloud_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb23-481"><a href="#cb23-481"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb23-482"><a href="#cb23-482"></a>    <span class="fu">c</span>(<span class="st">"humidity9am"</span>, <span class="st">"humidity3pm"</span>, <span class="st">"pressure9am"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb23-483"><a href="#cb23-483"></a>  )</span>
<span id="cb23-484"><a href="#cb23-484"></a></span>
<span id="cb23-485"><a href="#cb23-485"></a>  <span class="cf">if</span> (<span class="st">"sunshine"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb23-486"><a href="#cb23-486"></a>    pred[<span class="st">"sunshine"</span>, sun_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-487"><a href="#cb23-487"></a>  }</span>
<span id="cb23-488"><a href="#cb23-488"></a>  <span class="cf">if</span> (<span class="st">"evaporation"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb23-489"><a href="#cb23-489"></a>    pred[<span class="st">"evaporation"</span>, evap_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-490"><a href="#cb23-490"></a>  }</span>
<span id="cb23-491"><a href="#cb23-491"></a>  <span class="cf">if</span> (<span class="st">"cloud9am"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb23-492"><a href="#cb23-492"></a>    pred[<span class="st">"cloud9am"</span>, cloud_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-493"><a href="#cb23-493"></a>  }</span>
<span id="cb23-494"><a href="#cb23-494"></a>  <span class="cf">if</span> (<span class="st">"cloud3pm"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb23-495"><a href="#cb23-495"></a>    pred[<span class="st">"cloud3pm"</span>, cloud_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-496"><a href="#cb23-496"></a>  }</span>
<span id="cb23-497"><a href="#cb23-497"></a></span>
<span id="cb23-498"><a href="#cb23-498"></a>  <span class="co"># Wind direction predictors</span></span>
<span id="cb23-499"><a href="#cb23-499"></a>  <span class="co"># Wind direction depends on location, month, pressure, and wind speed</span></span>
<span id="cb23-500"><a href="#cb23-500"></a>  wind_gust_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb23-501"><a href="#cb23-501"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb23-502"><a href="#cb23-502"></a>    <span class="fu">c</span>(<span class="st">"wind_gust_speed"</span>, <span class="st">"pressure3pm"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb23-503"><a href="#cb23-503"></a>  )</span>
<span id="cb23-504"><a href="#cb23-504"></a>  wind_9am_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb23-505"><a href="#cb23-505"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb23-506"><a href="#cb23-506"></a>    <span class="fu">c</span>(<span class="st">"wind_speed9am"</span>, <span class="st">"pressure9am"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb23-507"><a href="#cb23-507"></a>  )</span>
<span id="cb23-508"><a href="#cb23-508"></a>  wind_3pm_predictors <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb23-509"><a href="#cb23-509"></a>    <span class="fu">colnames</span>(df_flagged),</span>
<span id="cb23-510"><a href="#cb23-510"></a>    <span class="fu">c</span>(<span class="st">"wind_speed3pm"</span>, <span class="st">"pressure3pm"</span>, <span class="st">"location"</span>, <span class="st">"month"</span>)</span>
<span id="cb23-511"><a href="#cb23-511"></a>  )</span>
<span id="cb23-512"><a href="#cb23-512"></a></span>
<span id="cb23-513"><a href="#cb23-513"></a>  <span class="cf">if</span> (<span class="st">"wind_gust_dir"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb23-514"><a href="#cb23-514"></a>    pred[<span class="st">"wind_gust_dir"</span>, wind_gust_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-515"><a href="#cb23-515"></a>  }</span>
<span id="cb23-516"><a href="#cb23-516"></a>  <span class="cf">if</span> (<span class="st">"wind_dir9am"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb23-517"><a href="#cb23-517"></a>    pred[<span class="st">"wind_dir9am"</span>, wind_9am_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-518"><a href="#cb23-518"></a>  }</span>
<span id="cb23-519"><a href="#cb23-519"></a>  <span class="cf">if</span> (<span class="st">"wind_dir3pm"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(pred)) {</span>
<span id="cb23-520"><a href="#cb23-520"></a>    pred[<span class="st">"wind_dir3pm"</span>, wind_3pm_predictors] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-521"><a href="#cb23-521"></a>  }</span>
<span id="cb23-522"><a href="#cb23-522"></a></span>
<span id="cb23-523"><a href="#cb23-523"></a>  <span class="co"># Ensure flags and date are never used as predictors</span></span>
<span id="cb23-524"><a href="#cb23-524"></a>  ignore_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"_imp_flagged$|^date$"</span>, <span class="fu">colnames</span>(pred), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-525"><a href="#cb23-525"></a>  pred[, ignore_cols] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-526"><a href="#cb23-526"></a></span>
<span id="cb23-527"><a href="#cb23-527"></a>  imp <span class="ot">&lt;-</span> <span class="fu">mice</span>(</span>
<span id="cb23-528"><a href="#cb23-528"></a>    df_flagged,</span>
<span id="cb23-529"><a href="#cb23-529"></a>    <span class="at">method =</span> meth,</span>
<span id="cb23-530"><a href="#cb23-530"></a>    <span class="at">predictorMatrix =</span> pred,</span>
<span id="cb23-531"><a href="#cb23-531"></a>    <span class="at">m =</span> <span class="dv">1</span>,</span>
<span id="cb23-532"><a href="#cb23-532"></a>    <span class="at">maxit =</span> <span class="dv">5</span>,</span>
<span id="cb23-533"><a href="#cb23-533"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb23-534"><a href="#cb23-534"></a>    <span class="at">printFlag =</span> <span class="cn">FALSE</span></span>
<span id="cb23-535"><a href="#cb23-535"></a>  )</span>
<span id="cb23-536"><a href="#cb23-536"></a></span>
<span id="cb23-537"><a href="#cb23-537"></a>  df_final <span class="ot">&lt;-</span> <span class="fu">complete</span>(imp)</span>
<span id="cb23-538"><a href="#cb23-538"></a>  <span class="fu">return</span>(df_final)</span>
<span id="cb23-539"><a href="#cb23-539"></a>}</span>
<span id="cb23-540"><a href="#cb23-540"></a><span class="in">```</span></span>
<span id="cb23-541"><a href="#cb23-541"></a></span>
<span id="cb23-544"><a href="#cb23-544"></a><span class="in">```{r}</span></span>
<span id="cb23-545"><a href="#cb23-545"></a><span class="co">#| label: clean-and-save-imputed</span></span>
<span id="cb23-546"><a href="#cb23-546"></a><span class="co">#| message: false</span></span>
<span id="cb23-547"><a href="#cb23-547"></a><span class="co">#| warning: false</span></span>
<span id="cb23-548"><a href="#cb23-548"></a><span class="co">#| eval: false</span></span>
<span id="cb23-549"><a href="#cb23-549"></a></span>
<span id="cb23-550"><a href="#cb23-550"></a>df_final <span class="ot">&lt;-</span> <span class="fu">clean_and_impute_weather</span>(df)</span>
<span id="cb23-551"><a href="#cb23-551"></a><span class="fu">write_csv</span>(df_final, <span class="st">"data/df_final.csv"</span>)</span>
<span id="cb23-552"><a href="#cb23-552"></a><span class="in">```</span></span>
<span id="cb23-553"><a href="#cb23-553"></a></span>
<span id="cb23-556"><a href="#cb23-556"></a><span class="in">```{r}</span></span>
<span id="cb23-557"><a href="#cb23-557"></a><span class="co">#| label: load-imputed-data</span></span>
<span id="cb23-558"><a href="#cb23-558"></a><span class="co">#| echo: false</span></span>
<span id="cb23-559"><a href="#cb23-559"></a><span class="co">#| message: false</span></span>
<span id="cb23-560"><a href="#cb23-560"></a><span class="co">#| warning: false</span></span>
<span id="cb23-561"><a href="#cb23-561"></a></span>
<span id="cb23-562"><a href="#cb23-562"></a>df_final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/df_final.csv"</span>)</span>
<span id="cb23-563"><a href="#cb23-563"></a><span class="in">```</span></span>
<span id="cb23-564"><a href="#cb23-564"></a></span>
<span id="cb23-565"><a href="#cb23-565"></a>---</span>
<span id="cb23-566"><a href="#cb23-566"></a></span>
<span id="cb23-567"><a href="#cb23-567"></a><span class="fu">## Post-Imputation Dataset Properties</span></span>
<span id="cb23-568"><a href="#cb23-568"></a></span>
<span id="cb23-569"><a href="#cb23-569"></a>The two-stage pipeline produces a dataset whose properties are each traceable to a specific finding from the diagnostic analysis.</span>
<span id="cb23-570"><a href="#cb23-570"></a></span>
<span id="cb23-571"><a href="#cb23-571"></a>**Retention without fabrication.** No observations are discarded on the basis of partial missingness. The 27.9% of observations with all four target variables simultaneously absent are retained with those variables still missing, consistent with the ghost sensor finding that no empirically supportable imputation is possible for them.</span>
<span id="cb23-572"><a href="#cb23-572"></a></span>
<span id="cb23-573"><a href="#cb23-573"></a>**Temporal coherence.** The interpolated variables maintain their within-location autocorrelation structure. The five-day cap, set in response to the temporal structural break analysis, prevents the interpolation from extending across genuine data voids.</span>
<span id="cb23-574"><a href="#cb23-574"></a></span>
<span id="cb23-575"><a href="#cb23-575"></a>**Distributional fidelity.** The Random Forest method within MICE draws imputed values from the observed empirical distribution of each variable, preserving marginal distributions and preventing variance shrinkage.</span>
<span id="cb23-576"><a href="#cb23-576"></a></span>
<span id="cb23-577"><a href="#cb23-577"></a>**Outcome independence.** The weather-conditionality test confirmed that sunshine missingness does not covary with rainfall amounts. Imputed sunshine values therefore do not introduce a directional bias into the training labels.</span>
<span id="cb23-578"><a href="#cb23-578"></a></span>
<span id="cb23-579"><a href="#cb23-579"></a>**Wind direction coherence.** Wind direction variables are imputed as categorical factors using Random Forest, with each direction variable conditioned on its temporally matched speed and pressure readings. This preserves the physical coupling between concurrent wind speed and direction measurements while respecting the non-ordinal structure of compass-point categories.</span>
<span id="cb23-580"><a href="#cb23-580"></a></span>
<span id="cb23-581"><a href="#cb23-581"></a>**Provenance transparency.** Binary imputation flags for the four ghost-prone variables are retained in the final dataset. These flags enable downstream models or diagnostics to condition on or exclude observations where imputed values carry no empirical anchor at the station level.</span>
<span id="cb23-582"><a href="#cb23-582"></a></span>
<span id="cb23-585"><a href="#cb23-585"></a><span class="in">```{r}</span></span>
<span id="cb23-586"><a href="#cb23-586"></a><span class="co">#| label: save-clean-data</span></span>
<span id="cb23-587"><a href="#cb23-587"></a><span class="co">#| include: false</span></span>
<span id="cb23-588"><a href="#cb23-588"></a></span>
<span id="cb23-589"><a href="#cb23-589"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data"</span>)) {</span>
<span id="cb23-590"><a href="#cb23-590"></a>  <span class="fu">dir.create</span>(<span class="st">"data"</span>)</span>
<span id="cb23-591"><a href="#cb23-591"></a>}</span>
<span id="cb23-592"><a href="#cb23-592"></a><span class="fu">saveRDS</span>(df_clean, <span class="st">"data/df_clean.rds"</span>)</span>
<span id="cb23-593"><a href="#cb23-593"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/chrisolande/Statistical-Inference-Zero-Inflated-Models/blob/main/02-data-prep.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/chrisolande/Statistical-Inference-Zero-Inflated-Models/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>