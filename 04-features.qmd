# Feature Engineering {#sec-feature-eng}
## From Raw Meteorological Signals to Predictive Inputs

---

> **Chapter Context.** This chapter documents the feature engineering pipeline that bridges the exploratory analysis and the final model. Each design decision traces directly to an empirical finding from the EDA: the features constructed here are not ad hoc transformations but targeted responses to identified distributional and structural properties of the data.

---

## Signal Extraction via Moving Averages

Daily meteorological observations are inherently noisy. A single day's rainfall measurement reflects both the underlying weather regime and a high-frequency stochastic component, the difference between a storm cell passing directly over a station versus five kilometres to its east. Before engineering predictive features from this signal, we must first assess whether smoothing can reduce this noise and, if so, at what cost.

Rolling means over 3-day and 7-day trailing windows are computed for both rainfall and afternoon humidity. Right-alignment is enforced throughout, meaning the average at time $t$ is computed from observations at $t$, $t-1$, ..., $t-(k-1)$. This is a necessary precaution against data leakage: any lookahead alignment would contaminate the training signal with future observations.

```{r}
#| label: setup-features
#| include: false

librarian::shelf(
  tidyverse,
  zoo,
  ggridges,
  scales,
  kableExtra,
  performance,
  here
)

df_final <- read_csv("data/df_final.csv")
source(here::here("utils.R"))

feat_theme <- theme_classic(base_size = 11) +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 10),
    axis.line = element_line(colour = "grey40"),
    panel.grid.major = element_line(colour = "grey93", linewidth = 0.35),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 9, colour = "grey40"),
    plot.caption = element_text(size = 7, colour = "grey50", hjust = 0),
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 9),
    legend.text = element_text(size = 8),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9)
  )
```


```{r}
#| label: ma-feature-engineering
#| echo: true
#| message: false

ma_data <- df_final %>%
  group_by(location) %>%
  arrange(date) %>%
  mutate(
    rainfall_ma3 = rollmean(rainfall, k = 3, fill = NA, align = "right"),
    rainfall_ma7 = rollmean(rainfall, k = 7, fill = NA, align = "right"),
    humidity_ma3 = rollmean(humidity3pm, k = 3, fill = NA, align = "right"),
    humidity_ma7 = rollmean(humidity3pm, k = 7, fill = NA, align = "right")
  ) %>%
  ungroup()
```

### Noise Reduction

```{r}
#| label: fig-signal-extraction
#| fig-cap: "Density of raw and smoothed daily rainfall on non-zero days. The 7-day moving average acts as a low-pass filter: the distribution peak rises and the extreme right tail compresses, isolating the central tendency of wet regimes from day-to-day stochastic variance."
#| fig-width: 10
#| fig-height: 6
#| echo: true
#| warning: false

p1_data <- ma_data %>%
  filter(rainfall > 0) %>%
  select(rainfall, rainfall_ma3, rainfall_ma7) %>%
  pivot_longer(everything(), names_to = "metric", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(
    metric = factor(
      metric,
      levels = c("rainfall", "rainfall_ma3", "rainfall_ma7"),
      labels = c("Raw daily", "3-day MA", "7-day MA")
    )
  )

ggplot(p1_data, aes(x = value, fill = metric, colour = metric)) +
  geom_density(alpha = 0.38, linewidth = 0.8) +
  annotation_logticks(sides = "b", colour = "grey55", linewidth = 0.3) +
  scale_x_log10(
    breaks = c(0.1, 0.5, 1, 5, 10, 50, 100),
    labels = label_number(suffix = " mm"),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  scale_fill_manual(
    values = c(
      "Raw daily" = "#C0392B",
      "3-day MA" = "#E67E22",
      "7-day MA" = "#1A7A4A"
    )
  ) +
  scale_colour_manual(
    values = c(
      "Raw daily" = "#C0392B",
      "3-day MA" = "#E67E22",
      "7-day MA" = "#1A7A4A"
    )
  ) +
  labs(
    title = "Moving Averages Filter High-Frequency Noise",
    subtitle = "Raw rainfall (red) is severely right-skewed. 
    The 7-day average (green) concentrates 
    probability mass near the regime centre.",
    x = "Rainfall intensity (log scale)",
    y = "Density",
    caption = "Restricted to non-zero observations. Log scale on x-axis.",
    fill = NULL,
    colour = NULL
  ) +
  feat_theme +
  theme(
    legend.position = "top",
    legend.key.width = unit(0.8, "cm")
  )
```

```{r}
#| label: fig-variance-reduction
#| fig-cap: "Standard deviation of rainfall by averaging window. Each additional day of smoothing removes a material fraction of the day-to-day stochastic variability, at the cost of reduced responsiveness to abrupt regime changes."
#| fig-width: 7
#| fig-height: 5
#| echo: true
#| warning: false

variance_data <- ma_data %>%
  filter(rainfall > 0) %>%
  summarise(
    Raw = sd(rainfall, na.rm = TRUE),
    `3-day MA` = sd(rainfall_ma3, na.rm = TRUE),
    `7-day MA` = sd(rainfall_ma7, na.rm = TRUE)
  ) %>%
  pivot_longer(everything(), names_to = "metric", values_to = "sd") %>%
  mutate(
    metric = factor(metric, levels = c("Raw", "3-day MA", "7-day MA")),
    variance_reduction = (sd[metric == "Raw"] - sd) / sd[metric == "Raw"] * 100
  )

ggplot(variance_data, aes(metric, sd, fill = metric)) +
  geom_col(alpha = 0.85, width = 0.58) +
  geom_text(
    aes(label = sprintf("%.1f mm\n(%.0f%% reduction)", sd, variance_reduction)),
    vjust = -0.35,
    fontface = "bold",
    size = 3.6,
    colour = "grey15"
  ) +
  scale_fill_manual(
    values = c(
      "Raw" = "#C0392B",
      "3-day MA" = "#E67E22",
      "7-day MA" = "#1A7A4A"
    )
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.18)),
    breaks = pretty_breaks(n = 5)
  ) +
  labs(
    title = "Variance Reduction by Moving Average Window",
    subtitle = "Standard deviation falls as the averaging window widens.",
    y = "Standard deviation (mm)",
    x = NULL
  ) +
  feat_theme +
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank()
  )
```

```{r}
#| label: fig-ma-ridgeline
#| fig-cap: "Ridgeline distributions for raw and smoothed rainfall on non-zero days. Median lines confirm that the central tendency is stable across windows; the visible tail compression is purely a reduction in stochastic variance."
#| fig-width: 9
#| fig-height: 6
#| echo: true
#| warning: false

ridge_data <- ma_data %>%
  filter(rainfall > 0) %>%
  select(rainfall, rainfall_ma3, rainfall_ma7) %>%
  pivot_longer(everything(), names_to = "metric", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(
    metric = factor(
      metric,
      levels = c("rainfall_ma7", "rainfall_ma3", "rainfall"),
      labels = c("7-day MA", "3-day MA", "Raw daily")
    )
  )

ggplot(ridge_data, aes(value, metric, fill = metric)) +
  geom_density_ridges(
    alpha = 0.72,
    scale = 1.5,
    quantile_lines = TRUE,
    quantiles = 2,
    colour = "grey30",
    linewidth = 0.3
  ) +
  scale_x_log10(
    breaks = c(1, 5, 10, 25, 50, 100),
    labels = c("1", "5", "10", "25", "50", "100"),
    expand = expansion(mult = c(0.02, 0.04))
  ) +
  scale_fill_manual(
    values = c(
      "Raw daily" = "#C0392B",
      "3-day MA" = "#E67E22",
      "7-day MA" = "#1A7A4A"
    )
  ) +
  labs(
    title = "Distribution Tightening with Moving Averages",
    subtitle = "Peaks become sharper and tails compress
    as window size increases. Median lines are stable.",
    x = "Rainfall (mm, log scale)",
    y = NULL
  ) +
  feat_theme +
  theme(
    legend.position = "none",
    panel.grid.major.y = element_blank()
  )
```

The density plots in @fig-signal-extraction make the smoothing effect immediately apparent. The raw daily distribution is severely right-skewed with a long tail reaching into the hundreds of millimetres, a consequence of the extreme kurtosis documented in @sec-eda. The 3-day moving average begins to suppress this variance, and the 7-day average produces a substantially more concentrated distribution whose peak is considerably higher and whose tails are dramatically shorter.

Quantitatively (@fig-variance-reduction), the standard deviation of rainfall intensity falls from 13.1 mm in the raw series to 5.8 mm under the 7-day average, a reduction of 56%. The ridgeline plot (@fig-ma-ridgeline) confirms that this compression is not an artefact of the summary statistic: the entire shape of the distribution tightens, with the median remaining stable across windows while the spread narrows. The 7-day average can therefore be interpreted as a measure of the prevailing weekly wetness regime, a smoothed characterisation of whether the preceding week has been generally wet or dry rather than a reflection of any single day's unpredictability.

### Multicollinearity Trade-off

```{r}
#| label: fig-ma-correlation
#| fig-cap: "Spearman correlations between raw rainfall and humidity variables and their moving average counterparts. The high within-variable correlations (upper-left and lower-right blocks) confirm that including multiple windows of the same variable in a linear model would produce a near-singular design matrix."
#| fig-width: 8
#| fig-height: 7
#| echo: true
#| warning: false

cor_data <- ma_data %>%
  select(
    rainfall,
    rainfall_ma3,
    rainfall_ma7,
    humidity3pm,
    humidity_ma3,
    humidity_ma7
  ) %>%
  cor(use = "complete.obs", method = "spearman") %>%
  as.data.frame() %>%
  rownames_to_column("var1") %>%
  pivot_longer(-var1, names_to = "var2", values_to = "correlation") %>%
  mutate(
    var1 = factor(
      var1,
      levels = c(
        "rainfall",
        "rainfall_ma3",
        "rainfall_ma7",
        "humidity3pm",
        "humidity_ma3",
        "humidity_ma7"
      )
    ),
    var2 = factor(
      var2,
      levels = c(
        "rainfall",
        "rainfall_ma3",
        "rainfall_ma7",
        "humidity3pm",
        "humidity_ma3",
        "humidity_ma7"
      )
    )
  )

ggplot(cor_data, aes(var2, var1, fill = correlation)) +
  geom_tile(colour = "white", linewidth = 0.8) +
  geom_text(
    aes(label = sprintf("%.2f", correlation)),
    size = 3.2,
    colour = "grey15",
    fontface = "plain"
  ) +
  scale_fill_gradient2(
    low = "#2166AC",
    mid = "white",
    high = "#B2182B",
    midpoint = 0,
    limits = c(-1, 1),
    name = "Spearman\nr"
  ) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  labs(
    title = "Correlations: Raw Variables vs. Moving Averages",
    subtitle = "High within-variable correlations warn of multicollinearity for linear model families.",
    x = NULL,
    y = NULL
  ) +
  feat_theme +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_blank(),
    legend.position = "right",
    legend.key.height = unit(1.1, "cm"),
    legend.key.width = unit(0.4, "cm")
  )
```

The noise-reduction benefit of moving averages comes at a cost. As shown in @fig-ma-correlation, the 3-day and 7-day humidity moving averages share a Spearman correlation of 0.89, and the equivalent rainfall moving averages are similarly collinear with each other and with the raw series. Including multiple moving average windows alongside their source variables in the same linear model would produce a near-singular design matrix, inflating coefficient standard errors and making the model numerically unstable.

This presents a choice between responsiveness and stability. The 3-day average reacts more quickly to changing conditions but retains more of the day-to-day variability. The 7-day average is more stable but slower to reflect recent changes in the weather regime. For linear model families such as logistic regression, only one window can be safely retained per variable; including both is not viable. For tree-based models such as Random Forest and Gradient Boosting, this constraint does not apply, since these methods select among correlated features at each split rather than inverting the full covariance matrix. The moving average selection strategy therefore depends on the model family, a consideration that informs the variable selection carried out in the subsequent modelling chapter.

---

---

## Feature Engineering Pipeline

The following pipeline implements the complete set of features motivated by the EDA. Each transformation is annotated to its originating empirical finding.

```{r}
#| label: feature-engineering
#| echo: true
#| message: false
#| warning: false

compass_lookup <- c(
  "N" = 0,
  "NNE" = 22.5,
  "NE" = 45,
  "ENE" = 67.5,
  "E" = 90,
  "ESE" = 112.5,
  "SE" = 135,
  "SSE" = 157.5,
  "S" = 180,
  "SSW" = 202.5,
  "SW" = 225,
  "WSW" = 247.5,
  "W" = 270,
  "WNW" = 292.5,
  "NW" = 315,
  "NNW" = 337.5
)

df_final <- df_final %>%
  group_by(location) %>%
  arrange(date) %>%
  mutate(
    # Lag the rolling window by one additional day to prevent same-day leakage
    rainfall_ma7 = lag(
      rollmean(rainfall, k = 7, fill = NA, align = "right"),
      n = 1
    ),
    humidity_ma7 = lag(
      rollmean(humidity3pm, k = 7, fill = NA, align = "right"),
      n = 1
    ),

    # Dry spell counter
    rain_event_id = cumsum(lag(rainfall, 1) > 0),
    days_since_rain = row_number() - match(rain_event_id, rain_event_id),

    # First-order Markov state
    rain_yesterday = lag(rain_today, n = 1)
  ) %>%
  ungroup() %>%
  filter(!is.na(rain_yesterday), !is.na(rainfall_ma7)) %>%
  select(-rain_event_id) %>%
  mutate(
    # Cyclical annual encoding
    day_of_year = yday(date),
    day_sin = sin(2 * pi * day_of_year / 365),
    day_cos = cos(2 * pi * day_of_year / 365),

    # Mean-centred interaction term (the "Rain Corner")
    sunshine = as.numeric(scale(sunshine, center = TRUE, scale = FALSE)),
    humidity3pm = as.numeric(scale(humidity3pm, center = TRUE, scale = FALSE)),
    sun_humid_interaction = as.numeric(sunshine * humidity3pm),

    # Meteorological derived indices
    pressure_change = pressure3pm - pressure9am,
    dewpoint_9am = temp9am - ((100 - humidity9am) / 5),
    dewpoint_3pm = temp3pm - ((100 - humidity3pm) / 5),
    dewpoint_change = dewpoint_3pm - dewpoint_9am,
    moisture_index = humidity3pm * (1 - sunshine / 15),
    instability_index = (1020 - pressure3pm) * humidity3pm / 100,
    cloud_development = pmax(0, cloud3pm - cloud9am),

    # Circular wind vector decomposition
    gust_rad = compass_lookup[wind_gust_dir] * pi / 180,
    gust_V_NS = wind_gust_speed * cos(gust_rad),
    gust_U_EW = wind_gust_speed * sin(gust_rad),
    wind9am_rad = compass_lookup[wind_dir9am] * pi / 180,
    wind9am_V_NS = wind_speed9am * cos(wind9am_rad),
    wind9am_U_EW = wind_speed9am * sin(wind9am_rad)
  ) %>%
  relocate(rain_today, date, location) %>%
  relocate(rain_yesterday, days_since_rain, .after = location) %>%
  relocate(ends_with("_ma7"), .after = days_since_rain) %>%
  relocate(day_sin, day_cos, .after = date)
```

The pipeline is organised into four conceptually distinct transformations, each addressing a specific structural property identified in the EDA.

### Cyclical Encoding of Seasonality

The seasonal analysis established that rainfall frequency and intensity follow a smooth annual cycle: summer events are rarer but more intense, winter events are more frequent but lighter, and the transition months connect these poles continuously. Treating month as a standard integer (1 through 12) would incorrectly imply that January and December are maximally distant on the number line, when in reality they are climatologically adjacent. Treating it as an unordered factor imposes no such adjacency constraint but discards ordinal information entirely.

The appropriate solution is to represent the annual cycle as a point on the unit circle, decomposed into its sine and cosine components:

$$\text{day\_sin} = \sin\!\left(\frac{2\pi \cdot \text{day\_of\_year}}{365}\right), \quad \text{day\_cos} = \cos\!\left(\frac{2\pi \cdot \text{day\_of\_year}}{365}\right)$$

Together, these two features encode any day of the year as a unique coordinate on the unit circle. The distance between any two days in this space reflects their true circular proximity: the December-to-January transition corresponds to a small arc, not a large jump. The model can learn smooth seasonal effects directly from the geometry of this representation.

### Temporal Persistence Features

The Markov Chain analysis (@sec-markov) demonstrated that the previous day's rain state carries a moderate but meaningful signal ($V \approx 0.31$), and the dry spell analysis showed that the probability of rain decays in a non-linear pattern as dry spells lengthen. Three features capture these dynamics.

`rain_yesterday` is a direct binary indicator of the previous day's state, encoding the first-order Markov transition as a predictor. `days_since_rain` counts the number of consecutive dry days preceding the current observation, capturing the progressive stabilisation of dry conditions that the logistic regression and spline analysis identified. `rainfall_ma7` and `humidity_ma7` provide a smoothed weekly context for both the rainfall and moisture signals, lagged by one additional day beyond the rolling window to ensure that no same-day information is included when predicting today's outcome.

The lagging step deserves emphasis. Without it, the 7-day moving average at time $t$ includes the observation at time $t$ itself, meaning a model trained on this feature would have access to the value it is trying to predict. This form of data leakage produces artificially optimistic training metrics that do not generalise to deployment, where future observations are unavailable by definition.

### Physical Interaction and Derived Indices

The bivariate density analysis (@sec-bivariate-density) identified a qualitative difference in the joint distribution of humidity and sunshine between rainy and dry days: rain occurs almost exclusively when afternoon humidity is high and sunshine hours are low simultaneously, the "Rain Corner" phenomenon. An additive model cannot represent this conditional structure; a multiplicative interaction term is required.

Prior to computing the interaction, both `sunshine` and `humidity3pm` are mean-centred by subtracting their grand means. This is not merely a cosmetic step. When an interaction term is formed from un-centred variables, the resulting product is algebraically correlated with both main effects, inflating the VIF of all three terms and making their individual coefficients difficult to interpret. Centring removes this artificial correlation: the main effects then represent the effect of each variable at the average level of the other, and the interaction term represents the additional effect of their joint deviation from those averages. This is confirmed empirically in the VIF diagnostics in Section 3.

Beyond the interaction term, five derived meteorological indices are constructed from physically motivated combinations of the available variables. The dewpoint temperatures at 9:00 AM and 3:00 PM, computed from the Magnus approximation $T_d \approx T - \frac{100 - RH}{5}$, represent the temperature at which the air would become saturated if cooled at constant pressure. The change in dewpoint across the day (`dewpoint_change`) measures whether the atmosphere is gaining or losing moisture over the course of the day, a signal not directly recoverable from temperature or humidity alone. The `moisture_index` encodes the combined effect of high humidity and limited solar exposure. The `instability_index` combines pressure deficit from the standard 1020 hPa baseline with humidity, approximating the atmospheric conditions that favour convective development. `cloud_development` captures upward cloud formation during the day, which the pressure analysis identified as a meaningful precursor to precipitation.

### Circular Wind Vector Decomposition

Wind direction is a circular variable: 360 degrees and 0 degrees represent the same direction (due North), yet a naive numeric encoding would treat them as maximally distant. This misrepresentation is particularly consequential for wind because the directional origin of an air mass carries meaningful physical content: moisture-laden northerly flows behave very differently from dry southerly flows in the Australian context.

The standard solution is to decompose each directional reading into orthogonal Cartesian components by projecting the wind vector onto the north-south and east-west axes:

$$U_{EW} = v \cdot \sin(\theta), \quad V_{NS} = v \cdot \cos(\theta)$$

where $v$ is wind speed (in km/h) and $\theta$ is the compass bearing in radians. The resulting U and V components are continuous and interpretable: a purely northerly wind of 20 km/h produces $V_{NS} = 20$, $U_{EW} = 0$; a purely easterly wind of the same speed produces $V_{NS} = 0$, $U_{EW} = 20$. This transformation is applied to both the peak gust and the 9:00 AM wind observations, yielding four wind component features in total.

---

## Multicollinearity Diagnostics

```{r}
#| label: multicollinearity-check
#| echo: true
#| message: false
#| warning: false

write_csv(df_final, "data/df_engineered.csv")

df_wo_location <- select_model_features(df_final, keep_location = FALSE)
vif_results <- mc_check(df_wo_location)

vif_results %>%
  as_tibble() %>%
  arrange(desc(VIF)) %>%
  kable(
    caption = "Variance Inflation Factor (VIF) for Selected Predictors",
    digits = 3,
    booktabs = TRUE
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    latex_options = c("hold_position")
  )

df_scaled <- df_wo_location %>%
  scale_data()

write_csv(df_scaled, "data/df_scaled.csv")
```

Feature engineering that introduces interaction terms, composite indices, and temporal aggregates necessarily creates new correlational structure in the design matrix. After constructing the full feature set, it is essential to verify that no predictor has become so collinear with the others that its coefficient in a linear model would be effectively unidentifiable. We use the Variance Inflation Factor (VIF) for this diagnosis. The VIF for a given predictor quantifies how much its coefficient variance is inflated relative to what it would be in an orthogonal design: a VIF of $k$ indicates that the standard error of that coefficient is $\sqrt{k}$ times larger than it would be if the predictor were uncorrelated with all others. Values above 10 are conventionally treated as indicating severe collinearity requiring remediation.

**Cyclical and wind components.** The `day_sin`, `day_cos`, `gust_V_NS`, and `gust_U_EW` features all show VIF values well below 3. This confirms that the decomposition strategies, sine/cosine for the annual cycle and U/V projection for wind direction, successfully converted circular variables into continuous representations without introducing redundancy. Each component carries information that is approximately orthogonal to its pair.

**Interaction stability.** The `sun_humid_interaction` term has a VIF of 1.182, which is exceptionally low for a multiplicative interaction. Without mean-centring the constituent variables before multiplication, interaction terms routinely exhibit VIFs above 10 due to their algebraic overlap with the main effects. The observed value of 1.182 provides empirical confirmation that centring eliminated this artificial correlation, and that the interaction term is capturing a genuinely distinct dimension of the feature space, the joint Rain Corner structure identified in @sec-bivariate-density.

**Elevated collinearity in humidity.** The highest observed VIF is for `humidity3pm` at approximately 4.841. This is expected: humidity participates structurally in three of the derived features (`moisture_index`, `instability_index`, and `sun_humid_interaction`), and its 7-day moving average is also present in the feature set. A VIF of 5 lies below the conventional threshold of 10 for severe concern and is consistent with what the literature describes as moderate collinearity. The decision to retain `humidity3pm` despite this inflation is deliberate: it is the single strongest individual predictor of rainfall in the dataset (Spearman $r = 0.44$, as established in @sec-eda), and removing it in favour of its derived aggregates would sacrifice the direct same-day atmospheric moisture signal for the sake of a marginal improvement in collinearity. For tree-based models, this trade-off does not arise, since these methods are not sensitive to multicollinearity by design.

**Overall assessment.** The full engineered feature set is numerically stable for use in linear model families. No VIF exceeds the critical threshold of 10, and the majority of features show values below 3. The pipeline has successfully converted the raw meteorological signals into a representation that is both physically interpretable and statistically well-conditioned for the modelling stage.
