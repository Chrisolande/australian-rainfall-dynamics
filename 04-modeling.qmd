# Modelling

In this chapter, we progressively build our statistical framework, starting from a null baseline and adding layers of physical complexity. We utilize **Zero-Inflated Gamma (ZIG)** models to handle the dual nature of rainfall data (probability of occurrence vs. intensity).

```{r}
#| label: setup-modeling
#| include: false

librarian::shelf(
  tidyverse,
  glmmTMB,
  sjPlot,
  DHARMa,
  kableExtra,
  gtsummary,
  lmtest,
  performance,
  gt,
  splines,
  pROC,
  here
)

df_scaled <- read_csv(here::here("data", "df_scaled.csv"))
df_final  <- read_csv(here::here("data", "df_engineered.csv"))

source(here::here("utils.R"))

if (file.exists(here::here("models/all_models_bundle.RData"))) {
  load(here::here("models/all_models_bundle.RData"))
}
```

## Establishing the Baseline (Null Model)

```{r}
#| label: null-model-fit
#| echo: true
#| message: false
#| eval: false

m0_null <- glmmTMB(
  formula   = rainfall ~ 1,
  ziformula = ~1,
  family    = Gamma(link = "log"),
  data      = df_scaled
)
```

```{r}
#| label: null-model-output

tab_model(
  m0_null,
  show.se        = TRUE,
  show.aic       = TRUE,
  transform      = "exp",
  collapse.se    = TRUE,
  p.style        = "numeric_stars",
  string.pred    = "Parameter",
  string.est     = "Estimate (Exp)",
  dv.labels      = "Baseline Rainfall Model",
  title          = "Table 1: Baseline Zero-Inflated Gamma Model (Intercept Only)"
)
```

To quantify the value added by our meteorological predictors, we first fitted a **"Null" Zero-Inflated Gamma model**. This model contains no predictors; it consists solely of intercepts. Its purpose is to verify if the model structure correctly recovers the fundamental properties of the dataset.

**1. Zero-Inflation Component (The "Hurdle"):** The zero-inflation intercept is $\beta_{zi} = 0.5769$. Back-transforming via the logit link:

$$P(\text{Dry}) = \frac{e^{0.5769}}{1 + e^{0.5769}} \approx 64.03\%$$

**Insight:** This model-derived probability matches the empirical zero-inflation rate ($64.05\%$) from our EDA perfectly, confirming the model is correctly calibrated.

**2. Conditional Component (Gamma Intensity):** The conditional intercept is $\beta_{cond} = 1.8825$, recovering:

$$\mu_{\text{rain}} = e^{1.8825} \approx 6.57 \text{ mm}$$

**3. Performance Baseline:** AIC = 461,669.7. Any subsequent model must achieve a significantly lower AIC to demonstrate predictive power.

## Moisture Dynamics

```{r}
#| label: m1-moisture-code
#| echo: true
#| eval: false

m1_moisture <- update(
  m0_null,
  . ~ . + humidity3pm + dewpoint_9am + dewpoint_change + pressure_change,
  ziformula = ~ humidity3pm + dewpoint_9am
)
```

```{r}
#| label: m1-moisture-output
#| echo: false

m1_moisture %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      humidity3pm    ~ "Humidity (3pm)",
      dewpoint_9am   ~ "Dewpoint (9am)",
      dewpoint_change ~ "Dewpoint Change (Delta)",
      pressure_change ~ "Pressure Change (Delta)"
    )
  ) %>%
  bold_p() %>%
  add_glance_table(include = c("AIC", "BIC", "logLik")) %>%
  modify_header(label = "**Predictor**") %>%
  modify_caption("**Model 1: Moisture & Pressure Dynamics**")
```

Building upon the baseline, Model 1 incorporates the primary moisture and pressure drivers identified in EDA. We test the hypothesis that atmospheric moisture (`humidity`, `dewpoint`) and pressure stability (`pressure_change`) drive both the occurrence and intensity of rainfall.

**1. Performance:** AIC dropped from 461,669.7 to 422,847 — a reduction of $\Delta AIC \approx 38,823$, confirming that moisture dynamics are foundational predictors.

**2. Conditional Model:** All predictors are statistically significant ($p < 2e^{-16}$). `humidity3pm` ($\beta = 0.38$) and `dewpoint_9am` ($\beta = 0.38$) both have strong positive effects on intensity.

**3. Zero-Inflation Model:** `humidity3pm` coefficient is **-1.07** — a negative value here means higher humidity *decreases* the probability of a dry day, i.e., increases the probability of rain. Notably, `dewpoint_9am` is not significant in the zero-inflation part ($p = 0.907$), implying that *relative* saturation (humidity) determines *if* it rains, while *absolute* moisture (dewpoint) determines *how hard*.

## Temporal Dynamics and Persistence

```{r}
#| label: m2-temporal-code
#| echo: true
#| eval: false

m2_temporal <- update(
  m1_moisture,
  . ~ . + day_cos + day_sin,
  ziformula = ~ humidity3pm +
    dewpoint_9am +
    rain_yesterday +
    cloud_development +
    pressure_change
)
```

```{r}
#| label: m2-temporal-output
#| echo: false

m2_temporal %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      day_cos          ~ "Seasonality (Cos)",
      day_sin          ~ "Seasonality (Sin)",
      rain_yesterday   ~ "Rain Yesterday (Persistence)",
      cloud_development ~ "Cloud Development",
      pressure_change  ~ "Pressure Change"
    )
  ) %>%
  bold_p() %>%
  add_glance_table(include = c("AIC", "BIC")) %>%
  modify_header(label = "**Predictor**") %>%
  modify_caption("**Model 2: Temporal & Persistence Effects**")
```

Model 2 incorporates **seasonality** (cyclical encoding) and **persistence** (Markov chains), as well as dynamic zero-inflation drivers like `cloud_development` and `pressure_change`.

**1. Performance:** AIC = 406,659 ($\Delta AIC \approx 16,187$ vs M1), confirming that knowing *when* in the year and *what happened yesterday* provides critical predictive information.

**2. Seasonality:** Both `day_cos` and `day_sin` are highly significant, mathematically confirming the "Summer Peak" pattern.

**3. The "Persistence" Effect:** `rain_yesterdayYes` ($\beta = -1.42$) is the strongest predictor in the zero-inflation model. $\exp(-1.42) \approx 0.24$ — if it rained yesterday, the odds of today being dry drop by ~76%.

## Historical Context and Persistence

```{r}
#| label: m3-history-code
#| echo: true
#| eval: false

m3_history <- update(
  m2_temporal,
  . ~ . + rainfall_ma7 + days_since_rain + humidity_ma7 + rain_yesterday,
  ziformula = ~ humidity3pm +
    dewpoint_9am +
    rain_yesterday +
    cloud_development +
    pressure_change
)
```

```{r}
#| label: m3-history-output
#| echo: false

m3_history %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      rainfall_ma7    ~ "Rainfall Trend (7-Day MA)",
      humidity_ma7    ~ "Humidity Trend (7-Day MA)",
      days_since_rain ~ "Dry Spell Length (Days)",
      rain_yesterday  ~ "Rain Yesterday (Indicator)"
    )
  ) %>%
  bold_p() %>%
  add_glance_table(include = c("AIC", "BIC")) %>%
  modify_header(label = "**Predictor**") %>%
  modify_caption("**Model 3: Historical Trends & Lagged Effects**")
```

Model 3 integrates **history** — recent weather trends — to capture how the atmosphere's accumulated state affects today's rainfall intensity.

**1. Performance:** AIC = 404,936.2 ($\Delta AIC \approx 1,723$ vs M2) — meaningful improvement with diminishing returns compared to earlier leaps.

**2. Key Findings:**

- `rain_yesterday` ($\beta = 0.31$): If it rained yesterday, today's rainfall is likely ~37% more intense ($e^{0.31} \approx 1.36$).
- `rainfall_ma7` ($\beta = 0.13$): A wetter preceding week correlates with heavier rainfall today.
- `humidity_ma7` ($\beta = -0.10$): A persistently humid week may indicate stable, low-intensity stratiform clouds rather than convective storms.
- `days_since_rain`: **Not significant** for intensity ($p = 0.14$) — dry spell length predicts *whether* it rains, not *how much*.

## Energy Dynamics and Interactions

```{r}
#| label: m4-energy-code
#| echo: true
#| eval: false

m4_energy <- update(
  m3_history,
  . ~ . +
    sunshine +
    evaporation +
    instability_index +
    sun_humid_interaction +
    cloud_development,
  ziformula = ~ humidity3pm +
    dewpoint_9am +
    rain_yesterday +
    cloud_development +
    pressure_change
)
```

```{r}
#| label: m4-energy-output
#| echo: false

m4_energy %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      sunshine             ~ "Sunshine Duration (Hours)",
      evaporation          ~ "Evaporation Rate",
      instability_index    ~ "Instability Index (Derived)",
      sun_humid_interaction ~ "Interaction: Sun * Humid",
      cloud_development    ~ "Cloud Development (Delta)"
    )
  ) %>%
  bold_p() %>%
  add_glance_table(include = c("AIC", "BIC")) %>%
  modify_header(label = "**Predictor**") %>%
  modify_caption("**Model 4: Thermodynamic Energy & Interactions**")
```

Model 4 incorporates **energy dynamics** (solar radiation, evaporation) and **atmospheric instability**, including the non-linear "Rain Corner" interaction term.

**1. Performance:** AIC = 403,051.8 ($\Delta AIC \approx 1,884$ vs M3).

**2. The "Rain Corner" Interaction:** `sun_humid_interaction` ($\beta = -0.08$) is highly significant — the heaviest rain occurs when humidity is high *and* sunshine is low (deep cloud cover).

**3. Shift in Humidity Importance:** `humidity3pm` dropped from 0.39 (M3) to 0.08 (M4). This is not a loss of importance — the variance has been correctly partitioned into `instability_index` and `sun_humid_interaction`. The model now understands *why* humidity matters.

## Wind Dynamics

```{r}
#| label: m5-wind-code
#| echo: true
#| eval: false

m5_wind <- update(
  m4_energy,
  . ~ . + gust_U_EW + gust_V_NS + wind9am_V_NS + wind9am_U_EW,
  ziformula = ~ humidity3pm +
    dewpoint_9am +
    rain_yesterday +
    cloud_development +
    pressure_change
)
```

```{r}
#| label: m5-wind-output
#| echo: false

m5_wind %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      gust_U_EW    ~ "Gust Vector (East-West)",
      gust_V_NS    ~ "Gust Vector (North-South)",
      wind9am_U_EW ~ "Wind 9am Vector (East-West)",
      wind9am_V_NS ~ "Wind 9am Vector (North-South)"
    )
  ) %>%
  bold_p() %>%
  add_glance_table(include = c("AIC", "BIC")) %>%
  modify_header(label = "**Predictor**") %>%
  modify_caption("**Model 5: Wind Vector Dynamics**")
```

Model 5 introduces **Wind Vector Decomposition** into North-South ($V$) and East-West ($U$) components, testing whether specific airflow origins drive rainfall intensity.

**1. Performance:** AIC = 402,452.7 ($\Delta AIC \approx 600$ vs M4) — smaller but still highly significant.

**2. Physical Interpretation:**

- `wind9am_V_NS` ($\beta = -0.088$): Southerly winds (negative $V$) increase rainfall — validating "Southerly Busters" from the Southern Ocean.
- `wind9am_U_EW` ($\beta = -0.085$): Westerly winds (negative $U$) increase rainfall — capturing the "Roaring Forties."
- Morning winds have coefficients ~3–4x larger than gusts, confirming that **prevailing air mass direction** matters more than localized turbulence.

**3. Model Stability:** Coefficients for previous drivers remained stable, confirming wind vectors explain *new* variance rather than displacing existing predictors.

## Spatial Heterogeneity (Mixed Effects)

```{r}
#| label: m6-mixed-code
#| echo: true
#| eval: false

re_data <- select_model_features(df_final, keep_location = TRUE) %>%
  scale_data()

ctrl <- glmmTMBControl(
  optimizer = optim,
  optArgs   = list(method = "BFGS"),
  optCtrl   = list(maxit = 1000)
)

m6_mixed <- glmmTMB(
  rainfall ~
    humidity3pm + dewpoint_9am + dewpoint_change + pressure_change +
    day_cos + day_sin +
    rainfall_ma7 + days_since_rain + humidity_ma7 + rain_yesterday +
    sunshine + evaporation + instability_index + sun_humid_interaction +
    cloud_development +
    gust_U_EW + gust_V_NS + wind9am_V_NS + wind9am_U_EW +
    diag(1 + humidity3pm + rain_yesterday + dewpoint_change | location),
  ziformula = ~ humidity3pm + dewpoint_9am + rain_yesterday +
    cloud_development + pressure_change + sunshine + evaporation +
    ns(days_since_rain, df = 4) + humidity_ma7 + day_cos + day_sin,
  data    = re_data,
  control = ctrl,
  family  = ziGamma(link = "log")
)
```

```{r}
#| label: m6-mixed-output
#| echo: false

m6_mixed %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      humidity3pm              ~ "Humidity (3pm)",
      sunshine                 ~ "Sunshine Duration",
      sun_humid_interaction    ~ "Interaction: Sun * Humid",
      rainfall_ma7             ~ "Rainfall Trend (7-Day MA)",
      days_since_rain          ~ "Dry Spell Length (Linear)",
      rain_yesterday           ~ "Rain Yesterday (Indicator)",
      gust_U_EW                ~ "Gust Vector (East-West)",
      gust_V_NS                ~ "Gust Vector (North-South)",
      instability_index        ~ "Instability Index",
      day_cos                  ~ "Seasonality (Cos)",
      day_sin                  ~ "Seasonality (Sin)"
    )
  ) %>%
  bold_p() %>%
  add_glance_table(include = c("AIC", "BIC", "logLik", "nobs")) %>%
  modify_header(label = "**Predictor**") %>%
  modify_caption("**Model 6: The Final Mixed-Effects Model (Random Slopes)**") %>%
  as_gt() %>%
  gt::tab_footnote(
    footnote = "Random Effects Structure: Uncorrelated random slopes for Humidity, Persistence, and Dewpoint by Location."
  )
```

The final model addresses the hierarchical nature of the data by introducing **Random Effects**, allowing parameters to vary by `location`.

**1. Performance:** AIC = 394,854.0 ($\Delta AIC \approx 7,599$ vs M5) — a massive improvement confirming that **spatial heterogeneity** is a dominant source of variance.

**2. Random Effects Structure:**

- **Random Intercepts** ($\sigma^2 = 0.12$): Baseline rainfall varies significantly between locations.
- **Random Slope — Humidity** ($\sigma^2 = 0.023$): The effect of humidity on rainfall differs by location.
- **Random Slope — Persistence** ($\sigma^2 = 0.013$): The "stickiness" of wet weather varies spatially.

**3. Fixed Effects Stability:** Wind Vectors, Instability, and the "Rain Corner" interaction all remained highly significant globally — these are robust, continent-wide drivers.

**4. Splines in Zero-Inflation:** `ns(days_since_rain, df=4)` allows the probability of a dry spell ending to vary non-linearly, capturing the complex "kink" observed in dry spell survival plots.
