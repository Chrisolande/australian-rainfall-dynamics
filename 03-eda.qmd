
# Exploratory Data Analysis {#sec-eda}
## Temporal and Meteorological Drivers of Australian Rainfall

---

> **Study Context.** This analysis investigates the distributional and structural properties of daily rainfall data collected across Australian weather stations. The findings reported here directly inform the feature engineering and model architecture decisions made in subsequent modelling stages.

---

```{r}
#| label: setup-eda
#| include: false

librarian::shelf(
  tidyverse,
  janitor,
  kableExtra,
  ggridges,
  here,
  rstatix,
  moments,
  cocor,
  broom,
  aod,
  multcompView,
  scales,
  patchwork
)


df_clean <- readRDS(here::here("data", "df_clean.rds"))
df_final <- read_csv(here::here("data", "df_final.csv"))

source(here::here("utils.R"))
```


## Data Quality and Missingness

Before any substantive analysis can proceed, a thorough audit of data completeness is necessary. Modelling decisions made in response to missing data have cascading consequences for statistical validity.

```{r}
#| label: missing-values
#| echo: true
#| message: false
#| warning: false

total_na <- sum(is.na(df_clean))
print(paste("Total Missing values:", total_na))

missing_val(df_clean)
```

The dataset contains 314,146 missing entries in total, but the distribution of this missingness is highly uneven across features and carries interpretable meaning.

The most severely affected variables are `sunshine` (47.7% missing) and `evaporation` (42.5% missing). Both require specialised instrumentation, sunshine recorders and evaporation pans, that are not uniformly deployed across all weather stations in the network. Their missingness is therefore not random with respect to geography, which means simple listwise deletion (discarding any row containing a missing value) would eliminate nearly half the dataset and introduce a systematic geographic bias toward well-resourced stations. Cloud cover observations (`cloud3pm` and `cloud9am`) are missing in approximately 37–40% of records, consistent with the same station-coverage explanation.

By contrast, the core dynamic variables; pressure, wind speed, and temperature exhibit missingness below 10%. These instruments are standard across virtually all monitoring stations.

**Modelling implication.** The concentration of missingness in potentially predictive features (sunshine and evaporation both exhibit meaningful correlation with rainfall, as shown in @sec-correlation) creates a direct conflict: discarding these variables avoids imputation complexity but sacrifices predictive signal, while discarding rows sacrifices sample size and introduces bias. This finding provides the empirical justification for the **Random Forest imputation strategy** adopted in this study. Imputation preserves both the sample and the features, at the cost of introducing uncertainty that should be acknowledged in downstream inference.

---

## Distributional Properties of the Target Variable

Understanding the marginal distribution of the response variable is a prerequisite for selecting an appropriate model family. A Gaussian assumption, for instance, is not merely a computational convenience it carries substantive claims about the data-generating process.

```{r}
#| label: target-stats
#| echo: true
#| message: false
#| warning: false

rainfall_stats <- df_clean %>%
  summarise(
    n = n(),
    mean = mean(rainfall),
    median = median(rainfall),
    sd = sd(rainfall),
    min = min(rainfall),
    max = max(rainfall),
    q25 = quantile(rainfall, 0.25),
    q75 = quantile(rainfall, .75),
    iqr = IQR(rainfall),
    n_zeros = sum(rainfall == 0),
    pct_zeros = mean(rainfall == 0) * 100,
    n_large = sum(rainfall > 100),
    pct_large = mean(rainfall > 100) * 100,
    skewness = moments::skewness(rainfall),
    kurtosis = moments::kurtosis(rainfall)
  )

rainfall_stats %>%
  pivot_longer(everything(), names_to = "Statistic", values_to = "Value") %>%
  mutate(
    Value = ifelse(
      Value > 1000,
      format(Value, scientific = TRUE, digits = 3),
      round(Value, 3)
    )
  ) %>%
  kable(
    caption = "Descriptive Statistics: Daily Rainfall (mm)",
    align = "lr"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

rain_check <- df_clean %>%
  summarise(
    total_days = n(),
    dry_days = sum(rainfall == 0),
    rainy_days = sum(rainfall > 0),
    zero_inflation_pct = (dry_days / total_days) * 100
  )

rain_check %>%
  kable(
    caption = "Prevalence of Zero-Inflation (Dry Days)",
    col.names = c(
      "Total Days",
      "Dry Days (0mm)",
      "Rainy Days (>0mm)",
      "Zero Inflation (%)"
    )
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "bordered"),
    full_width = FALSE
  )
```

The descriptive statistics reveal a distribution that is fundamentally incompatible with standard Gaussian modelling assumptions.

**Zero-inflation.** The most consequential property is that 64.05% of the 142,199 recorded observations are dry days (rainfall = 0 mm). The median is zero. This is not a quirk of rounding or encoding: the data-generating mechanism genuinely produces two qualitatively different outcomes, no rain falling at all, versus some positive amount of rain falling. Any model that treats the response as a single continuous variable will be forced to place probability mass on negative values and will systematically misestimate the probability of the zero outcome.

**Heavy tails.** Among the non-zero observations, the distribution is severely right-skewed (skewness = 9.84). The standard deviation (8.48 mm) is nearly four times the mean (2.36 mm), indicating that the "average" is being pulled by a small number of extreme events. Kurtosis of 181.15 compared to 3 for a normal distribution confirms that such extremes occur far more frequently than a Gaussian model would predict. The maximum recorded value is 371 mm, and 151 events exceed 100 mm.

**Modelling implication.** The conjunction of zero-inflation and extreme positive skew means that a single-component model is insufficient. The data implicitly poses two separate questions: **Does rain occur?** (a binary classification problem) and **Given that it does, how much falls?** (a positive continuous regression problem). This motivates the **Hurdle Model** or **Zero-Inflated Gamma** framework adopted in subsequent analysis, which explicitly separates these two sub-problems rather than conflating them.

---

## Bivariate Correlation Structure {#sec-correlation}

With the distributional properties established, we next examine the linear and monotonic relationships between the candidate predictors and the rainfall response. Because rainfall is heavily skewed and the relationships are unlikely to be linear, Spearman rank correlation is used throughout a non-parametric measure that captures monotonic association without requiring linearity or normality.

```{r}
#| label: correlation-table
#| echo: true
#| message: false
#| warning: false

numeric_cols <- df_clean %>%
  select(where(is.numeric)) %>%
  names()
numeric_cols <- numeric_cols[numeric_cols != "rainfall"]

cors <- df_clean %>%
  rstatix::cor_test(
    vars = "rainfall",
    vars2 = numeric_cols,
    method = "spearman"
  ) %>%
  filter(!is.na(cor)) %>%
  arrange(desc(abs(cor))) %>%
  dplyr::select(var2, cor, p) %>%
  mutate(
    interpretation = case_when(
      abs(cor) < 0.1 ~ "Negligible",
      abs(cor) < 0.3 ~ "Small",
      abs(cor) < 0.5 ~ "Moderate",
      TRUE ~ "Large"
    )
  )

cors %>%
  kable(
    caption = "Spearman Correlation with Rainfall (Ranked by Strength)",
    col.names = c("Predictor", "Correlation (r)", "P-Value", "Strength")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r}
#| label: fig-correlation-matrix
#| fig-cap: "Spearman Correlation Matrix of Meteorological Features. Red indicates negative correlation; Blue indicates positive correlation."
#| fig-width: 10
#| fig-height: 8
#| echo: true
#| warning: false

cor_matrix <- df_clean %>%
  select(where(is.numeric)) %>%
  cor(use = "pairwise.complete.obs", method = "spearman")

cor_melt <- cor_matrix %>%
  as.data.frame() %>%
  rownames_to_column(var = "Var1") %>%
  pivot_longer(cols = -Var1, names_to = "Var2", values_to = "Correlation")

cor_melt %>%
  ggplot(aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "#D73027",
    mid = "white",
    high = "#4575B4",
    midpoint = 0,
    limit = c(-1, 1),
    name = "Spearman\nCorrelation"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, size = 10, hjust = 1),
    axis.text.y = element_text(size = 10),
    axis.title = element_blank(),
    panel.grid.major = element_blank(),
    legend.position = "right"
  ) +
  geom_text(
    data = filter(cor_melt, abs(Correlation) > 0.3),
    aes(label = round(Correlation, 2)),
    color = "black",
    size = 3
  ) +
  labs(
    title = "Feature Correlation Matrix",
    subtitle = "Strongest predictors: Humidity (Positive) and Sunshine (Negative)"
  )
```

```{r}
#| label: correlation-significance-test
#| echo: true
#| collapse: true

cor_humidity <- cor.test(
  df_clean$rainfall,
  df_clean$humidity3pm,
  method = "spearman"
)
cor_sunshine <- cor.test(
  df_clean$rainfall,
  df_clean$sunshine,
  method = "spearman"
)

cocor_result <- cocor.dep.groups.overlap(
  r.jk = cor_humidity$estimate,
  r.jh = cor_sunshine$estimate,
  r.kh = cor(
    df_clean$humidity3pm,
    df_clean$sunshine,
    use = "complete.obs",
    method = "spearman"
  ),
  n = nrow(df_clean),
  alternative = "two.sided",
  test = "steiger1980",
  return.htest = TRUE
)

print(cocor_result)
```

The correlation analysis reveals two coherent clusters of meteorological drivers, each with a clear physical interpretation.

**Moisture indicators (positive association).** `Humidity3pm` ($r = 0.44$) and cloud cover ($r \approx 0.37$) show the strongest positive associations with rainfall. High afternoon humidity indicates that moisture has accumulated in the lower atmosphere over the course of the day, creating conditions favourable for precipitation. Cloud cover is both a physical precondition for rain and a consequence of the same atmospheric dynamics that generate it.

**Radiation and evaporation indicators (negative association).** `Sunshine` ($r = -0.40$) and `evaporation` ($r = -0.31$) exhibit the strongest negative associations. Long sunshine hours are a proxy for clear-sky, high-pressure conditions in which precipitation is unlikely. High evaporation similarly signals warm, dry, low-humidity surface conditions.

**Multicollinearity.** The correlation heatmap (@fig-correlation-matrix) also reveals substantial redundancy among predictors. The morning and afternoon readings of the same variable are typically highly correlated `pressure9am` and `pressure3pm` share a Spearman correlation of $r = 0.96$, and the two temperature readings are similarly collinear. Including both members of such pairs in a regression model inflates standard errors and destabilises coefficient estimates, a problem known as multicollinearity. This observation directly motivates VIF-based feature selection in the modelling stage.

**Statistical validation.** A formal comparison of the two strongest opposing predictors (humidity and sunshine) using Steiger's Z-test for dependent correlations yields $z \approx 188.9$, $p < 2.2 \times 10^{-16}$. With $N > 140,000$ observations, virtually any non-trivial effect will achieve statistical significance, so the p-value alone is uninformative here. The magnitude of the Z-statistic, however, confirms that the differential predictive strength of these two variables is not a sampling artefact. Humidity and sunshine represent genuinely distinct physical forces operating in opposing directions on the probability of precipitation.

---

## Temporal Structure of Rainfall

### Weekly and Seasonal Frequency {#sec-frequency}

```{r}
#| label: temporal-dist
#| echo: true
#| message: false
#| warning: false

df_clean %>%
  filter(rainfall > 0) %>%
  tabyl(day) %>%
  adorn_pct_formatting() %>%
  arrange(desc(n)) %>%
  kable(
    caption = "Frequency of Rainfall Days by Day of the Week",
    col.names = c("Day", "Count (n)", "Percentage")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

df_clean %>%
  filter(rainfall > 0) %>%
  tabyl(month) %>%
  adorn_pct_formatting() %>%
  arrange(desc(n)) %>%
  kable(
    caption = "Frequency of Rainfall Days by Month",
    col.names = c("Month", "Count (n)", "Percentage")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

df_clean %>%
  filter(rainfall > 0) %>%
  tabyl(month, day) %>%
  adorn_totals(c("row", "col")) %>%
  kable(caption = "Cross-tabulation of Rainfall Frequency: Month vs. Day") %>%
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 11
  ) %>%
  scroll_box(width = "100%")
```

Two temporal scales are examined here: the seven-day weekly cycle (which reflects human activity patterns) and the twelve-month annual cycle (which reflects the Earth's orbital and atmospheric patterns). Their effects on rainfall frequency are qualitatively different.

**Weekly cycle.** The distribution of wet days across the days of the week is approximately uniform, ranging from 13.8% on weekends to 14.7% on Tuesdays. This near-uniformity is physically expected: the atmospheric processes that produce precipitation operate independently of the human social calendar. The slight variation observed is consistent with random sampling noise rather than a systematic signal. This suggests that `Day` carries little predictive information and, at best, warrants treatment as a minor control variable rather than a substantive predictor.

**Annual cycle.** The monthly distribution tells a markedly different story. June (10.7%) and July (10.3%) record the highest frequency of wet days, consistent with the Southern Hemisphere winter, when frontal weather systems from the Southern Ocean bring prolonged rainfall to southern Australia. The summer months February (6.5%) and December (7.0%) record the lowest frequencies. The cross-tabulation of month by day confirms that this seasonal signal is not an artefact of any particular day of the week: June and July show consistently elevated counts across all seven days (roughly 750–800 events per day), while February counts drop uniformly to approximately 450–480 per day. `Month` is thus a legitimate predictor warranting explicit inclusion in the model specification.

### Day-to-Day Persistence: A Markov Chain Analysis {#sec-markov}

```{r}
#| label: markov-prep
#| echo: true
#| message: false
#| warning: false

markov_table <- df_final %>%
  group_by(location) %>%
  arrange(date) %>%
  mutate(yesterday_rain = lag(rain_today)) %>%
  ungroup() %>%
  filter(!is.na(rain_today), !is.na(yesterday_rain)) %>%
  count(yesterday_rain, rain_today)

cont_table <- markov_table %>%
  pivot_wider(names_from = rain_today, values_from = n, values_fill = 0) %>%
  column_to_rownames("yesterday_rain") %>%
  as.matrix()

print(cont_table)
```

```{r}
#| label: markov-stats
#| echo: true
#| collapse: true

chi_result <- chisq_test(as.table(cont_table))
print(chi_result)

cramers_v <- cramer_v(cont_table)

cat("\nEffect Size Interpretation\n")
cat(sprintf("V = %.4f: ", cramers_v))
if (cramers_v < 0.1) {
  cat("Negligible Association\n")
} else if (cramers_v < 0.3) {
  cat("Weak Association\n")
} else if (cramers_v < 0.5) {
  cat("Moderate Association\n")
} else {
  cat("Strong Association\n")
}
```

```{r}
#| label: fig-markov-chain
#| fig-cap: "Markov Chain Transition Matrix: Visualizing the 'Persistence Effect' in Australian Rainfall."
#| fig-width: 8
#| fig-height: 7
#| echo: true
#| warning: false

markov_data <- df_final %>%
  group_by(location) %>%
  arrange(date) %>%
  mutate(yesterday_rain = lag(rain_today)) %>%
  ungroup() %>%
  filter(!is.na(rain_today), !is.na(yesterday_rain))

markov_data %>%
  count(yesterday_rain, rain_today) %>%
  group_by(yesterday_rain) %>%
  mutate(prob = n / sum(n)) %>%
  ggplot(aes(x = yesterday_rain, y = rain_today, fill = prob)) +
  geom_tile() +
  geom_text(
    aes(label = scales::percent(prob, accuracy = 1)),
    color = "white",
    size = 8,
    fontface = "bold"
  ) +
  scale_fill_viridis_c(option = "viridis", begin = 0.2, end = 0.8) +
  labs(
    title = "Markov Chain: Rain Persistence Effect",
    subtitle = sprintf(
      "X^2 = %.2f, p < 0.001, Cramer's V = %.3f (Moderate Association)\nYesterday's rain strongly predicts today's rain state.",
      chi_result$statistic,
      cramers_v
    ),
    x = "Did it Rain Yesterday?",
    y = "Did it Rain Today?",
    fill = "Probability"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, face = "bold")
  )
```

A natural question when analysing time-series weather data is whether consecutive days exhibit statistical dependence, in other words, does knowing whether it rained yesterday improve our prediction of whether it will rain today? We model this as a first-order Markov Chain, where the state space is binary (rain / no rain) and the transition probabilities are estimated directly from the data.

The Pearson Chi-squared test of independence yields $\chi^2 \approx 13,718$, $p < 0.001$, rejecting the null hypothesis of daily independence by a large margin. Cramer's V ($V \approx 0.31$) translates this to a moderate practical effect size, confirming that the relationship is not merely a consequence of the large sample.

The estimated transition matrix (@fig-markov-chain) reveals an important asymmetry between the two weather states. When the previous day was dry, there is an 85% probability of remaining dry the high-pressure systems that suppress rainfall are persistent and self-reinforcing. When the previous day was wet, however, there is only a 47% probability of continued rain, meaning rain events are more transient and less self-sustaining than dry spells. This asymmetry has a clear atmospheric interpretation: large anticyclonic systems that block rainfall can persist for days to weeks, while frontal systems that bring rain typically pass through more quickly.

The practical implication for modelling is that `rain_today` (lagged one day) carries meaningful predictive signal and should be considered as a candidate feature. However, its modest effect size also demonstrates that autocorrelation alone is insufficient as a predictor: the wet state is too transient for a persistence-only rule to be reliable, and other meteorological covariates are necessary to capture the onset and cessation of rainfall events.

### Dry Spell Dynamics and Temporal Decay [#sec-dry-spell]

```{r}
#| label: dry-spell-prep
#| echo: true
#| message: false
#| warning: false

dry_spell_data <- df_final %>%
  group_by(location) %>%
  arrange(date) %>%
  mutate(
    did_rain_yesterday = lag(rainfall > 0, default = FALSE),
    dry_spell_id = cumsum(did_rain_yesterday)
  ) %>%
  group_by(location, dry_spell_id) %>%
  mutate(days_since_rain = row_number()) %>%
  ungroup() %>%
  filter(days_since_rain <= 30) %>%
  mutate(rain_binary = as.numeric(rainfall > 0))
```

```{r}
#| label: dry-spell-model
#| echo: true
#| collapse: true

logit_model <- glm(
  rain_binary ~ days_since_rain,
  data = dry_spell_data,
  family = binomial(link = "logit")
)

wald_test <- aod::wald.test(
  b = coef(logit_model),
  Sigma = vcov(logit_model),
  Terms = 2
)

or_results <- tidy(logit_model, conf.int = TRUE, exponentiate = TRUE) %>%
  filter(term == "days_since_rain")

print(wald_test)
cat(sprintf(
  "\nFor each additional day without rain, odds of rainfall decrease by %.1f%%\n",
  (1 - or_results$estimate) * 100
))
cat(sprintf(
  "95%% CI: [%.3f, %.3f]\n",
  or_results$conf.low,
  or_results$conf.high
))
```

```{r}
#| label: dry-spell-spline
#| echo: true
#| collapse: true

logit_spline <- glm(
  rain_binary ~ splines::ns(days_since_rain, df = 4),
  data = dry_spell_data,
  family = binomial
)

lrt_result <- anova(logit_model, logit_spline, test = "LRT")
print(lrt_result)
```

```{r}
#| label: fig-dry-spell
#| fig-cap: "The 'Drying Effect': Empirical vs. Modeled Probability of Rainfall. The probability of rain decays exponentially as the dry spell lengthens."
#| fig-width: 9
#| fig-height: 7
#| echo: true
#| warning: false

pred_data <- data.frame(days_since_rain = 1:30)
pred_data$pred_prob <- predict(
  logit_model,
  newdata = pred_data,
  type = "response"
)
pred_data$pred_se <- predict(
  logit_model,
  newdata = pred_data,
  type = "response",
  se.fit = TRUE
)$se.fit

empirical_probs <- dry_spell_data %>%
  group_by(days_since_rain) %>%
  summarise(
    prob_rain = mean(rain_binary, na.rm = TRUE),
    n = n(),
    se = sqrt(prob_rain * (1 - prob_rain) / n)
  )

ggplot() +
  geom_ribbon(
    data = pred_data,
    aes(
      x = days_since_rain,
      ymin = pred_prob - 1.96 * pred_se,
      ymax = pred_prob + 1.96 * pred_se
    ),
    alpha = 0.2,
    fill = "firebrick"
  ) +
  geom_line(
    data = pred_data,
    aes(x = days_since_rain, y = pred_prob),
    color = "firebrick",
    size = 1.2,
    linetype = "dashed"
  ) +
  geom_pointrange(
    data = empirical_probs,
    aes(
      x = days_since_rain,
      y = prob_rain,
      ymin = prob_rain - 1.96 * se,
      ymax = prob_rain + 1.96 * se
    ),
    size = 0.5,
    color = "black"
  ) +
  scale_y_continuous(
    labels = scales::percent_format(1),
    breaks = pretty_breaks(n = 6)
  ) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    x = "Days Since Last Rain",
    y = "Probability of Rainfall",
    title = "Dry Spell Effect on Rain Probability",
    subtitle = sprintf(
      "Logistic Regression: B = %.4f, Wald χ2 = %.2f, p < 0.001\nEach additional dry day reduces odds of rain by %.1f%%",
      coef(logit_model)[2],
      wald_test$result$chi2[1],
      (1 - or_results$estimate) * 100
    ),
    caption = "Points: Empirical probabilities ± 95% CI | Line: Logistic model fit"
  ) +
  theme_minimal()
```

Beyond the day-to-day Markov persistence documented above, we investigate a longer-horizon question: does the *cumulative length* of an ongoing dry spell influence the probability of rain on any given day? This is framed as a survival-style problem in which the "event" is the return of rainfall after a period of absence.

A logistic regression of daily rain occurrence on `days_since_rain` yields a significant negative coefficient (Wald $\chi^2 \approx 8099$, $p < 0.001$), with an odds ratio of $OR = 0.835$. Concretely, each additional dry day reduces the odds of rainfall by approximately 16.5%. This is consistent with the feedback mechanism described in the Markov analysis: prolonged dry conditions are associated with the establishment of stable high-pressure ridges that become progressively more resistant to disruption by incoming frontal systems.

The linear logistic model is, however, an approximation. A Likelihood Ratio Test comparing it against a four-degree-of-freedom natural spline model is highly significant (LRT $\chi^2 \approx 7678$, $p < 0.001$), indicating meaningful non-linearity in the decay trajectory. Examining the empirical probabilities in @fig-dry-spell, the pattern is clear: rain probability falls sharply from approximately 48% on Day 1 to around 18% by Day 10, after which the decline slows considerably, plateauing in the 12–16% range through Days 15 to 30. The linear model underestimates the steepness of the initial decline and overestimates the rate of decline in long droughts.

This "rapid-then-gradual" decay pattern suggests that models incorporating dry spell duration as a predictor would benefit from a spline parameterisation of `days_since_rain` rather than a simple linear term.

---

## Atmospheric Pressure Dynamics

```{r}
#| label: pressure-prep-normality
#| echo: true
#| message: false
#| warning: false

pressure_data <- df_final %>%
  mutate(pressure_change = pressure3pm - pressure9am) %>%
  select(rain_today, pressure9am, pressure3pm, pressure_change) %>%
  filter(!is.na(pressure9am), !is.na(rain_today))

pressure_data %>%
  sample_n(5000) %>%
  pivot_longer(
    cols = c(pressure9am, pressure3pm, pressure_change),
    names_to = "metric",
    values_to = "value"
  ) %>%
  ggplot(aes(sample = value)) +
  stat_qq(alpha = 0.5) +
  stat_qq_line(color = "red") +
  facet_wrap(~metric, scales = "free") +
  labs(
    title = "Q-Q Plots: Checking Normality Assumption",
    subtitle = "Points should hug the red line. Slight deviations are acceptable due to large N (CLT)."
  ) +
  theme_minimal()
```

```{r}
#| label: pressure-stats
#| echo: true
#| message: false

test_data <- pressure_data %>%
  pivot_longer(
    cols = c(pressure9am, pressure3pm, pressure_change),
    names_to = "metric",
    values_to = "value"
  )

stats_results <- test_data %>%
  group_by(metric) %>%
  t_test(value ~ rain_today, var.equal = FALSE) %>%
  adjust_pvalue(method = "holm") %>%
  add_significance()

stats_results %>%
  select(metric, group1, group2, statistic, df, p.adj, p.adj.signif) %>%
  kable(
    caption = "Welch's Two Sample t-test Results (Bonferroni-Holm Corrected)",
    digits = 3,
    col.names = c(
      "Metric",
      "Group 1",
      "Group 2",
      "t-statistic",
      "df",
      "Adj. P-Value",
      "Significance"
    )
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r}
#| label: pressure-effect-size
#| echo: true
#| message: false

effect_sizes <- test_data %>%
  group_by(metric) %>%
  cohens_d(value ~ rain_today, var.equal = FALSE) %>%
  mutate(
    magnitude = case_when(
      abs(effsize) < 0.2 ~ "Negligible",
      abs(effsize) < 0.5 ~ "Small",
      abs(effsize) < 0.8 ~ "Medium",
      TRUE ~ "Large"
    )
  )

effect_sizes %>%
  select(metric, effsize, magnitude) %>%
  kable(
    caption = "Cohen's d Effect Size Analysis",
    digits = 3,
    col.names = c("Metric", "Effect Size (d)", "Interpretation")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r}
#| label: fig-pressure-violin
#| fig-cap: "Violin Plots of Atmospheric Pressure Variables by Rainfall State."
#| fig-width: 10
#| fig-height: 8
#| echo: true
#| warning: false

plot_annotations <- stats_results %>%
  left_join(effect_sizes, by = "metric") %>%
  mutate(
    label_text = sprintf(
      "p %s\nCohen's d = %.2f (%s)",
      p.adj.signif,
      effsize,
      magnitude
    ),
    y_pos = case_when(
      metric == "pressure9am" ~ 1045,
      metric == "pressure3pm" ~ 1040,
      metric == "pressure_change" ~ 15
    )
  )

ggplot(test_data, aes(rain_today, value, fill = rain_today)) +
  geom_violin(alpha = 0.6, trim = TRUE) +
  geom_boxplot(width = 0.2, outlier.shape = NA, alpha = 0.8, color = "black") +
  facet_wrap(~metric, scales = "free_y") +
  geom_text(
    data = plot_annotations,
    aes(x = 1.5, y = y_pos, label = label_text),
    inherit.aes = FALSE,
    vjust = 0,
    fontface = "italic",
    size = 3.5
  ) +
  scale_fill_manual(values = c("No" = "#B0B0B0", "Yes" = "#0072B2")) +
  labs(
    title = "Atmospheric Pressure vs. Rainfall",
    subtitle = "Statistical validation using Welch's t-test and Cohen's d effect size",
    y = "Pressure (hPa)",
    x = "Did it rain?"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 12, face = "bold")
  )
```

```{r}
#| label: fig-pressure-means
#| fig-cap: "Mean Pressure Levels and Diurnal Drop by Rainfall State."
#| fig-width: 10
#| fig-height: 6
#| echo: true
#| warning: false

data_wide <- df_final %>%
  group_by(rain_today) %>%
  summarise(
    `9:00 AM` = mean(pressure9am, na.rm = TRUE),
    `3:00 PM` = mean(pressure3pm, na.rm = TRUE),
    `Pressure Drop` = mean(pressure9am, na.rm = TRUE) -
      mean(pressure3pm, na.rm = TRUE)
  ) %>%
  pivot_longer(cols = -rain_today, names_to = "metric", values_to = "value") %>%
  mutate(
    metric = factor(metric, levels = c("9:00 AM", "3:00 PM", "Pressure Drop")),
    label_txt = round(value, 1)
  )

ggplot(data_wide, aes(x = rain_today, y = value, fill = rain_today)) +
  geom_col(width = 0.6, alpha = 0.9) +
  geom_text(aes(label = label_txt), vjust = -0.5, fontface = "bold", size = 4) +
  facet_wrap(~metric, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("No" = "#B0B0B0", "Yes" = "#0072B2")) +
  scale_x_discrete(labels = c("No" = "Dry Days", "Yes" = "Rainy Days")) +
  labs(
    title = "Rainy Days Exhibit Lower Baseline Pressure and Suppressed Diurnal Variation",
    subtitle = "Lower absolute pressure at 9am is the key distinguishing factor",
    y = "Pressure (hPa) / Drop (hPa)",
    x = NULL
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 12),
    axis.text.x = element_text(face = "bold", size = 11),
    strip.text = element_text(face = "bold", size = 12),
    panel.grid.major.x = element_blank()
  )
```

Atmospheric pressure is one of the most physically direct predictors of precipitation: low-pressure systems force air upward, promoting cooling, condensation, and rainfall, while high-pressure systems suppress this process. We analyse both the absolute pressure level and its diurnal change (morning to afternoon) as potential features.

**Normality.** The Q-Q plots show modest tail deviations from normality in the pressure variables, but with $N > 140,000$ observations the Central Limit Theorem ensures that sample means are approximately normally distributed regardless. Welch's t-test which does not assume equal variances is therefore valid here, and multiple comparison correction is applied via the Bonferroni-Holm procedure.

**Baseline pressure.** Rainy days are characterised by measurably lower mean pressure: 1015 hPa at 9:00 AM compared to 1018.5 hPa on dry days (@fig-pressure-means). Welch's t-test confirms the difference is highly significant ($p < 0.001$), with Cohen's $d \approx 0.28$–$0.48$ a small-to-medium effect that is consistent with the expectation that absolute pressure is necessary but not sufficient for rain.

**Diurnal pressure change.** The more distinctive signal lies in the *change* in pressure across the day. On dry days, pressure drops by a mean of 2.7 hPa from morning to afternoon the standard thermal low driven by daytime solar heating of the surface. On rainy days, this drop is suppressed to just 1.3 hPa, because cloud cover reduces insolation and limits surface warming. This suppression of the normal diurnal cycle is a subtler but remarkably informative signal: Cohen's $d = -0.72$ for `pressure_change` represents a medium effect size, stronger than either of the absolute pressure readings individually.

This finding suggests that the *rate of pressure change* during the day  not just its absolute level may be a more discriminating feature for modelling rainfall occurrence.

---

## Seasonal Rainfall Intensity

### Cyclical Patterns

```{r}
#| label: seasonality-prep
#| echo: true
#| message: false
#| warning: false

monthly_stats <- df_final %>%
  filter(rainfall > 0) %>%
  group_by(month) %>%
  summarise(
    median_rain = median(rainfall),
    mean_rain = mean(rainfall),
    rain_days = n(),
    .groups = "drop"
  ) %>%
  mutate(month_label = factor(month.abb[month], levels = rev(month.abb)))

plot_data <- df_final %>%
  filter(rainfall > 0) %>%
  mutate(
    month_label = factor(month.abb[month], levels = rev(month.abb)),
    log_rain = log(rainfall)
  ) %>%
  left_join(monthly_stats, by = c("month", "month_label"))
```

```{r}
#| label: fig-monthly-dist
#| fig-cap: "Ridgeline Plot of Monthly Log-Rainfall Distributions. Shifting peaks illustrate how rainfall intensity varies across the year relative to the global median (dashed line)."
#| fig-width: 10
#| fig-height: 8
#| echo: true
#| warning: false

ggplot(plot_data, aes(log_rain, month_label, fill = after_stat(x))) +
  geom_density_ridges_gradient(
    scale = 2.5,
    rel_min_height = 0.01,
    quantile_lines = TRUE,
    quantiles = 2,
    alpha = 0.8
  ) +
  geom_vline(
    xintercept = median(log(df_final$rainfall[df_final$rainfall > 0])),
    linetype = "dashed",
    color = "grey30",
    linewidth = 0.5
  ) +
  scale_fill_viridis_c(
    option = "mako",
    name = "Log\nRainfall",
    direction = -1
  ) +
  scale_x_continuous(breaks = pretty_breaks()) +
  labs(
    title = "Monthly Rainfall Distribution Patterns",
    subtitle = "Solid lines mark monthly medians vs. the Global Median (dashed).\nDistribution shape and centre shift cyclically relative to the global baseline.",
    x = "Rainfall Amount (mm, log scale)",
    y = NULL
  ) +
  theme_minimal(base_size = 13)
```

```{r}
#| label: fig-seasonal-facet
#| fig-cap: "Seasonal Rainfall Patterns by Meteorological Season. Summer months exhibit higher variance and intensity compared to Winter."
#| fig-width: 10
#| fig-height: 8
#| echo: true
#| warning: false

seasonal_data <- df_final %>%
  filter(rainfall > 0) %>%
  mutate(
    season = case_when(
      month %in% c(12, 1, 2) ~ "Summer",
      month %in% c(3, 4, 5) ~ "Autumn",
      month %in% c(6, 7, 8) ~ "Winter",
      month %in% c(9, 10, 11) ~ "Spring"
    ),
    season = factor(season, levels = c("Summer", "Autumn", "Winter", "Spring"))
  )

plot_data_seasonal <- seasonal_data %>%
  mutate(month_label = factor(month.abb[month], levels = month.abb))

ggplot(plot_data_seasonal, aes(rainfall, month_label, fill = season)) +
  geom_density_ridges(
    scale = 1.5,
    alpha = 0.7,
    quantile_lines = TRUE,
    quantiles = c(0.25, 0.5, 0.75)
  ) +
  scale_x_log10(
    breaks = c(1, 10, 50, 100, 300),
    labels = label_number(accuracy = 1)
  ) +
  scale_fill_manual(
    values = c(
      "Summer" = "#E69F00",
      "Autumn" = "#D55E00",
      "Winter" = "#0072B2",
      "Spring" = "#009E73"
    )
  ) +
  facet_wrap(~season, scales = "free_y", ncol = 2) +
  labs(
    title = "Seasonal Rainfall Patterns",
    subtitle = "Quartile lines show 25th, 50th, and 75th percentiles",
    x = "Rainfall Amount (mm, log scale)",
    y = NULL
  ) +
  theme_minimal(base_size = 12)
```

```{r}
#| label: fig-mean-rain-bar
#| fig-cap: "Average Rainfall Intensity (Non-Zero Days) by Month."
#| fig-width: 10
#| fig-height: 6
#| echo: true
#| warning: false

monthly_stats %>%
  mutate(month_label = factor(month.abb[month], levels = month.abb)) %>%
  ggplot(aes(month_label, mean_rain)) +
  geom_col(aes(fill = mean_rain, alpha = 0.8), width = 0.7) +
  geom_text(
    aes(label = round(mean_rain, 1)),
    vjust = -0.5,
    size = 3.5,
    fontface = "bold"
  ) +
  scale_fill_viridis_c(option = "mako", direction = -1) +
  labs(
    title = "Mean Rainfall by Month (Non-Zero Days)",
    subtitle = "Confirms seasonal variation justifying cyclical encoding",
    y = "Mean Rainfall (mm)",
    x = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold")
  )
```

The earlier analysis of monthly wet-day frequency @sec-frequency established *when* rain tends to occur. This section investigates a separate question: when rain does occur, does the season affect *how much falls*?

The ridgeline plots (@fig-monthly-dist) reveal a clear and cyclical pattern in rainfall intensity. January and February distributions are shifted systematically to the right of the global median, indicating that summer storms though they occur less frequently than winter fronts are considerably more intense when they do arrive. The distributions for June through August cluster to the left, representing lower but more consistent rainfall. The transition months (March–May and September–November) occupy an intermediate position that smoothly connects these two poles.

The seasonal breakdown (@fig-seasonal-facet) reveals an additional distinction in distributional *shape*. Summer rainfall has a wide interquartile range and a pronounced right tail extending beyond 100 mm per day, reflecting the episodic and convective nature of summer storms. Winter rainfall has a narrower, more peaked distribution: events are more predictable in magnitude but lighter on average. February records the highest mean intensity per wet day at 10.1 mm, nearly double July's 4.9 mm (@fig-mean-rain-bar).

Critically, this seasonal variation in intensity is *separate* from the seasonal variation in frequency. Both dimensions carry independent information: a model must account not only for the higher probability of rain in winter but also for the greater potential severity of rain in summer.

**Encoding implication.** Because the seasonal cycle is continuous the transition from December to January is climatologically smooth treating `Month` as an unordered categorical variable discards information about the ordering and proximity of months. The preferred approach is **cyclical encoding** via sine and cosine transformations of the month number, which preserves the circular geometry of the annual cycle and allows the model to represent the smooth intensification from winter trough to summer peak.

### Statistical Validation

```{r}
#| label: seasonal-descriptive-stats
#| echo: true
#| message: false

seasonal_stats <- seasonal_data %>%
  select(season, rainfall) %>%
  group_by(season) %>%
  get_summary_stats(rainfall, type = "mean_sd")

seasonal_stats %>%
  kable(
    caption = "Descriptive Statistics of Rainfall Intensity by Season",
    col.names = c("Season", "Variable", "N (Events)", "Mean (mm)", "SD (mm)")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r}
#| label: kruskal-wallis-test
#| echo: true
#| message: false

kw_result <- kruskal_test(rainfall ~ season, data = seasonal_data)
epsilon_sq <- kruskal_effsize(rainfall ~ season, data = seasonal_data)

tibble(
  Test = "Kruskal-Wallis Rank Sum Test",
  `Chi-squared` = kw_result$statistic,
  df = kw_result$df,
  `P-value` = kw_result$p,
  `Effect Size` = epsilon_sq$effsize,
  Magnitude = as.character(epsilon_sq$magnitude)
) %>%
  mutate(
    `Chi-squared` = round(`Chi-squared`, 2),
    `Effect Size` = round(`Effect Size`, 4),
    `P-value` = scales::pvalue(`P-value`, accuracy = 0.001)
  ) %>%
  kable(
    caption = "Statistical Significance of Seasonal Differences (Non-Parametric)",
    align = "lccccr"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "left"
  ) %>%
  add_footnote(
    c(
      "Effect size measured by Epsilon-squared.",
      "Significance level: alpha = 0.05"
    ),
    notation = "symbol"
  )
```

```{r}
#| label: dunns-test
#| echo: true
#| message: false

dunn_result <- dunn_test(
  rainfall ~ season,
  data = seasonal_data,
  p.adjust.method = "bonferroni"
)

dunn_result %>%
  select(group1, group2, statistic, p.adj, p.adj.signif) %>%
  kable(
    caption = "Dunn's Pairwise Comparison Test (Bonferroni Corrected)",
    col.names = c(
      "Group 1",
      "Group 2",
      "Z-Statistic",
      "Adj. P-Value",
      "Significance"
    )
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r}
#| label: fig-seasonal-stat-groups
#| fig-cap: "Mean Seasonal Rainfall with Statistical Groupings. Shared letters indicate seasons that are not significantly different from one another (Dunn's test, p < 0.05)."
#| fig-width: 10
#| fig-height: 8
#| echo: true
#| warning: false

p_vals <- dunn_result$p.adj
names(p_vals) <- paste(dunn_result$group1, dunn_result$group2, sep = "-")
letters_vec <- multcompLetters(p_vals)$Letters

letters_df <- data.frame(season = names(letters_vec), Letter = letters_vec)

plot_data <- seasonal_data %>%
  group_by(season) %>%
  summarise(mean_rain = mean(rainfall, na.rm = TRUE), n = n()) %>%
  left_join(letters_df, by = "season")

ggplot(plot_data, aes(x = season, y = mean_rain, fill = season)) +
  geom_col(alpha = 0.8, width = 0.7) +
  geom_text(aes(label = Letter), vjust = -0.5, size = 8, fontface = "bold") +
  geom_text(
    aes(label = round(mean_rain, 1)),
    vjust = 1.5,
    color = "white",
    fontface = "bold",
    size = 5
  ) +
  scale_fill_manual(
    values = c(
      "Summer" = "#E69F00",
      "Autumn" = "#D55E00",
      "Winter" = "#0072B2",
      "Spring" = "#009E73"
    )
  ) +
  labs(
    title = "Seasonal Rainfall with Statistical Groupings",
    subtitle = sprintf(
      "Kruskal-Wallis: p < 0.001, Effect Size: %s\nSeasons sharing a letter are not significantly different.",
      as.character(epsilon_sq$magnitude)
    ),
    y = "Mean Rainfall (mm)",
    x = NULL
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 16),
    axis.text.x = element_text(size = 12, face = "bold"),
    panel.grid.major.x = element_blank()
  )
```

To move beyond visual inspection, we apply the Kruskal-Wallis test the non-parametric counterpart to one-way ANOVA, appropriate here because the rainfall distribution is far from normal. The null hypothesis is that the four seasons are drawn from the same underlying distribution of rainfall intensity.

The test yields $\chi^2 = 230$, $p < 0.001$, strongly rejecting the null. The epsilon-squared effect size ($\eta^2 \approx 0.004$), however, is classified as small. This warrants careful interpretation: the seasonal signal is real and not a sampling artefact, but season alone accounts for only a minor fraction of the total variance in rainfall intensity. Location, pressure regime, and other meteorological covariates contribute substantially to the remaining variance, an observation that reinforces the necessity of a multivariate modelling approach.

Post-hoc pairwise comparisons via Dunn's test with Bonferroni correction identify three distinct statistical groups (@fig-seasonal-stat-groups). Summer stands alone as the most intense season ($\bar{x} = 9.1$ mm, significantly different from all others, $p < 0.001$). Autumn and Spring are statistically indistinguishable from each other ($p = 1.0$), forming a middle group of transitional intensity. Winter registers the lowest mean intensity ($\bar{x} = 5.5$ mm) and, while visually similar to Spring, is statistically distinct from it ($p_{\text{adj}} = 0.026$).

---

## Feature Interactions: The "Rain Corner" {#sec-bivariate-density}

```{r}
#| label: fig-interaction-rain-corner
#| fig-cap: "Bivariate Density of Humidity vs. Sunshine, faceted by Rainfall Occurrence. Rain events concentrate tightly in the upper-left 'Rain Corner', justifying a multiplicative interaction term."
#| fig-width: 10
#| fig-height: 8
#| echo: true
#| warning: false

df_final %>%
  group_by(location) %>%
  arrange(date) %>%
  mutate(
    rain_index_ref = ifelse(rainfall > 0, row_number(), NA_integer_)
  ) %>%
  fill(rain_index_ref, .direction = "down") %>%
  mutate(
    days_since_rain = row_number() - lag(rain_index_ref)
  ) %>%
  select(-rain_index_ref) %>%
  ggplot(aes(sunshine, humidity3pm)) +
  geom_density2d_filled(continuous_var = "ndensity", bins = 7) +
  facet_wrap(~rain_today, labeller = label_both) +
  scale_fill_brewer(palette = "Blues") +
  labs(
    title = "Justifying Interaction: The 'Rain Corner'",
    subtitle = "Rain (Right) concentrates in High Humidity/Low Sun, while No Rain (Left) is spread out.\nThis structural difference justifies a 'Sunshine * Humidity' interaction feature.",
    x = "Sunshine (hours)",
    y = "Humidity 3pm (%)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold")
  )
```

The correlation analysis in @sec-correlation established that humidity and sunshine are individually among the strongest predictors of rainfall. A standard additive model would treat their effects as independent meaning the influence of humidity on rainfall probability does not depend on how much sunshine has occurred, and vice versa. This section tests whether that independence assumption is justified.

To do so, we examine the joint distribution of `Humidity3pm` and `Sunshine`, separately for days on which rain did and did not occur. If the two variables act independently, the joint distributions for the two weather states should be geometrically similar shifted, perhaps, but with the same basic shape. If they interact, the shapes will differ fundamentally.

The bivariate density plots (@fig-interaction-rain-corner) reveal a striking structural difference. On dry days, the density is dispersed broadly across the humidity-sunshine space: it is possible to observe high humidity without rain (if other conditions, such as elevated pressure, suppress precipitation) and it is possible to have low sunshine without rain. There is no single region of feature space that cleanly separates dry from wet conditions based on these two variables alone.

On rainy days, the picture is qualitatively different. The density collapses into a tight, concentrated cluster in the upper-left quadrant: high afternoon humidity (above approximately 50%) combined with low sunshine (below approximately 5 hours). This region which we call the **"Rain Corner"** captures the simultaneous presence of atmospheric moisture and the absence of solar conditions that would otherwise inhibit precipitation.

The physical interpretation is intuitive: neither high humidity alone nor low sunshine alone is sufficient to produce rain. Both conditions must coincide. This is the definition of statistical interaction: the effect of one variable on the outcome is conditional on the level of another.

**Modelling implication.** An additive model that includes `Humidity3pm` and `Sunshine` as separate terms will fail to recover this corner structure because it cannot represent the idea that their joint occurrence, rather than their individual magnitudes, is what matters. Capturing this behaviour requires a multiplicative interaction term ($\text{Humidity} \times \text{Sunshine}$) in the model specification, allowing the model to assign elevated probability to the "Rain Corner" region while leaving other areas of feature space relatively unaffected.

---

## Summary and Modelling Implications

The preceding analyses characterise the Australian rainfall dataset along several interconnected dimensions. Taken together, they point toward a specific set of modelling requirements.

The **distributional structure** of the target variable 64% zeros, extreme positive skew, and kurtosis of 181 rules out any single-component Gaussian model. A two-part framework (Hurdle or Zero-Inflated Gamma) that separately models the occurrence and the intensity of rainfall is the appropriate response to this structure.

The **missingness analysis** establishes that imputation, rather than deletion, is necessary to preserve both sample size and the predictive signal contained in `sunshine` and `evaporation`. Random Forest imputation is well-suited to this task because it can exploit correlations among the observed variables to generate principled estimates for missing ones.

The **correlation structure** identifies humidity, cloud cover, sunshine, and evaporation as the strongest individual predictors, while also flagging severe multicollinearity among the morning-afternoon pairs of pressure and temperature readings. VIF-based feature selection is required to address this.

The **temporal analyses** establish that both the day-to-day Markov state and the cumulative dry spell duration carry meaningful predictive signal, though neither is sufficient on its own. Month should be cyclically encoded to preserve the circular geometry of the seasonal cycle.

The **pressure analysis** identifies the diurnal pressure change not merely the absolute pressure level as the most discriminating pressure-derived feature, with a medium Cohen's $d$ of 0.72 separating rainy from dry days.

Finally, the **interaction analysis** provides empirical justification for including a $\text{Humidity} \times \text{Sunshine}$ interaction term, reflecting the physical reality that precipitation is most likely when high moisture and low solar radiation coincide simultaneously.